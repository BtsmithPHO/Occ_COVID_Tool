---
title: "Occupational Risk COVID-19"
runtime: shiny

output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    theme: cosmo
---
<style type="text/css">
body{
  font-family: Arial;
  font-size: 12pt;
  text-align: left;
}
h1{
  font-family: Arial;
  font-size: 10pt;
}

h2,h3,h4,h5,h6{
  font-family: Arial;
  font-size: 16pt;
}

.navbar-inverse {
  background-color: #0F80A7;
      font-family: Arial;
    font-size: 16pt;
}
.navbar-inverse .navbar-brand {
  color: white;
      font-family: Arial;
    font-size: 14pt;
}
.navbar-inverse .navbar-nav>li>a {
  color: white;
    font-family: Arial;
    font-size: 14pt;

}
.navbar-inverse .navbar-nav>.active>a {
  background-color: #E7F2F6;
      font-family: Arial;
    font-size: 14pt;
}
.list-group-item.active {
  background-color: #E7F2F6;
  border-color:none;
    font-color: #0F80A7;
      padding: 5px 5px;
  margin: 5px 5px;
      font-family: Arial;
    font-size: 14pt;
}
item.active, .list-group-item.active:hover{
  background-color: #E7F2F6;
  border-color: none;
  <!-- padding: 5px 5px; -->
  <!-- margin: 5px 5px; -->
      font-family: Arial;
    font-size: 14pt;
    font-color: #0F80A7;
    text-decoration: underline;
}
.navbar-inverse .navbar-nav > li.active > a,
.navbar-inverse .navbar-nav > li.active > a:hover,
.navbar-inverse .navbar-nav > li.active > a:focus{
font-color: #0F80A7;
  background-color: #E7F2F6;
  border-color: none;
  <!-- padding: 5px 5px; -->
      font-family: Arial;
    font-size: 14pt;
        font-color: #0F80A7;
    text-decoration: underline;
}
.navbar-inverse .navbar-toggle:a,
.navbar-inverse .navbar-toggle:hover,
.navbar-inverse .navbar-toggle:focus {
  
  background-color: #E7F2F6;
  border-color: none;
  <!-- padding: 5px 5px; -->
  <!-- margin: 5px 5px; -->
      font-family: Arial;
    font-size: 14pt;
    font-color: #0F80A7;
    text-decoration: underline;
}

.nav-tabs-custom .nav-tabs li.active a {
  color:#0F80A7 ;
  font-family: Arial;
  font-size: 14pt;
}

.nav-tabs-custom .nav-tabs li:not(.active) a {
  color:grey;
    font-family: Arial;
  font-size: 14pt;
}

.navbar-nav li a:hover, .navbar-nav > .active > a {
  color: #0F80A7 !important;
  background-color: white !important;
  background-image: none !important;

}
.dropdown-toggle li a {
  color: #0F80A7 !important;
  background-color: white !important;
  background-image: none !important;
}

.hovertext text {
    font-family: Arial;
    font-size: 12pt;
  
}
.legendtext {
    font-family: Arial;
    font-size: 12pt;
}
.mainbody{
    position: relative;
    height: 100%;
    width: 100%;
}
.tabset text {
    font-family: Arial;
    font-size: 14pt;
}

.section.sidebar {
 background-color: #E7F2F6;
 color: black;
 font-family: Arial;
 font-size: 12pt;
 
}

.scrolling-wrapper{
  height=100%;
  position:relative;
  overflow-x=scroll;
  overflow-y=scroll;
  white-space: nowrap;
}

.wrapper{
  height=100%;
  position:relative;
  overflow-x=scroll;
  overflow-y=scroll;
  white-space: nowrap;
}

.chart-wrapper { overflow-x: scroll; }
.shiny-output-error { visibility: hidden; }
.shiny-output-error:before { visibility: hidden; }

</style>
```{r setup, results=FALSE, include=FALSE}
library(sf)
library(shinyjs)
library(DT)
library(ggplot2)
library(plotly)
library(tidyr)
library(Hmisc)
library(flexdashboard)
library(shinyWidgets)
library(dplyr)
library(scales)
library(tidyverse)
library(crosstalk)
library(shinydashboard)
library(shinybusy)
rm(list=ls())

## load regional data only on prompt
## add regional variable boolean variable (if T then do not load and if F then load)
## can do same for provincial data
## create smaller dataset for user inputs


# table1_table2_datatool <- readRDS("table1_table2_final.rds")
# table3_datatool <- readRDS("table3_final.rds")

# table1_table2_datatool_total <- subset(table1_table2_datatool, table1_table2_datatool$sex == 'Total' & table1_table2_datatool$age =='Total')

# table3_datatool$median_income_plot <- ifelse(table3_datatool$median_income > 150000, 150000,table3_datatool$median_income) 
# table3_datatool_total<- subset(table3_datatool, sex == 'Total' & age =='Total')




regions_input <- readRDS("regions_input.rds")
table1_table2_datatool <-  readRDS("table1_table2_final.rds")
#########################
## SOME DATA MANIPULATION
#########################

sector_y <-
  scale_y_discrete(
   limits = c(
      "Management",
      "Business",
      "Sciences",
      "Health",
      "Community",
      "Culture",
      "Sales",
      "Trades",
      "Agriculture",
      "Utilities"),
    labels = c(
      "Management",
      "Business",
      "Sciences",
      "Health",
      "Community",
      "Culture",
      "Sales",
      "Trades",
      "Agriculture",
      "Utilities"
    )
  )
sector_x <-
  scale_x_discrete(
    limits = c(
      "Management",
      "Business",
      "Sciences",
      "Health",
      "Community",
      "Culture",
      "Sales",
      "Trades",
      "Agriculture",
      "Utilities"),
    labels = c(
      "Management",
      "Business",
      "Sciences",
      "Health",
      "Community",
      "Culture",
      "Sales",
      "Trades",
      "Agriculture",
      "Utilities"
    )
  )



phys_prox_y <- scale_y_continuous(breaks=seq(0,100, by=25), labels=c("Not Near People","Not Close","Slightly Close","Arm's Length","Touching"), limits=c(0,100))
phys_prox_x <- scale_x_continuous(breaks=seq(0,100, by=25), labels=c("Not Near People","Not Close","Slightly Close","Arm's Length","Touching"), limits=c(0,100))
exposure_y <- scale_y_continuous(breaks=seq(0,100, by=25), labels=c("Never","Yearly","Monthly","Weekly","Daily"), limits=c(0,100))
exposure_x <- scale_x_continuous(breaks=seq(0,100, by=25), labels=c("Never","Yearly","Monthly","Weekly","Daily"), limits=c(0,100))

indoors_not_controlled_y <- scale_y_continuous(breaks=seq(0,100, by=25), labels=c("Never","Yearly","Monthly","Weekly","Daily"), limits=c(0,100))
indoors_not_controlled_x <- scale_x_continuous(breaks=seq(0,100, by=25), labels=c("Never","Yearly","Monthly","Weekly","Daily"), limits=c(0,100))

indoors_controlled_y <- scale_y_continuous(breaks=seq(0,100, by=25), labels=c("Never","Yearly","Monthly","Weekly","Daily"), limits=c(0,100))
indoors_controlled_x <- scale_x_continuous(breaks=seq(0,100, by=25), labels=c("Never","Yearly","Monthly","Weekly","Daily"), limits=c(0,100))

median_inc_y <- scale_y_continuous(breaks=seq(0,150000, by=25000), limits=c(0,150000), labels=c("$0","$25,000", "$50,000","$75,000","$100,000","$125,000","> $150,000"))
median_inc_x <- scale_x_continuous(breaks=seq(0,150000, by=25000), limits=c(0,150000), labels=c("$0","$25,000", "$50,000","$75,000","$100,000","$125,000","> $150,000"))
contact_others_y<-scale_y_continuous(breaks=seq(0,100, by=25), labels=c("None","Occasional","Half Time","Most Time","Constant"), limits=c(0,100))
contact_others_x<-scale_x_continuous(breaks=seq(0,100, by=25), labels=c("None","Occasional","Half Time","Most Time","Constant"), limits=c(0,100))
public_y <- scale_y_continuous(breaks=seq(0,100, by=25), labels=c("Not Important","Somewhat Important","Important","Very Important","Extremely Important"), limits=c(0,100))
public_x <- scale_x_continuous(breaks=seq(0,100, by=25),labels=c("Not Important","Somewhat Important","Important","Very Important","Extremely Important"),limits=c(0,100))
# computer_y <- scale_y_continuous(breaks=seq(0,100, by=25),limits=c(0,100))
# computer_x <- scale_x_continuous(breaks=seq(0,100, by=25),limits=c(0,100))

xaxis_options <-c("Exposure to Disease"="exposure","Physical Proximity to Others"="phys_prox","Contact with Others"="contact_others",  "Interacting with Public"="public_importance", "Indoors, Controlled"="indoors_controlled","Indoors, Not Controlled"="indoors_not_controlled","Median Income"="median_income_plot","Broad Occupation"="noc_broad_descript")

yaxis_options <-c("Exposure to Disease"="exposure","Physical Proximity to Others"="phys_prox","Contact with Others"="contact_others", "Interacting with Public"="public_importance", "Indoors, Controlled"="indoors_controlled","Indoors, Not Controlled"="indoors_not_controlled","Median Income"="median_income_plot","Broad Occupation"="noc_broad_descript")

```

About{.tabset}
====================
Column2{.tabset}
----
### Overview{data-height=800}
```{r}
fluidPage(column(8,

p(size=14,"The", tags$b("Occupational Exposure to COVID-19 Risk Tool"), "is an open source interactive data visualization platform designed to explore the burden of exposure to COVID-19 risk in Canadian workers, and, to inform the design of equitable policy and intervention strategies to mitigate inequities in occupational exposure to COVID-19 risk."),
                  
p(size=14,"The Tool was developed by a collaborative research team with investigators from", tags$b("Public Health Ontario (PHO), Institute for Work and Health, University of Toronto and University of Alberta.")),

p(size=14,tags$b("The Tool links data from the 2016 Canadian Census to occupational measures from Occupational Informational Network (O*NET), including information on:"), 
tags$ul(
tags$li("18.3 million part-time and full-time workers age 15 and over according to occupation and industry (2016 Census)."), 

tags$li("Work conditions with high risk of exposure to COVID-19 for each occupation, including: physical proximity to others, exposure to disease and infection, contact with others, ability to telework, public interaction and indoors exposure to controlled or uncontrolled environments (O*NET)."),

tags$li("Social inequities and intersectionality of occupational exposure to COVID-19 risk across equity stratifiers (e.g., age, sex, Race/Ethnicity, immigrant status and household income)."),

tags$li("Important policy stratifiers, including essential services, and geographies (province and health regions)."))),

p(size=14,"Please refer to the",tags$b(tags$a(href="https://www.dropbox.com/s/swxchgq15hwppjh/Occupation-covid-19-data-tool-technical-notes-January-13-2021.pdf?dl=0","Technical Notes",target="_blank")), "(last updated: Jan 13, 2021) for a full description of the Tool, data sources and access, and its use. The Tool’s datasets and code repository can be downloaded", tags$b(tags$a(href="https://github.com/BtsmithPHO/Occ_COVID_Tool","here.",target="_blank")),"French translation is available upon request."),

br(),
img(src='PHO_logo.jpg',
    height="30%", width="50%")
))


style="overflow-y: scroll;overflow-x: scroll;overflow: scroll;"
```

### Data Notes{data-height=300}
```{r}
fluidPage(column(8,
                 
p(size=14,"1) Risk of exposure to COVID-19 at work is measured based on typical job characteristics and activities within occupations from occupation data. Therefore, ‘exposure to COVID-19 risk’ is not a measure of frequency or association based on COVID-19 cases or COVID-19 transmission."),

p(size=14,"2) Workplace exposure measures were assessed prior to the COVID-19 pandemic and do not account for changes in the nature or availability of work directly impacted by the COVID-19 pandemic and/or mitigating strategies to reduce COVID-19 transmission instituted at the workplace level (e.g. working from home, additional infection control procedures, or provisions and use of adequate personal protective equipment).")

                 
))       
style="overflow-y: scroll;overflow-x: scroll;overflow: scroll;"     
                
```

### How to Use{data-height=300}
```{r}
fluidPage(column(8,
#h3(tags$b("How to use the tool")),
p(size=14,
  
  tags$ul(tags$li("There are",tags$b("5 pages"), "listed across the top blue border of the tool that enable users to examine occupational exposure to COVID-19 risk overall as well as by equity stratifiers."),
tags$br(),
tags$li("On the", tags$b("Occupations page"),", there are two tabs: 1) plot, and 2) table. The", tags$b("plot"), "enables users to plot measures of occupational exposure to COVID-19 risk at both the Provincial/Territorial and health region level. Using the interactive sliders, occupations of interest can be visually identified as shaded based on the proportion of populations at risk, either individually or in combination. This information is also accessible in a",tags$b("searchable table"),"view, either by sorting by row of interest or word searching to find a specific occupation."),
tags$br(),
tags$li("The following", tags$b("3 pages"), "of the tool provide occupational exposure to COVID-19 risk by", tags$b("equity stratifiers."), tags$b("The equity stratifiers page"), "stratifies work characteristics at high risk of COVID-19 exposure according to age, sex Race/Ethnicity and immigrant status at the Provincial/Territorial and health region level.", tags$b("The Race/Ethnicity and Income pages"), "further categorize work characteristics at high risk of COVID-19 exposure according to more specific categories. In these two pages, data restrictions only allow for reporting to the Provincial/Territorial level."),
tags$br(),
tags$li(tags$b("The comparisons page"), "provides a flexible method to compare work conditions with high-risk of exposure to COVID-19 across occupations, reflected by the bubble graph and corresponding tables. In addition, The proportion of workers at high-risk of occupational exposure to COVID-19 across equity statifiers can be compared and visualized through a bar chart.")
))

))
  


style="overflow-y: scroll;overflow-x: scroll;overflow: scroll;"
```

### Contact Information & Suggested Citation{data-height=300}
```{r}
fluidPage(column(10,

                 p(size=14,tags$b("Please direct any clarification questions to:"),
                  tags$ul(
tags$li("PHO Communications <PHO.Communications@oahpp.ca>"))),
                 
                 p(size=14,tags$b("Specific data requests can be directed to:"),
                   tags$ul(
tags$li("Brendan Smith <Brendan.Smith@oahpp.ca>"))), 

tags$br(),
 p(size=14,tags$b("Suggested citation:"), "Ontario Agency for Health Protection and Promotion (Public Health Ontario). Occupational exposure to COVID-19 risk: about [Internet]. Toronto, ON: Queen’s Printer for Ontario; 2020 [cited YYYY Mon DD]. Available from: https://oahpp.shinyapps.io/Occup_Covid19_App")
))
         
  
style="overflow-y: scroll;overflow-x: scroll;overflow: scroll;"        
```

Occupations
====================
Column1{.sidebar}
----
```{r, echo=FALSE}
useShinyjs(rmd=T)

radioButtons("hr_question", label=strong("Level of Geography"),
             choices=c("Provincial"=2,"Regional"=1),
             selected=2)

conditionalPanel(
  condition = "input.hr_question == 2 ||input.hr_question == 1",
  selectInput("geog",label=strong("Province/Territory"),
              choices=as.list(unique(regions_input$geography)),
              selected="Ontario"))
 
 

conditionalPanel(
  condition = "input.hr_question == 1",
  conditionalPanel(
    condition = "input.geog == 'Ontario'",
    selectInput("on",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Ontario")$health_region)),
                selected="Toronto Public Health"))
)
conditionalPanel(
  condition = "input.hr_question == 1",
conditionalPanel(
  condition = "input.geog == 'British Columbia'",
     selectInput("bc",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="British Columbia")$health_region)),
                selected=1)
  ))
conditionalPanel(
  condition = "input.hr_question == 1",
conditionalPanel(
  condition = "input.geog == 'Alberta'",
    selectInput("ab",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Alberta")$health_region)),
                selected=1)
))
conditionalPanel(
  condition = "input.hr_question == 1",
conditionalPanel(
  condition = "input.geog == 'Quebec'",
    selectInput("qb",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Quebec")$health_region)),
                selected=1)
))
conditionalPanel(
  condition = "input.hr_question == 1",
conditionalPanel(
  condition = "input.geog == 'Newfoundland and Labrador'",
    selectInput("nl",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Newfoundland and Labrador")$health_region)),
                selected=1)
))
conditionalPanel(
  condition = "input.hr_question == 1",
conditionalPanel(
  condition = "input.geog == 'Nova Scotia'",
    selectInput("ns",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Nova Scotia")$health_region)),
                selected=1)
))
conditionalPanel(
  condition = "input.hr_question == 1",
conditionalPanel(
  condition = "input.geog == 'New Brunswick'",
    selectInput("nb",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="New Brunswick")$health_region)),
                selected=1)
))
conditionalPanel(
  condition = "input.hr_question == 1",
conditionalPanel(
  condition = "input.geog == 'Prince Edward Island'",
    selectInput("pei",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Prince Edward Island")$health_region)),
                selected=1)
))
conditionalPanel(
  condition = "input.hr_question == 1",
conditionalPanel(
  condition = "input.geog == 'Saskatchewan'",
    selectInput("sk",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Saskatchewan")$health_region)),
                selected=1)
))
conditionalPanel(
  condition = "input.hr_question == 1",
conditionalPanel(
  condition = "input.geog == 'Manitoba'",
    selectInput("mb",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Manitoba")$health_region)),
                selected=1)
))
conditionalPanel(
  condition = "input.hr_question == 1",
conditionalPanel(
  condition = "input.geog == 'Nunavut'",
    selectInput("nu",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Nunavut")$health_region)),
                selected=1)
))
conditionalPanel(
  condition = "input.hr_question == 1",
conditionalPanel(
  condition = "input.geog == 'Northwest Territories'",
    selectInput("nt",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Northwest Territories")$health_region)),
                selected=1)
  ))
conditionalPanel(
  condition = "input.hr_question == 1",
conditionalPanel(
  condition = "input.geog == 'Yukon'",
    selectInput("yt",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Yukon")$health_region)),
                selected=1)
  ))


radioButtons(inputId="restrict",label=strong("Workforce"),
             choices=c("Total","Essential","Non-essential"),
             selected="Total")

selectInput("naics_sector",label=strong("Select Industry Sector"),
            choices=c("Total Sectors",
                      "Agriculture, forestry, fishing and hunting",
                      "Mining, quarrying, and oil and gas extraction",
                      "Utilities",
                      "Construction",
                      "Manufacturing",
                      "Wholesale trade",
                      "Retail trade",
                      "Transportation and warehousing",
                      "Information and cultural industries",
                      "Finance and insurance",
                      "Real estate and rental and leasing",
                      "Professional, scientific and technical services",
                      "Management of companies and enterprises",
                      "Administrative and support, waste management and remediation services",
                      "Educational services",
                      "Health care and social assistance",
                      "Arts, entertainment and recreation",
                      "Accommodation and food services",
                      "Other services (except public administration)",
                      "Public administration"),
            selected="Total Sectors")

selectInput("slider",label=strong("Choose Equity Stratifier"),
            choices=c("Race/Ethnicity",
                      # "Income Quintile 1",
                      "Immigrant Status",
                      "Female",
                      "65+ years",
                      "Median Income",
                      "All")
)

conditionalPanel(
  condition = "input.slider == 'Race/Ethnicity' || input.slider == 'All'",
  sliderInput(inputId="vismin", label=strong("Visible Minority Status (%)"), min=0, max=100, value=c(0,100)))

# conditionalPanel(
#  condition = "input.slider == 2 || input.slider == 'All'",
#  sliderInput(inputId="lowinc", label=strong("Income Quintile 1 (%)"), min=0, max=100, value=c(0,20)))

conditionalPanel(
  condition = "input.slider == 'Immigrant Status' || input.slider == 'All'",   
  sliderInput(inputId="immigrant", label=strong("Immigrant Status (%)"), min=0, max=100, value=c(0,100)))

conditionalPanel(
  condition = "input.slider == 'Female' || input.slider == 'All'",       
  sliderInput(inputId="female", label=strong("Female (%)"), min=0, max=100, value=c(0,100)))

conditionalPanel(
  condition = "input.slider == '65+ years' || input.slider == 'All'",           
  sliderInput(inputId="ageold", label=strong("65+ years (%)"), min=0, max=100, value=c(0,100)))

conditionalPanel(
  condition = "input.slider == 'Median Income' || input.slider == 'All'",           
  sliderInput(inputId="med_inc", label=strong("Median Income (CAD)"), min=0, max=315000, value=c(0,315000), step=10000))
hr()
 

```


Column2{.tabset}
---


### Plot {data-height=1800}
```{r}
fillPage(
  useShinyjs(rmd = T),
  add_busy_bar(color = "blue", height = "8px"),
    fluidRow(column(
    12,
    h3(
      "Work Conditions With High-Risk of Exposure to COVID-19 by Occupation"
    )
  )),
  hr(),
  fluidRow(column(11,  
      tags$ul(
        tags$li(
          "This tab is intended to visualize how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 at the Provincial/Territorial and health region level."
        ),
       # # br(),
       #  tags$li(
       #    "This information can be filtered according to essential services and worker socio-demographics to explore the relationship between work conditions and higher risk of exposure to COVID-19 at work."
       #  ),
       # # # br(),
        tags$li(
          "Occupation summaries can be found by hovering over bubbles in the figure or using the search box in the table view."
        ),
       # # br(),
        tags$li(
          "Each bubble represents an occupation and is proportional in size to the number of workers in that occupation."
        )
      )
    )),

  fluidRow(column(12, (
    actionButton("help_button", "Click for definitions of occupational measures from ONET")
  ))),
  
  shinyjs::hidden(fluidRow(
    id = 'help_info',
    column(
      11,
  
     (tags$b("Work Conditions with High Risk of Exposure to COVID-19 measured in the Occupational Informational Network (O*NET)")),
p(size=14,"Data on workers from the 2016 Census was linked to measures of how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 from O*NET"),
tags$b("Measures represent a weighted average score ranging from 0 to 100"),
tags$ul(
tags$li("Contact with others: How much does this job require the worker to be in contact with others in order to perform it?"),
  tags$ul(
 tags$li("no contact (0); occasional (25); half the time (50); most of the time (75); constant (100)")),

tags$li("Physical proximity: To what extent does this job require the worker to perform tasks in close physical proximity to others?"),
  tags$ul(
 tags$li("do not work near people (0); work with others, but not closely (25); slightly close, e.g., shared office (50); moderately close, e.g., arm’s length (75); very close, e.g., near touching (100)")),

tags$li("Exposure to disease or infection: How often does this job require exposure to disease/infections?"),
  tags$ul(
 tags$li("never exposed (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Interacting with the public: How important is performing for or working directly with the public to the performance of your current job?"),
  tags$ul(
 tags$li("not important (0), somewhat important (25), important (50), very important (75), extremely important (100)")),

tags$li("Indoors, Controlled environment: How often does this job require working indoors in environmentally controlled conditions?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Indoors, Uncontrolled environment: How often does this job require working indoors in non-controlled environmental conditions (e.g., warehouse without heat)?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)"))
)))
  ),
  
  
  fluidRow(column(12,
                  hr())),
 
  
  
  fluidRow(
    column(8, div(style = "height:500px;", plotlyOutput("occ_exp_plot")))
    ,
    
    column(
      align = "left",
      4,
      selectInput(
        "xaxis",
        label = strong("Occupational Measures: X-axis"),
        xaxis_options
        ,
        selected = "phys_prox"
      ),
      selectInput(
        "yaxis",
        label = strong("Occupational Measures: Y-axis"),
        yaxis_options
        ,
        selected = "exposure"
      ),
      checkboxGroupInput(
        "telework_plot",
        label = strong("Can work from home"),
        choices=c("Yes"=1,
                  "No"=0)
        ,
        selected = c(1,0)
      )
    )
  ),
  
  fluidRow(column(10,offset = 1,tags$h1("Data from the Canadian Census (2016) mapped to Occupational Informational Network (O*NET)"))),
  
  hr(),
  fixedRow(column(2,
                  tags$div(
                    tags$strong('Province/Territory:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("province_text")), noWS = "before"
                  ))),
  conditionalPanel(condition = "input.hr_question == 1",
                   fluidRow(
                     column(2,
                            tags$div(
                              tags$strong('Health Region:', .noWS = "after")
                            )),
                     column(6,
                            tags$div((
                              textOutput("region_text")
                            ), noWS = "before"))
                   )),
  fluidRow(column(2,
                  tags$div(
                    tags$strong('Workforce:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("workforce_text")), noWS = "before"
                  ))),
  fluidRow(column(2,
                  tags$div(
                    tags$strong('Stratifier:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("slider_text")), noWS = "before"
                  ))),
 fluidRow(column(2,
                  tags$div(
                    tags$strong('Sector:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sector_text")), noWS = "before"
                  )))
  
)

```

### Table {data-height=1800}
```{r, echo=FALSE}
fillPage(useShinyjs(rmd=T),
     fluidRow(column(
    12,
    h3(
      "Socio-demographic Composition of Occupations and Work Conditions with High Risk of Exposure to COVID-19"
    )
  )),
  hr(),
  (fluidRow(column(11,
      
      tags$ul(
        tags$li(
          "For each occupation, the number of workers, socio-demographic composition and frequency of work conditions related to a higher risk of exposure to COVID-19 are presented."
        ),
       # # br(),
        tags$li(
          "The table can be searched for occupations of interest (by name or NOC code) using the search box or rank occupations by table columns (arrows next to the column title)."
        ),
       # # br(),
        tags$li(
          "Information displayed is representative of parameters selected in the sidebar",
          tags$li(
          "This includes the parameters selected using the Sliders. For example, if the 'Immigrant Status' slider is set to a range 5-10%, the table will only display occupations with 5-10% 'Immigrant (%)'."
        )

        )
      )
    )
    )
   ),
    
     fluidRow(column(12, (
    actionButton("help_button_table", "Click for definitions of occupational measures from ONET")
  ))),
  
  shinyjs::hidden(fluidRow(
    id = 'help_info_table',
      column(
      11,
  
     (tags$b("Work Conditions with High Risk of Exposure to COVID-19 measured in the Occupational Informational Network (O*NET)")),
p(size=14,"Data on workers from the 2016 Census was linked to measures of how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 from O*NET"),
tags$b("Measures represent a weighted average score ranging from 0 to 100"),
tags$ul(
tags$li("Contact with others: How much does this job require the worker to be in contact with others in order to perform it?"),
  tags$ul(
 tags$li("no contact (0); occasional (25); half the time (50); most of the time (75); constant (100)")),

tags$li("Physical proximity: To what extent does this job require the worker to perform tasks in close physical proximity to others?"),
  tags$ul(
 tags$li("do not work near people (0); work with others, but not closely (25); slightly close, e.g., shared office (50); moderately close, e.g., arm’s length (75); very close, e.g., near touching (100)")),

tags$li("Exposure to disease or infection: How often does this job require exposure to disease/infections?"),
  tags$ul(
 tags$li("never exposed (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Interacting with the public: How important is performing for or working directly with the public to the performance of your current job?"),
  tags$ul(
 tags$li("not important (0), somewhat important (25), important (50), very important (75), extremely important (100)")),

tags$li("Indoors, Controlled environment: How often does this job require working indoors in environmentally controlled conditions?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Indoors, Uncontrolled environment: How often does this job require working indoors in non-controlled environmental conditions (e.g., warehouse without heat)?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)"))
)))
  ),
  
  
  fluidRow(column(12,
                  hr())),


  fluidRow(column(
    12,height="400%",
  DT::dataTableOutput("occ_exp_table"))),
 
 hr(),
 
  fluidRow(column(2,
  tags$div(
  tags$strong('Province/Territory:', .noWS="after"))),
  column(6,
  tags$div(
  (textOutput("province_text_table")), noWS="before"))
  ),
  conditionalPanel(
    condition = "input.hr_question == 1",
  fluidRow(column(2,
  tags$div(
  tags$strong('Health Region:', .noWS="after"))),
  column(6,
  tags$div(
  (textOutput("region_text_table")), noWS="before"))
  )),
    fluidRow(column(2,
  tags$div(
  tags$strong('Workforce:', .noWS="after"))),
  column(6,
  tags$div(
  (textOutput("workforce_text_table")), noWS="before"))
  ),
  fluidRow(column(2,
  tags$div(
  tags$strong('Stratifier:', .noWS="after"))),
  column(6,
  tags$div(
  (textOutput("slider_text_table")), noWS="before"))
  ),
 fluidRow(column(2,
                  tags$div(
                    tags$strong('Sector:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sector_text_table")), noWS = "before"
                  )))
)
style="overflow-y: scroll;overflow-x: scroll;"
```

Equity Stratifiers
====================
Column1{.sidebar }
---
```{r, echo=FALSE}
useShinyjs(rmd=T)
radioButtons("hr_question2", label=strong("Level of Geography"),
             choices=c("Provincial"=2,"Regional"=1),
             selected=2)

conditionalPanel(
  condition = "input.hr_question2 == 2 ||input.hr_question2 == 1",
  selectInput("geog2",label=strong("Province/Territory"),
              choices=as.list(unique(regions_input$geography)),
              selected="Ontario"))


conditionalPanel(
  condition = "input.hr_question2 == 1",
  conditionalPanel(
  condition = "input.geog2 == 'Ontario'",
selectInput("on2",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="Ontario")$health_region)),
            selected="Toronto Public Health")
            ))
conditionalPanel(
  condition = "input.hr_question2 == 1",
conditionalPanel(
  condition = "input.geog2 == 'British Columbia'",
selectInput("bc2",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="British Columbia")$health_region)),
            selected=1)
            ))

conditionalPanel(
  condition = "input.hr_question2 == 1",
  conditionalPanel(
  condition = "input.geog2 == 'Alberta'",
selectInput("ab2",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="Alberta")$health_region)),
            selected=1)
            ))

conditionalPanel(
  condition = "input.hr_question2 == 1",
  conditionalPanel(
  condition = "input.geog2 == 'Quebec'",
selectInput("qb2",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="Quebec")$health_region)),
            selected=1)
            ))
conditionalPanel(
  condition = "input.hr_question2 == 1",
  conditionalPanel(
  condition = "input.geog2 == 'Newfoundland and Labrador'",
selectInput("nl2",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="Newfoundland and Labrador")$health_region)),
            selected=1)
            ))

conditionalPanel(
  condition = "input.hr_question2 == 1",
  conditionalPanel(
  condition = "input.geog2 == 'Nova Scotia'",
selectInput("ns2",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="Nova Scotia")$health_region)),
            selected=1)
            ))

conditionalPanel(
  condition = "input.hr_question2 == 1",
  conditionalPanel(
  condition = "input.geog2 == 'New Brunswick'",
selectInput("nb2",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="New Brunswick")$health_region)),
            selected=1)
            ))

conditionalPanel(
  condition = "input.hr_question2 == 1",
  conditionalPanel(
  condition = "input.geog2 == 'Prince Edward Island'",
selectInput("pei2",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="Prince Edward Island")$health_region)),
            selected=1)
            ))

conditionalPanel(
  condition = "input.hr_question2 == 1",
  conditionalPanel(
  condition = "input.geog2 == 'Saskatchewan'",
selectInput("sk2",label=strong("Health Region"),
             choices=as.list(unique(subset(regions_input,geography=="Saskatchewan")$health_region)),
            selected=1)
            ))

conditionalPanel(
  condition = "input.hr_question2 == 1",
  conditionalPanel(
  condition = "input.geog2 == 'Manitoba'",
selectInput("mb2",label=strong("Health Region"),
             choices=as.list(unique(subset(regions_input,geography=="Manitoba")$health_region)),
            selected=1)
            ))

conditionalPanel(
  condition = "input.hr_question2 == 1",
  conditionalPanel(
  condition = "input.geog2 == 'Nunavut'",
selectInput("nu2",label=strong("Health Region"),
             choices=as.list(unique(subset(regions_input,geography=="Nunavut")$health_region)),
            selected=1)
            ))

conditionalPanel(
  condition = "input.hr_question2 == 1",
        conditionalPanel(
  condition = "input.geog2 == 'Northwest Territories'",

selectInput("nt2",label=strong("Health Region"),
             choices=as.list(unique(subset(regions_input,geography=="Northwest Territories")$health_region)),
            selected=1)
            ))

conditionalPanel(
  condition = "input.hr_question2 == 1",
        conditionalPanel(
  condition = "input.geog2 == 'Yukon'",
selectInput("yt2",label=strong("Health Region"),
             choices=as.list(unique(subset(regions_input,geography=="Yukon")$health_region)),
            selected=1)
            ))

radioButtons(inputId="restrict2",label=strong("Workforce"),
               choices=c("Total","Essential","Non-essential"),
             selected="Total")
selectInput("naics_sector2",label=strong("Select Industry Sector"),
            choices=c("Total Sectors",
                      "Agriculture, forestry, fishing and hunting",
                      "Mining, quarrying, and oil and gas extraction",
                      "Utilities",
                      "Construction",
                      "Manufacturing",
                      "Wholesale trade",
                      "Retail trade",
                      "Transportation and warehousing",
                      "Information and cultural industries",
                      "Finance and insurance",
                      "Real estate and rental and leasing",
                      "Professional, scientific and technical services",
                      "Management of companies and enterprises",
                      "Administrative and support, waste management and remediation services",
                      "Educational services",
                      "Health care and social assistance",
                      "Arts, entertainment and recreation",
                      "Accommodation and food services",
                      "Other services (except public administration)",
                      "Public administration"),
            selected="Total Sectors")

radioButtons(inputId="age_choose",label=strong("Age Group (years)"),
             choices=c('Total','15 - 24','25 - 34','35 - 44','45 - 54','55 - 64', '65+'),
             selected=c('Total'))

radioButtons(inputId="sex_choose",label=strong("Sex"),
             choices=c("Total","Female","Male"),
             selected="Total")
hr()


```

Column2{.tabset}
---

### Plot {data-height=1800}
```{r, echo=FALSE}
fillPage(
  useShinyjs(rmd = T),
   fluidRow(column(
    12,
    h3(
      "Socio-demographic Characteristics and Work Conditions With High-Risk of Exposure to COVID-19 by Occupation"
    )
  )),

 hr(),
  fluidRow(column(
      12,

      tags$ul(
        tags$li(
          "This tab is intended to examine occupational exposure to COVID-19 risk by age, sex, Race/Ethnicity and immigrant status at the Provincial/Territorial and health region level."
        ),
        # # br(),
        tags$li(
          "Broad occupation groups can be compared by clicking them from the list provided."
        ),
        # # br(),
        tags$li(
          "Occupation summaries can be found by hovering over bubbles in the figure or using the search box in the table view."
        ),
        # # br(),
        tags$li(
          " Each bubble represents an occupation and is proportional in size to the number of workers in that occupation."
        )
      )
    )
    ),




     fluidRow(column(12, (
     actionButton("help_button_social_plot", "Click for definitions of occupational measures from ONET")
  ))),

  shinyjs::hidden(fluidRow(
    id = 'help_info_social_plot',
      column(
      11,

     (tags$b("Work Conditions with High Risk of Exposure to COVID-19 measured in the Occupational Informational Network (O*NET)")),
p(size=14,"Data on workers from the 2016 Census was linked to measures of how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 from O*NET"),
tags$b("Measures represent a weighted average score ranging from 0 to 100"),
tags$ul(
tags$li("Contact with others: How much does this job require the worker to be in contact with others in order to perform it?"),
  tags$ul(
 tags$li("no contact (0); occasional (25); half the time (50); most of the time (75); constant (100)")),

tags$li("Physical proximity: To what extent does this job require the worker to perform tasks in close physical proximity to others?"),
  tags$ul(
 tags$li("do not work near people (0); work with others, but not closely (25); slightly close, e.g., shared office (50); moderately close, e.g., arm’s length (75); very close, e.g., near touching (100)")),

tags$li("Exposure to disease or infection: How often does this job require exposure to disease/infections?"),
  tags$ul(
 tags$li("never exposed (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Interacting with the public: How important is performing for or working directly with the public to the performance of your current job?"),
  tags$ul(
 tags$li("not important (0), somewhat important (25), important (50), very important (75), extremely important (100)")),

tags$li("Indoors, Controlled environment: How often does this job require working indoors in environmentally controlled conditions?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Indoors, Uncontrolled environment: How often does this job require working indoors in non-controlled environmental conditions (e.g., warehouse without heat)?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)"))
)))
  ),


  fluidRow(column(12,
                  hr())),

  fluidRow(
    column(9, div(style = "height:500px;", plotlyOutput("social_plot"))),
    column(align = "left",
      3,
      selectInput(
        "xaxis_2",
        label = strong("Occupational Measures: X-axis"),
        xaxis_options
        ,
        selected = "phys_prox"
      ),
      selectInput(
        "yaxis_2",
        label = strong("Occupational Measures: Y-axis"),
        yaxis_options
        ,
        selected = "exposure"
      ),
      checkboxGroupButtons(
        "noc_broad_choose",
        label = strong("Broad Occupation"),
        choices = c(
          "Management" = 0,
          "Business" = 1,
          "Sciences" = 2,
          "Health" = 3,
          "Community" = 4,
          "Culture" = 5,
          "Sales" = 6,
          "Trades" = 7,
          "Agriculture" = 8,
          "Utilities" = 9
        ),
        selected = 3,
        # checkIcon = list(
        # yes = icon("check-square"),
        # no = icon("square-o")),
        direction = "vertical",
        individual=T,
        justified = T
       ,
        status="primary"

      ),
      checkboxGroupInput(
        "telework_plot2",
        label = strong("Can work from home"),
        choices=c("Yes"=1,
                  "No"=0)
        ,
        selected = c(1,0)
      ),
      radioButtons(
        "selected_char",
        label = strong("Selected Characteristics"),
        choices = c(
          "Total" = "sum_total1",
          "Visible Minority" = "sum_vismin1",
          "Not Visible Minority" = "sum_white1",
          "Immigrant" = "sum_immig1",
          "Non-permanent Resident" = "sum_nonpermres1",
          "Non-Immigrant" = "sum_nonimmig1"
        ),
        selected = "sum_total1",
      )
    )
  ),
 fluidRow(column(10,offset = 1,tags$h1("Data from the Canadian Census (2016) mapped to Occupational Informational Network (O*NET)"))),
  hr(),
  fluidRow(column(2,
                  tags$div(
                    tags$strong('Province/Territory:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("province_text_social_plot")), .noWS = "before"
                  ))),
  conditionalPanel(condition = "input.hr_question2 == 1",
                   fluidRow(
                     column(2,
                            tags$div(
                              tags$strong('Health Region:', .noWS = "after")
                            )),
                     column(6,
                            tags$div((
                              textOutput("region_text_social_plot")
                            ), .noWS = "before"))
                   )),
  fluidRow(column(2,
                  tags$div(
                    tags$strong('Workforce:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("workforce_text_social_plot")), .noWS = "before"
                  ))),
  fluidRow(column(2,
                  tags$div(
                    tags$strong('Age (years):', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("age_choose_text_social_plot")), .noWS = "before"
                  ))),
  fluidRow(column(2,
                  tags$div(
                    tags$strong('Sex:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sex_choose_text_social_plot")), .noWS = "before"
                  ))),
 fluidRow(column(2,
                  tags$div(
                    tags$strong('Sector:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sector_text_social_plot")), noWS = "before"
                  )))
)


```

### Table {data-height=1800}
```{r, echo=FALSE}
fillPage(useShinyjs(rmd=T),

  fluidRow(column(
    12,
    h3(
      "Work Characteristics with High Risk of Exposure to COVID-19 According to Age, Sex, Visible Minority and Immigrant Status"
    )
  )),
  hr(),

 fluidRow(column(12,
      tags$ul(
        tags$li(
          "For each occupation, the number of workers, socio-demographic composition and frequency of work conditions related to a higher risk of exposure to COVID-19 are presented."
        ),
       # # br(),
        tags$li(
          "The table can be searched for occupations of interest (by name or NOC code) using the search box or rank occupations by table columns (arrows next to column title)."
        ),
         # # br(),
        tags$li(
          "Information displayed is representative of parameters selected in the sidebar."
        )
        # # br(),

      )
    )
    ),

     fluidRow(column(12, (
     actionButton("help_button_social_table", "Click for definitions of occupational measures from ONET")
  ))),

  shinyjs::hidden(fluidRow(
    id = 'help_info_social_table',
       column(
      11,

     (tags$b("Work Conditions with High Risk of Exposure to COVID-19 measured in the Occupational Informational Network (O*NET)")),
p(size=14,"Data on workers from the 2016 Census was linked to measures of how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 from O*NET"),
tags$b("Measures represent a weighted average score ranging from 0 to 100"),
tags$ul(
tags$li("Contact with others: How much does this job require the worker to be in contact with others in order to perform it?"),
  tags$ul(
 tags$li("no contact (0); occasional (25); half the time (50); most of the time (75); constant (100)")),

tags$li("Physical proximity: To what extent does this job require the worker to perform tasks in close physical proximity to others?"),
  tags$ul(
 tags$li("do not work near people (0); work with others, but not closely (25); slightly close, e.g., shared office (50); moderately close, e.g., arm’s length (75); very close, e.g., near touching (100)")),

tags$li("Exposure to disease or infection: How often does this job require exposure to disease/infections?"),
  tags$ul(
 tags$li("never exposed (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Interacting with the public: How important is performing for or working directly with the public to the performance of your current job?"),
  tags$ul(
 tags$li("not important (0), somewhat important (25), important (50), very important (75), extremely important (100)")),

tags$li("Indoors, Controlled environment: How often does this job require working indoors in environmentally controlled conditions?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Indoors, Uncontrolled environment: How often does this job require working indoors in non-controlled environmental conditions (e.g., warehouse without heat)?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)"))
)))
  ),
  fluidRow(column(12,
                  hr())),


fluidRow(column(12,height="400%",
 (DT::dataTableOutput("social_table")))),

 hr(),
  fluidRow(column(2,
                         tags$div(
                           tags$strong('Province/Territory:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("province_text_social_table")), .noWS="before"))
         ),
         conditionalPanel(
           condition = "input.hr_question2 == 1",
           fluidRow(column(2,
                           tags$div(
                             tags$strong('Health Region:', .noWS="after"))),
                    column(6,
                           tags$div(
                             (textOutput("region_text_social_table")), .noWS="before"))
           )),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Workforce:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("workforce_text_social_table")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Age (years):', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("age_choose_text_social_table")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Sex:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("sex_choose_text_social_table")), .noWS="before"))
         ),
 fluidRow(column(2,
                  tags$div(
                    tags$strong('Sector:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sector_text_social_table")), noWS = "before"
                  )))

)

style="overflow-y: scroll;overflow-x: scroll;"
```

### Summary Table {data-height=1800}
```{r, echo=FALSE}
fillPage(
  useShinyjs(rmd = T),
    fluidRow(column(
    12,
    h3(
      "Age, Sex, Visible Minority and Immigrant Status and Work Conditions with High Risk of Exposure to COVID-19"
    )
  )),
  hr(),
  fluidRow(column(12,
              tags$ul(
                  tags$li(
               "This tab presents the average risk of occupational exposure to COVID-19 across equity stratifiers."

           ))
           )),

     fluidRow(column(12, (
     actionButton("help_button_social_summary", "Click for definitions of occupational measures from ONET")
  ))),

  shinyjs::hidden(fluidRow(
    id = 'help_info_social_summary',
      column(
      11,

     (tags$b("Work Conditions with High Risk of Exposure to COVID-19 measured in the Occupational Informational Network (O*NET)")),
p(size=14,"Data on workers from the 2016 Census was linked to measures of how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 from O*NET"),
tags$b("Measures represent a weighted average score ranging from 0 to 100"),
tags$ul(
tags$li("Contact with others: How much does this job require the worker to be in contact with others in order to perform it?"),
  tags$ul(
 tags$li("no contact (0); occasional (25); half the time (50); most of the time (75); constant (100)")),

tags$li("Physical proximity: To what extent does this job require the worker to perform tasks in close physical proximity to others?"),
  tags$ul(
 tags$li("do not work near people (0); work with others, but not closely (25); slightly close, e.g., shared office (50); moderately close, e.g., arm’s length (75); very close, e.g., near touching (100)")),

tags$li("Exposure to disease or infection: How often does this job require exposure to disease/infections?"),
  tags$ul(
 tags$li("never exposed (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Interacting with the public: How important is performing for or working directly with the public to the performance of your current job?"),
  tags$ul(
 tags$li("not important (0), somewhat important (25), important (50), very important (75), extremely important (100)")),

tags$li("Indoors, Controlled environment: How often does this job require working indoors in environmentally controlled conditions?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Indoors, Uncontrolled environment: How often does this job require working indoors in non-controlled environmental conditions (e.g., warehouse without heat)?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)"))
)))
  ),

  fluidRow(column(12,
                  hr())),


  fluidRow(column(12, height = "400%",
                  (
                    DT::dataTableOutput("b_summary_social")
                  ))),
   hr(),
  fluidRow(column(2,
                  tags$div(
                    tags$strong('Province/Territory:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("province_text_social_summary")), .noWS = "before"
                  ))),
  conditionalPanel(condition = "input.hr_question2 == 1",
                   fluidRow(
                     column(2,
                            tags$div(
                              tags$strong('Health Region:', .noWS = "after")
                            )),
                     column(6,
                            tags$div((
                              textOutput("region_text_social_summary")
                            ), .noWS = "before"))
                   )),
  fluidRow(column(2,
                  tags$div(
                    tags$strong('Workforce:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("workforce_text_social_summary")), .noWS = "before"
                  ))),
  fluidRow(column(2,
                  tags$div(
                    tags$strong('Age (years):', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("age_choose_text_social_summary")), .noWS = "before"
                  ))),
  fluidRow(column(2,
                  tags$div(
                    tags$strong('Sex:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sex_choose_text_social_summary")), .noWS = "before"
                  ))),
 fluidRow(column(2,
                  tags$div(
                    tags$strong('Sector:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sector_text_social_summary")), noWS = "before"
                  )))

)
style = "overflow-y: scroll;overflow-x: scroll;"
```


Race/Ethnicity
====================
Column1{.sidebar }
----
```{r, echo=FALSE}
useShinyjs(rmd=T)
selectInput("geog_v",
            label=strong("Province/Territory"),
             choices=as.list(unique(regions_input$geography)),
            selected="Ontario")

radioButtons(inputId="restrict_v",
             label=strong("Workforce"),
             choices=c("Total","Essential","Non-essential"),
             selected="Total")
selectInput("naics_sector_v",label=strong("Select Industry Sector"),
            choices=c("Total Sectors",
                      "Agriculture, forestry, fishing and hunting",
                      "Mining, quarrying, and oil and gas extraction",
                      "Utilities",
                      "Construction",
                      "Manufacturing",
                      "Wholesale trade",
                      "Retail trade",
                      "Transportation and warehousing",
                      "Information and cultural industries",
                      "Finance and insurance",
                      "Real estate and rental and leasing",
                      "Professional, scientific and technical services",
                      "Management of companies and enterprises",
                      "Administrative and support, waste management and remediation services",
                      "Educational services",
                      "Health care and social assistance",
                      "Arts, entertainment and recreation",
                      "Accommodation and food services",
                      "Other services (except public administration)",
                      "Public administration"),
            selected="Total Sectors")

radioButtons(inputId="age_choose_v",
                   label=strong("Age Group (years)"),
                          choices=c('Total','15 - 24','25 - 34','35 - 44','45 - 54','55 - 64', '65+'),
             selected=c('Total'))

radioButtons(inputId="sex_choose_v",
             label=strong("Sex"),
             choices=c('Total','Female','Male'),
             selected="Total")

hr()

```

Column2{.tabset}
----

<!-- ### Description  -->
<!-- ```{r, echo=FALSE} -->

<!-- ``` -->

### Plot {data-height=1800}
```{r, echo=FALSE}
fillPage(useShinyjs(rmd=T),
         fluidRow(column(
    12,
    h3(
      "Occupations and Work Conditions with High Risk of Exposure to COVID-19 by Race/Ethnicity"
    )
  )),
  hr(),

  fluidRow(column(12,
           tags$ul(
                 tags$li(
               "This tab is intended to examine risk of exposure to COVID-19 in occupations by specific categories of Race/Ethnicity."
             ),
             # # br(),
             tags$li(
               "Small sample sizes restrict data reporting to the Provincial/Territorial level."
             ),
             tags$li(
               "Occupation summaries can be found by hovering over bubbles in the figure or using the search box in the table view."
             ),
               # # br(),
             tags$li(
               "Each bubble represents an occupation and is proportional in size to the number of workers in that occupation."
             )
           )
           )
           ),

      fluidRow(column(12, (
     actionButton("help_button_vismin_plot", "Click for definitions of occupational measures from ONET")
  ))),

  shinyjs::hidden(fluidRow(
    id = 'help_info_vismin_plot',
      column(
      11,

     (tags$b("Work Conditions with High Risk of Exposure to COVID-19 measured in the Occupational Informational Network (O*NET)")),
p(size=14,"Data on workers from the 2016 Census was linked to measures of how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 from O*NET"),
tags$b("Measures represent a weighted average score ranging from 0 to 100"),
tags$ul(
tags$li("Contact with others: How much does this job require the worker to be in contact with others in order to perform it?"),
  tags$ul(
 tags$li("no contact (0); occasional (25); half the time (50); most of the time (75); constant (100)")),

tags$li("Physical proximity: To what extent does this job require the worker to perform tasks in close physical proximity to others?"),
  tags$ul(
 tags$li("do not work near people (0); work with others, but not closely (25); slightly close, e.g., shared office (50); moderately close, e.g., arm’s length (75); very close, e.g., near touching (100)")),

tags$li("Exposure to disease or infection: How often does this job require exposure to disease/infections?"),
  tags$ul(
 tags$li("never exposed (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Interacting with the public: How important is performing for or working directly with the public to the performance of your current job?"),
  tags$ul(
 tags$li("not important (0), somewhat important (25), important (50), very important (75), extremely important (100)")),

tags$li("Indoors, Controlled environment: How often does this job require working indoors in environmentally controlled conditions?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Indoors, Uncontrolled environment: How often does this job require working indoors in non-controlled environmental conditions (e.g., warehouse without heat)?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)"))
)))
  ),

   fluidRow(column(12,
                  hr())),



  fluidRow(column(9,div(style = "height:500px;", plotlyOutput("vismin_plot"))),

column(3,
selectInput("xaxis_v", label=strong("Occupational Measures: X-axis"),xaxis_options,selected="phys_prox"),

selectInput("yaxis_v",label=strong("Occupational Measures: Y-axis"),yaxis_options,selected="exposure"),
checkboxGroupButtons(
        "noc_broad_choose_v",
        label = strong("Broad Occupation"),
        choices = c(
          "Management" = 0,
          "Business" = 1,
          "Sciences" = 2,
          "Health" = 3,
          "Community" = 4,
          "Culture" = 5,
          "Sales" = 6,
          "Trades" = 7,
          "Agriculture" = 8,
          "Utilities" = 9
        ),
        selected = 3,
        # checkIcon = list(
        # yes = icon("check-square"),
        # no = icon("square-o")),
        direction = "vertical",
        individual=T,
        justified = T
       ,
        status="primary"

      ),
checkboxGroupInput(
        "telework_plot_v",
        label = strong("Can work from home"),
        choices=c("Yes"=1,
                  "No"=0)
        ,
        selected = c(1,0)
      ),
radioButtons(inputId="vis_groups",
             label=strong("Race/Ethnicity"),
             choices=c("Visible Minority (total)"="sum_vismin1",
                       "South Asian"="sum_southasia1",
                       "East Asian"="sum_easteasia1",
                       "Black"="sum_black1",
                       "South East Asian"="sum_se_asia1",
                       "Latin"="sum_latin1",
                       "Middle Eastern"="sum_mideast1",
                       "Not Included Elsewhere"="sum_nie1",
                       "Multiple"="sum_multivismin1",
                       #"Not Visible Minority - Indigenous"="sum_aboriginal_new",
                       "Not Visible Minority"="sum_white1"),
             selected="sum_vismin1",
             inline=F))
)
,
fluidRow(column(10,offset = 1,tags$h1("Data from the Canadian Census (2016) mapped to Occupational Informational Network (O*NET)"))),
 hr(),

         fluidRow(column(2,
                         tags$div(
                           tags$strong('Province/Territory:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("province_text_vismin_plot")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Workforce:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("workforce_text_vismin_plot")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Age (years):', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("age_choose_text_vismin_plot")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Sex:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("sex_choose_text_vismin_plot")), .noWS="before"))
         ),
 fluidRow(column(2,
                  tags$div(
                    tags$strong('Sector:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sector_text_vismin_plot")), noWS = "before"
                  )))

)
# style="overflow-y: scroll;overflow-x: scroll;overflow: scroll;"


```

### Table {data-height=1800}
```{r, echo=FALSE}
fillPage(useShinyjs(rmd=T),

 h3("Occupations and Work Characteristics with High Risk of Exposure to COVID-19 by Race/Ethnicity"),
 hr(),

  fluidRow(column(12,
           tags$ul(
                 tags$li(
               "For each occupation, the number of workers, overall and by Race/Ethnicity categories and frequency of work conditions related to a higher risk of exposure to COVID-19 are presented."
             ),
             # # br(),
             tags$li(
               "The table can be searched for occupations of interest (by name or NOC code) using the search box or rank occupations by table columns (arrows next to column title)."
             ),
               # # br(),
             tags$li(
               "Information displayed is representative of parameters selected in the sidebar."
             )
           )
           )
           ),

      fluidRow(column(12, (
     actionButton("help_button_vismin_table", "Click for definitions of occupational measures from ONET")
  ))),

  shinyjs::hidden(fluidRow(
    id = 'help_info_vismin_table',
        column(
      11,

     (tags$b("Work Conditions with High Risk of Exposure to COVID-19 measured in the Occupational Informational Network (O*NET)")),
p(size=14,"Data on workers from the 2016 Census was linked to measures of how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 from O*NET"),
tags$b("Measures represent a weighted average score ranging from 0 to 100"),
tags$ul(
tags$li("Contact with others: How much does this job require the worker to be in contact with others in order to perform it?"),
  tags$ul(
 tags$li("no contact (0); occasional (25); half the time (50); most of the time (75); constant (100)")),

tags$li("Physical proximity: To what extent does this job require the worker to perform tasks in close physical proximity to others?"),
  tags$ul(
 tags$li("do not work near people (0); work with others, but not closely (25); slightly close, e.g., shared office (50); moderately close, e.g., arm’s length (75); very close, e.g., near touching (100)")),

tags$li("Exposure to disease or infection: How often does this job require exposure to disease/infections?"),
  tags$ul(
 tags$li("never exposed (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Interacting with the public: How important is performing for or working directly with the public to the performance of your current job?"),
  tags$ul(
 tags$li("not important (0), somewhat important (25), important (50), very important (75), extremely important (100)")),

tags$li("Indoors, Controlled environment: How often does this job require working indoors in environmentally controlled conditions?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Indoors, Uncontrolled environment: How often does this job require working indoors in non-controlled environmental conditions (e.g., warehouse without heat)?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)"))
)))
  ),

fluidRow(column(12,height="400%",
  DT::dataTableOutput("vismin_table"))),

 hr(),
fluidRow(column(2,
                         tags$div(
                           tags$strong('Province/Territory:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("province_text_vismin_table")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Workforce:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("workforce_text_vismin_table")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Age (years):', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("age_choose_text_vismin_table")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Sex:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("sex_choose_text_vismin_table")), .noWS="before"))
         ),
 fluidRow(column(2,
                  tags$div(
                    tags$strong('Sector:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sector_text_vismin_table")), noWS = "before"
                  )))
)
style="overflow-y: scroll;overflow-x: scroll;"
```

### Summary Table {data-height=1800}
```{r, echo=FALSE}
fillPage(useShinyjs(rmd=T),
 h3("Race/Ethnicity and Work Conditions with High Risk of Exposure to COVID-19"),
 hr(),

  fluidRow(column(12,
           tags$ul(
                 tags$li(
               "The summary tab presents the average risk of exposure to COVID-19 within specific visible minority categories."
             )))),
             # # br(),
        fluidRow(column(12, (
     actionButton("help_button_vismin_summary", "Click for definitions of occupational measures from ONET")
  ))),
  shinyjs::hidden(fluidRow(
    id = 'help_info_vismin_summary',
        column(
      11,

     (tags$b("Work Conditions with High Risk of Exposure to COVID-19 measured in the Occupational Informational Network (O*NET)")),
p(size=14,"Data on workers from the 2016 Census was linked to measures of how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 from O*NET"),
tags$b("Measures represent a weighted average score ranging from 0 to 100"),
tags$ul(
tags$li("Contact with others: How much does this job require the worker to be in contact with others in order to perform it?"),
  tags$ul(
 tags$li("no contact (0); occasional (25); half the time (50); most of the time (75); constant (100)")),

tags$li("Physical proximity: To what extent does this job require the worker to perform tasks in close physical proximity to others?"),
  tags$ul(
 tags$li("do not work near people (0); work with others, but not closely (25); slightly close, e.g., shared office (50); moderately close, e.g., arm’s length (75); very close, e.g., near touching (100)")),

tags$li("Exposure to disease or infection: How often does this job require exposure to disease/infections?"),
  tags$ul(
 tags$li("never exposed (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Interacting with the public: How important is performing for or working directly with the public to the performance of your current job?"),
  tags$ul(
 tags$li("not important (0), somewhat important (25), important (50), very important (75), extremely important (100)")),

tags$li("Indoors, Controlled environment: How often does this job require working indoors in environmentally controlled conditions?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Indoors, Uncontrolled environment: How often does this job require working indoors in non-controlled environmental conditions (e.g., warehouse without heat)?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)"))
)))
  ),



fluidRow(column(12,height="400%",
  DT::dataTableOutput("b_summary_vismin"))),

 hr(),
 fluidRow(column(2,
                         tags$div(
                           tags$strong('Province/Territory:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("province_text_vismin_summary")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Workforce:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("workforce_text_vismin_summary")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Age (years):', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("age_choose_text_vismin_summary")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Sex:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("sex_choose_text_vismin_summary")), .noWS="before"))
         ),
 fluidRow(column(2,
                  tags$div(
                    tags$strong('Sector:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sector_text_vismin_summary")), noWS = "before"
                  )))
)
style="overflow-y: scroll;overflow-x: scroll;"
```

Income
====================
Column1{.sidebar }
---
```{r, echo=FALSE}
useShinyjs(rmd=T)
selectInput("geog_iq2",label=strong("Province/Territory"),
             choices=as.list(unique(regions_input$geography)),
            selected="Ontario")

radioButtons(inputId="restrict_iq2",label=strong("Workforce"),
              choices=c("Total","Essential","Non-essential"),
             selected="Total")
selectInput("naics_sector_iq2",label=strong("Select Industry Sector"),
            choices=c("Total Sectors",
                      "Agriculture, forestry, fishing and hunting",
                      "Mining, quarrying, and oil and gas extraction",
                      "Utilities",
                      "Construction",
                      "Manufacturing",
                      "Wholesale trade",
                      "Retail trade",
                      "Transportation and warehousing",
                      "Information and cultural industries",
                      "Finance and insurance",
                      "Real estate and rental and leasing",
                      "Professional, scientific and technical services",
                      "Management of companies and enterprises",
                      "Administrative and support, waste management and remediation services",
                      "Educational services",
                      "Health care and social assistance",
                      "Arts, entertainment and recreation",
                      "Accommodation and food services",
                      "Other services (except public administration)",
                      "Public administration"),
            selected="Total Sectors")
radioButtons(inputId="age_choose_iq",label=strong("Age Group (years)"),
                        choices=c('Total','15 - 24','25 - 34','35 - 44','45 - 54','55 - 64', '65+'),
             selected=c('Total'))

radioButtons(inputId="sex_choose_iq",label=strong("Sex"),
             choices=c("Total", "Female","Male"),
             selected="Total")

hr()

```

Column2{.tabset}
---

### Plot {data-height=1800}
```{r, echo=FALSE}
fillPage(useShinyjs(rmd=T),
  fluidRow(column(
    12,
    h3(
      "Occupations and Work Conditions with High Risk of Exposure to COVID-19 by Household Income"
    )
  )),
  hr(),
    fluidRow(column(12,
           tags$ul(
             tags$li(
               "This tab is intended to examine risk of exposure to COVID-19 in occupations by household income qunitiles. "
             ),
             # # br(),
             tags$li(
               "Small sample sizes restrict data reporting to the Provincial/Territorial level."
             ),
             # # br(),
             tags$li(
               "Occupation summaries can be found by hovering over bubbles in the figure or using the search box in the table view."
             ),
              # # br(),
             tags$li(
               "Each bubble represents an occupation and is proportional in size to the number of workers in that occupation."
             )
           )
           )
           ),

          fluidRow(column(12, (
     actionButton("help_button_income_plot", "Click for definitions of occupational measures from ONET")
  ))),

  shinyjs::hidden(fluidRow(
    id = 'help_info_income_plot',
       column(
      11,

     (tags$b("Work Conditions with High Risk of Exposure to COVID-19 measured in the Occupational Informational Network (O*NET)")),
p(size=14,"Data on workers from the 2016 Census was linked to measures of how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 from O*NET"),
tags$b("Measures represent a weighted average score ranging from 0 to 100"),
tags$ul(
tags$li("Contact with others: How much does this job require the worker to be in contact with others in order to perform it?"),
  tags$ul(
 tags$li("no contact (0); occasional (25); half the time (50); most of the time (75); constant (100)")),

tags$li("Physical proximity: To what extent does this job require the worker to perform tasks in close physical proximity to others?"),
  tags$ul(
 tags$li("do not work near people (0); work with others, but not closely (25); slightly close, e.g., shared office (50); moderately close, e.g., arm’s length (75); very close, e.g., near touching (100)")),

tags$li("Exposure to disease or infection: How often does this job require exposure to disease/infections?"),
  tags$ul(
 tags$li("never exposed (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Interacting with the public: How important is performing for or working directly with the public to the performance of your current job?"),
  tags$ul(
 tags$li("not important (0), somewhat important (25), important (50), very important (75), extremely important (100)")),

tags$li("Indoors, Controlled environment: How often does this job require working indoors in environmentally controlled conditions?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Indoors, Uncontrolled environment: How often does this job require working indoors in non-controlled environmental conditions (e.g., warehouse without heat)?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)"))
)))
  ),

   fluidRow(column(12,
                  hr())),




  fluidRow(column(9,div(style = "height:500px;", plotlyOutput("income_social_plot"))),

    column(
      3,
      selectInput(
        "xaxis_iq2",
        label = strong("Occupational Measures: X-axis"),
        xaxis_options
        ,
        selected = "phys_prox"
      ),

      selectInput(
        "yaxis_iq2",
        label = strong("Occupational Measures: Y-axis"),
        yaxis_options
        ,
        selected = "exposure"
      ),
      checkboxGroupButtons(
        "noc_broad_choose_iq",
        label = strong("Broad Occupation"),
        choices = c(
          "Management" = 0,
          "Business" = 1,
          "Sciences" = 2,
          "Health" = 3,
          "Community" = 4,
          "Culture" = 5,
          "Sales" = 6,
          "Trades" = 7,
          "Agriculture" = 8,
          "Utilities" = 9
        ),
        selected = 3,
        # checkIcon = list(
        # yes = icon("check-square"),
        # no = icon("square-o")),
        direction = "vertical",
        individual=T,
        justified = T
       ,
        status="primary"

      ),
      checkboxGroupInput(
        "telework_plot_iq2",
        label = strong("Can work from home"),
        choices=c("Yes"=1,
                  "No"=0)
        ,
        selected = c(1,0)
      ),
       radioButtons(
        "income_quintile",
        label = strong("Household Income"),
        choices = c(
          "Quintile 1 - Low" = "sum_quintile1",
          "Quintile 2" = "sum_quintile2",
          "Quintile 3" = "sum_quintile3",
          "Quintile 4" = "sum_quintile4",
          "Quintile 5 - High" = "sum_quintile5"
        ),
        selected = "sum_quintile1"
      )
    )

    )

,
fluidRow(column(10,offset = 1,tags$h1("Data from the Canadian Census (2016) mapped to Occupational Informational Network (O*NET)"))),
 hr(),
 fluidRow(column(2,
                         tags$div(
                           tags$strong('Province/Territory:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("province_text_income_plot")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Workforce:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("workforce_text_income_plot")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Age (years):', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("age_choose_text_income_plot")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Sex:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("sex_choose_text_income_plot")), .noWS="before"))
         ),
 fluidRow(column(2,
                  tags$div(
                    tags$strong('Sector:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sector_text_income_plot")), noWS = "before"
                  )))
)
# style="overflow-y: scroll;overflow-x: scroll;overflow: scroll;"


```

### Table {data-height=1800}
```{r, echo=FALSE}
fillPage(useShinyjs(rmd=T),
      fluidRow(column(12,
     h3("Occupations and Work Characteristics with High Risk of Exposure to COVID-19 by Household Income"))),
      hr(),
    fluidRow(column(12,
           tags$ul(
             tags$li(
               "For each occupation, the number of workers, overall and by household income quintiles and frequency of work conditions related to a higher risk of exposure to COVID-19 are presented."
             ),
             # # br(),
             tags$li(
               "The table can be searched for occupations of interest (by name or NOC code) using the search box or rank occupations by table columns (arrows next to column title)."
             ),
              # # br(),
             tags$li(
               "Information displayed is representative of parameters selected in the sidebar."
             )
           )
           )
           ),
    actionButton("help_button_income_table", "Click for definitions of occupational measures from ONET"),
     shinyjs::hidden(fluidRow(
    id = 'help_info_income_table',
        column(
      11,

     (tags$b("Work Conditions with High Risk of Exposure to COVID-19 measured in the Occupational Informational Network (O*NET)")),
p(size=14,"Data on workers from the 2016 Census was linked to measures of how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 from O*NET"),
tags$b("Measures represent a weighted average score ranging from 0 to 100"),
tags$ul(
tags$li("Contact with others: How much does this job require the worker to be in contact with others in order to perform it?"),
  tags$ul(
 tags$li("no contact (0); occasional (25); half the time (50); most of the time (75); constant (100)")),

tags$li("Physical proximity: To what extent does this job require the worker to perform tasks in close physical proximity to others?"),
  tags$ul(
 tags$li("do not work near people (0); work with others, but not closely (25); slightly close, e.g., shared office (50); moderately close, e.g., arm’s length (75); very close, e.g., near touching (100)")),

tags$li("Exposure to disease or infection: How often does this job require exposure to disease/infections?"),
  tags$ul(
 tags$li("never exposed (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Interacting with the public: How important is performing for or working directly with the public to the performance of your current job?"),
  tags$ul(
 tags$li("not important (0), somewhat important (25), important (50), very important (75), extremely important (100)")),

tags$li("Indoors, Controlled environment: How often does this job require working indoors in environmentally controlled conditions?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Indoors, Uncontrolled environment: How often does this job require working indoors in non-controlled environmental conditions (e.g., warehouse without heat)?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)"))
)))
  ),

fluidRow(column(12,height="400%",
 (DT::dataTableOutput("income_social_table")))),

 hr(),
fluidRow(column(2,
                         tags$div(
                           tags$strong('Province/Territory:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("province_text_income_table")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Workforce:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("workforce_text_income_table")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Age (years):', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("age_choose_text_income_table")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Sex:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("sex_choose_text_income_table")), .noWS="before"))
         ),
 fluidRow(column(2,
                  tags$div(
                    tags$strong('Sector:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sector_text_income_table")), noWS = "before"
                  )))
)
style="overflow-y: scroll;overflow-x: scroll;"
```

### Summary Table {data-height=1800}
```{r, echo=FALSE}
fillPage(useShinyjs(rmd=T),
    fluidRow(column(12,
       h3("Household Income and Work Conditions with High Risk of Exposure to COVID-19"))),
hr(),
 fluidRow(column(12,
           tags$ul(
             tags$li(
               "The summary tab presents the average risk of exposure to COVID-19 within household income quintiles."
             )))),

         actionButton("help_button_income_summary", "Click for definitions of occupational measures from ONET"),
     shinyjs::hidden(fluidRow(
    id = 'help_info_income_summary',
        column(
      11,

     (tags$b("Work Conditions with High Risk of Exposure to COVID-19 measured in the Occupational Informational Network (O*NET)")),
p(size=14,"Data on workers from the 2016 Census was linked to measures of how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 from O*NET"),
tags$b("Measures represent a weighted average score ranging from 0 to 100"),
tags$ul(
tags$li("Contact with others: How much does this job require the worker to be in contact with others in order to perform it?"),
  tags$ul(
 tags$li("no contact (0); occasional (25); half the time (50); most of the time (75); constant (100)")),

tags$li("Physical proximity: To what extent does this job require the worker to perform tasks in close physical proximity to others?"),
  tags$ul(
 tags$li("do not work near people (0); work with others, but not closely (25); slightly close, e.g., shared office (50); moderately close, e.g., arm’s length (75); very close, e.g., near touching (100)")),

tags$li("Exposure to disease or infection: How often does this job require exposure to disease/infections?"),
  tags$ul(
 tags$li("never exposed (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Interacting with the public: How important is performing for or working directly with the public to the performance of your current job?"),
  tags$ul(
 tags$li("not important (0), somewhat important (25), important (50), very important (75), extremely important (100)")),

tags$li("Indoors, Controlled environment: How often does this job require working indoors in environmentally controlled conditions?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)")),

tags$li("Indoors, Uncontrolled environment: How often does this job require working indoors in non-controlled environmental conditions (e.g., warehouse without heat)?"),
  tags$ul(
 tags$li("never (0), once a year (25); once a month (50); once a week (75); every day (100)"))
)))
  ),

fluidRow(column(12,height="400%",
 (DT::dataTableOutput("b_summary_income")))),
 hr(),
  fluidRow(column(2,
                         tags$div(
                           tags$strong('Province/Territory:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("province_text_income_summary")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Workforce:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("workforce_text_income_summary")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Age (years):', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("age_choose_text_income_summary")), .noWS="before"))
         ),
         fluidRow(column(2,
                         tags$div(
                           tags$strong('Sex:', .noWS="after"))),
                  column(6,
                         tags$div(
                           (textOutput("sex_choose_text_income_summary")), .noWS="before"))
         ),
 fluidRow(column(2,
                  tags$div(
                    tags$strong('Sector:', .noWS = "after")
                  )),
           column(6,
                  tags$div(
                    (textOutput("sector_text_income_summary")), noWS = "before"
                  )))
)
style="overflow-y: scroll;overflow-x: scroll;"
```

Comparisons{.tabset}
====================
### {data-height=3000}
```{r, echo=FALSE}
load("vismin_chart.RData")
load("immig_chart.RData")
load("age_group_chart.RData")
load("income_chart.RData")

load("hr_vismin_chart.RData")
load("hr_immig_chart.RData")
load("hr_age_group_chart.RData")

occup_search <- readRDS("occup_search_tool_onet.rds")

fluidPage(column(12,
  useShinyjs(rmd=T),
   fluidRow(column(12,
            h3("Comparing Work Conditions With High-Risk of Exposure to COVID-19 Across Occupations"))),
fluidRow(column(12,
            tags$ul(
tags$li("Select two occupations of interest to compare occupational exposure to COVID-19 risk and the workforce socio-demographic composition at the Provincial/Territorial and health region level."),
tags$li("You can select occupations using the dropdown menus or by typing in an empty searchbar (NOTE: In order to search by typing, the occupation field must be empty)."),
tags$li("Please note: 'Can work from home' information in the tables: 1 = 'yes'; 0 = 'no'.")
)
)
),

fluidRow(
 column(align="center",4,
        radioButtons("hr_question3", label=strong("Level of Geography"),
             choices=c("Provincial"=2,"Regional"=1),
             selected=2)),


        conditionalPanel(
  condition = "input.hr_question3 == 2 ||input.hr_question3 == 1",
   (column(align="center",4,
  selectInput("geog_select2",label=strong("Province/Territory"),
              choices=as.list(unique(regions_input$geography)),
              selected="Ontario")))),



conditionalPanel(
  condition = "input.hr_question3 == 1",
  conditionalPanel(
     condition = "input.geog_select2 == 'Ontario'",
    (column(align="center",4,
    selectInput("on3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Ontario")$health_region)),
                selected="Toronto Public Health")))
    )),
conditionalPanel(
  condition = "input.hr_question3 == 1",
conditionalPanel(
  condition = "input.geog_select2 == 'British Columbia'",
  (column(align="center",4,
     selectInput("bc3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="British Columbia")$health_region)),
                selected=1)))
  )),
conditionalPanel(
  condition = "input.hr_question3 == 1",
conditionalPanel(
  condition = "input.geog_select2 == 'Alberta'",
  (column(align="center",4,
    selectInput("ab3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Alberta")$health_region)),
                selected=1)))
)),
conditionalPanel(
  condition = "input.hr_question3 == 1",
conditionalPanel(
  condition = "input.geog_select2 == 'Quebec'",
  (column(align="center",4,
    selectInput("qb3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Quebec")$health_region)),
                selected=1)))
)),
conditionalPanel(
  condition = "input.hr_question3 == 1",
conditionalPanel(
  condition = "input.geog_select2 == 'Newfoundland and Labrador'",
  (column(align="center",4,
    selectInput("nl3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Newfoundland and Labrador")$health_region)),
                selected=1)))
)),
conditionalPanel(
  condition = "input.hr_question3 == 1",
conditionalPanel(
  condition = "input.geog_select2 == 'Nova Scotia'",
  (column(align="center",4,
    selectInput("ns3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Nova Scotia")$health_region)),
                selected=1)))
)),
conditionalPanel(
  condition = "input.hr_question3 == 1",
conditionalPanel(
  condition = "input.geog_select2 == 'New Brunswick'",
  (column(align="center",4,
    selectInput("nb3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="New Brunswick")$health_region)),
                selected=1)))
)),
conditionalPanel(
  condition = "input.hr_question3 == 1",
conditionalPanel(
  condition = "input.geog_select2 == 'Prince Edward Island'",
  (column(align="center",4,
    selectInput("pei3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Prince Edward Island")$health_region)),
                selected=1)))
)),
conditionalPanel(
  condition = "input.hr_question3 == 1",
conditionalPanel(
  condition = "input.geog_select2 == 'Saskatchewan'",
  (column(align="center",4,
    selectInput("sk3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Saskatchewan")$health_region)),
                selected=1)))
)),
conditionalPanel(
  condition = "input.hr_question3 == 1",
conditionalPanel(
  condition = "input.geog_select2 == 'Manitoba'",
  (column(align="center",4,
    selectInput("mb3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Manitoba")$health_region)),
                selected=1)))
)),
conditionalPanel(
  condition = "input.hr_question3 == 1",
conditionalPanel(
  condition = "input.geog_select2 == 'Nunavut'",
  (column(align="center",4,
    selectInput("nu3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Nunavut")$health_region)),
                selected=1)))
)),
conditionalPanel(
  condition = "input.hr_question3 == 1",
conditionalPanel(
  condition = "input.geog_select2 == 'Northwest Territories'",
  (column(align="center",4,
    selectInput("nt3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Northwest Territories")$health_region)),
                selected=1)))
  )),
conditionalPanel(
  condition = "input.hr_question3 == 1",
conditionalPanel(
  condition = "input.geog_select2 == 'Yukon'",
  (column(align="center",4,
    selectInput("yt3",label=strong("Select Health Region"),
                choices=as.list(unique(subset(regions_input,geography=="Yukon")$health_region)),
                selected=1)))
  ))
)),




fluidRow(
         column(6,align="center",
                selectizeInput(inputId="noc_code_select1",label=strong("Select Occupation 1:"),
                        choices=as.list(unique(occup_search$noc_code_class)),
             selected=NULL,multiple=T,
             options = list(
            placeholder = "Please select an occupation",
            maxItems = 1))),
               column(6,align="center",
                selectizeInput(inputId="noc_code_select2",label=strong("Select Occupation 2:"),
                        choices=as.list(unique(occup_search$noc_code_class)),
             selected=NULL,multiple=T,
             options = list(
            placeholder = "Please select an occupation",
            maxItems = 1)))),


fluidRow(column(align = "center",6,p((h3('Summary Information for:',tags$b(textOutput("prov1")),tags$b(textOutput("regions1")),tags$b(textOutput("noc_chosen1")))))),
         column(align = "center",6,p((h3('Summary Information for:',tags$b(textOutput("prov2")),tags$b(textOutput("regions2")),tags$b(textOutput("noc_chosen2"))))))
         ),

fluidRow(column(align = "center",6,div(style = "height:500px;", plotlyOutput("forest_plot1"))),
         column(align = "center",6,div(style = "height:500px;",plotlyOutput("forest_plot2")))),

tags$style(HTML('table.dataTable tr:nth-child(even) {background-color: white !important;}')),
  tags$style(HTML('table.dataTable tr:nth-child(odd) {background-color: white !important;}')),
  tags$style(HTML('table.dataTable th {background-color: white !important;}')),
fluidRow(column(align = "center",4,offset=2,DT::dataTableOutput("table_occup_info1")),column(align = "center",4,offset=2,DT::dataTableOutput("table_occup_info2"))),
hr(),



## proportion wfh phys prox exposure charts


   fluidRow(column(12,
             h3("Sex-specific Percent of Workers at High-Risk of Occupational Exposure to COVID-19 Risk According to Equity Stratifiers "))),
fluidRow(column(12,
            tags$ul(
tags$li("Select variables of interest to customize the results according to level of geography, industry sector, equity stratifier and occupational risk measure.")
)
)
),

actionButton("help_button_industry_summary", "Click for definitions of occupational risk measures"),
     shinyjs::hidden(fluidRow(
    id = 'help_info_industry_summary',
        column(
      11,

p(size=14,"Data on workers from the 2016 Census was linked to measures of how often workers in each occupation are exposed to work conditions that put them at higher risk of COVID-19 from O*NET"),

tags$ul(
  tags$li(tags$b("Unable to work from home:")),
  tags$ul(
 tags$li("Occupations deemed unable to be performed at home")),
tags$li(tags$b("High Physical Proximity:")),
  tags$ul(
 tags$li("Score of 76 or higher for 'Physical Proxity to Others', equating to 'closer than moderately close, (e.g., arm’s length)'")),

tags$li(tags$b("High Exposure")),
  tags$ul(
 tags$li("Score of 51 or higher for 'Exposure to Disease or Infection', equating to 'more frequently than once a month'")),
)))
  ),

fluidRow(column(3,
                
    radioButtons("hr_question4", label=strong("Level of Geography"),
             choices=c("Provincial"=2,"Regional"=1),
             selected=2)),
    
 column(3,   conditionalPanel(
  condition = "input.hr_question4 == 2 ||input.hr_question4 == 1",
  selectInput("geog_prop",label=strong("Province/Territory"),
              choices=as.list(unique(regions_input$geography)),
              selected="Ontario"))),

column(3, 
conditionalPanel(
  condition = "input.hr_question4 == 1",
  conditionalPanel(
  condition = "input.geog_prop == 'Ontario'",
selectInput("on4",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="Ontario")$health_region)),
            selected="Toronto Public Health")
            )),
conditionalPanel(
  condition = "input.hr_question4 == 1",
conditionalPanel(
  condition = "input.geog_prop == 'British Columbia'",
selectInput("bc4",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="British Columbia")$health_region)),
            selected=1)
            )),

conditionalPanel(
  condition = "input.hr_question4 == 1",
  conditionalPanel(
  condition = "input.geog_prop == 'Alberta'",
selectInput("ab4",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="Alberta")$health_region)),
            selected=1)
            )),

conditionalPanel(
  condition = "input.hr_question4 == 1",
  conditionalPanel(
  condition = "input.geog_prop == 'Quebec'",
selectInput("qb4",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="Quebec")$health_region)),
            selected=1)
            )),
conditionalPanel(
  condition = "input.hr_question4 == 1",
  conditionalPanel(
  condition = "input.geog_prop == 'Newfoundland and Labrador'",
selectInput("nl4",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="Newfoundland and Labrador")$health_region)),
            selected=1)
            )),

conditionalPanel(
  condition = "input.hr_question4 == 1",
  conditionalPanel(
  condition = "input.geog_prop == 'Nova Scotia'",
selectInput("ns4",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="Nova Scotia")$health_region)),
            selected=1)
            )),

conditionalPanel(
  condition = "input.hr_question4 == 1",
  conditionalPanel(
  condition = "input.geog_prop == 'New Brunswick'",
selectInput("nb4",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="New Brunswick")$health_region)),
            selected=1)
            )),

conditionalPanel(
  condition = "input.hr_question4 == 1",
  conditionalPanel(
  condition = "input.geog_prop == 'Prince Edward Island'",
selectInput("pei4",label=strong("Health Region"),
            choices=as.list(unique(subset(regions_input,geography=="Prince Edward Island")$health_region)),
            selected=1)
            )),

conditionalPanel(
  condition = "input.hr_question4 == 1",
  conditionalPanel(
  condition = "input.geog_prop == 'Saskatchewan'",
selectInput("sk4",label=strong("Health Region"),
             choices=as.list(unique(subset(regions_input,geography=="Saskatchewan")$health_region)),
            selected=1)
            )),

conditionalPanel(
  condition = "input.hr_question4 == 1",
  conditionalPanel(
  condition = "input.geog_prop == 'Manitoba'",
selectInput("mb4",label=strong("Health Region"),
             choices=as.list(unique(subset(regions_input,geography=="Manitoba")$health_region)),
            selected=1)
            )),


conditionalPanel(
  condition = "input.hr_question4 == 1",
  conditionalPanel(
  condition = "input.geog_prop == 'Nunavut'",
selectInput("nu4",label=strong("Health Region"),
             choices=as.list(unique(subset(regions_input,geography=="Nunavut")$health_region)),
            selected=1)
            )),

conditionalPanel(
  condition = "input.hr_question4 == 1",
        conditionalPanel(
  condition = "input.geog_prop == 'Northwest Territories'",

selectInput("nt4",label=strong("Health Region"),
             choices=as.list(unique(subset(regions_input,geography=="Northwest Territories")$health_region)),
            selected=1)
            )),

conditionalPanel(
  condition = "input.hr_question4 == 1",
        conditionalPanel(
  condition = "input.geog_prop == 'Yukon'",
selectInput("yt4",label=strong("Health Region"),
             choices=as.list(unique(subset(regions_input,geography=="Yukon")$health_region)),
            selected=1)
            ))
)),

fluidRow(
column(3,
 (selectizeInput(inputId="naics_sector_search_prop",label=strong("Select Industry Sector"),
                        choices=as.list(unique(vismin_exposure_f$naics_sector_name)),
             selected="All Industry Sectors",multiple=T,options = list(maxItems = 1)))
),

conditionalPanel(
  condition = "input.hr_question4 == 2",
(column(3,
        (radioGroupButtons(inputId="choose_group",label=strong("Select Equity Stratifier (Provincial)"),
                        choices=c("Age", "Race/Ethnicity","Immigrant Status","Household Income"),
             selected=c("Age"),
             individual=T
       ))
        ))
),

conditionalPanel(
  condition = "input.hr_question4 == 1",
(column(3,
        (radioGroupButtons(inputId="choose_group_hr",label=strong("Select Equity Stratifier (Regional)"),
                        choices=c("Age", "Race/Ethnicity","Immigrant Status"),
             selected=c("Age"),
             individual=T
       ))
        ))
),


(column(3,
        (radioGroupButtons(inputId="choose_prop",label=strong("Select Occupational Risk Measure"),
                        choices=c("Unable to work from home","High Physical Proximity","High Exposure"),
             selected=c("Unable to work from home"),
             individual=T
       ))
        ))

),
fluidRow(column(10,div(style = "height:500px;", plotlyOutput("bar_chart"))))
)


```


```{r, echo=FALSE, include=FALSE, error=FALSE}
### Occupational Exposure Page
## Plot Tab


### data using only overall age & sex - for Occupations & comparisons tab
province_data_total <- reactive({
  if(!!as.name(input$hr_question) == 2 || !!as.name(input$hr_question3) == 2){
    if(!exists("table1_table2_datatool_total")){
      table1_table2_datatool_total <-  readRDS("table1_table2_final_total.rds")
    }else if(exists("table1_table2_datatool_total")){
      table1_table2_datatool_total <- table1_table2_datatool_total
    }
  }
})

regional_data_total <- reactive({        
  if(!!as.name(input$hr_question) == 1 || !!as.name(input$hr_question3) == 1){
    if(!exists("table3_datatool_total")){
      table3_datatool_total <-  readRDS("table3_final_total.rds")
    }else{
      table3_datatool_total <- table3_datatool_total}
  }
})

## equity stratifiers tab (need regional and provincial)  
province_data_social <- reactive ({
  if(!!as.name(input$hr_question2) == 2){
    if(!exists("table1_table2_datatool")){
      table1_table2_datatool <-  readRDS("table1_table2_final.rds")
    }else{
      return(table1_table2_datatool)
    }
    
  }
})  

regional_data_social <- reactive({        
  if(!!as.name(input$hr_question2) == 1){
    if(!exists("table3_datatool")){
      table3_datatool <-  readRDS("table3_final.rds")
    }else{
      table3_datatool <- table3_datatool
    }
  }
})


## visible minority & income tabs (only province)
province_data_vismin_income <- reactive ({
  if(!exists("table1_table2_datatool")){
    table1_table2_datatool <-  readRDS("table1_table2_final.rds")
  }else{
    return(table1_table2_datatool)
  }
})  




occupation_exposure <-
  reactive({
    if (!!as.name(input$hr_question) == 2) {
      
      occup_exp1 <-
        province_data_total() %>% filter(
          geography == as.character(input$geog) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
          &
            wfh_yes %in% input$telework_plot
        )
      
    } else if (!!as.name(input$hr_question) == 1) {
      
      if (!!as.name(input$geog) == 'Ontario') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$on) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
      
      else if (!!as.name(input$geog) == 'British Columbia') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$bc) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
      
      else if (!!as.name(input$geog) == 'Alberta') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$ab) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
      
      else if (!!as.name(input$geog) == 'Quebec') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$qb) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
      
      else if (!!as.name(input$geog) == 'Newfoundland and Labrador') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$nl) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
      
      else if (!!as.name(input$geog) == 'Nova Scotia') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$ns) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
      
      else if (!!as.name(input$geog) == 'New Brunswick') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$nb) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
      
      else if (!!as.name(input$geog) == 'Prince Edward Island') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$pei) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
      
      else if (!!as.name(input$geog) == 'Saskatchewan') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$sk) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
      
      else if (!!as.name(input$geog) == 'Manitoba') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$mb) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
      
      else if (!!as.name(input$geog) == 'Nunavut') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$nu) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
      
      else if (!!as.name(input$geog) == 'Northwest Territories') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$nt) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
      
      else if (!!as.name(input$geog) == 'Yukon') {
        occup_exp1 <-
          subset(
            regional_data_total(),
            geography == input$geog &
              health_region == as.character(input$yt) &
              industry == as.character(input$restrict)
            &
              naics_sector_name == input$naics_sector
            &
              wfh_yes %in% input$telework_plot
          )
      }
    }
    
    
  })

slider_occ_exp <-
  reactive ({
    if (!!as.name(input$slider) == 'Race/Ethnicity')
    {
      (
        ifelse(
          input$vismin[1] <= occupation_exposure()$percent_vismin
          &
            input$vismin[2] >= occupation_exposure()$percent_vismin
          ,
          "Yes",
          "No"
        )
      )
    }
    
    # else if (!!as.name(input$slider) == 2)
    # {(ifelse(input$lowinc[1] <= occupation_exposure()$percent_quintile1
    #          & input$lowinc[2] >= occupation_exposure()$percent_quintile1
    #          ,
    #          "Yes","No"))
    # }
    
    else if (!!as.name(input$slider) == 'Immigrant Status')
    {
      (
        ifelse(
          input$immigrant[1] <= occupation_exposure()$percent_immig
          &
            input$immigrant[2] >= occupation_exposure()$percent_immig
          ,
          "Yes",
          "No"
        )
      )
      
      
    }
    else if (!!as.name(input$slider) == 'Female')
    {
      (
        ifelse(
          input$female[1] <= occupation_exposure()$overall_percent_female
          &
            input$female[2] >= occupation_exposure()$overall_percent_female
          ,
          "Yes",
          "No"
        )
      )
      
    }
    
    else if (!!as.name(input$slider) == '65+ years')
    {
      (
        ifelse(
          input$ageold[1] <= occupation_exposure()$overall_percent_65
          &
            input$ageold[2] >= occupation_exposure()$overall_percent_65
          ,
          "Yes",
          "No"
        )
      )
      
    }
    
    else if (!!as.name(input$slider) == 'Median Income')
    {
      (
        ifelse(
          input$med_inc[1] <= occupation_exposure()$median_income
          &
            input$med_inc[2] >= occupation_exposure()$median_income
          ,
          "Yes",
          "No"
        )
      )
      
    }
    
    else if (!!as.name(input$slider) == 'All')
    {
      (
        ifelse(
          input$vismin[1] <= occupation_exposure()$percent_vismin
          &
            input$vismin[2] >= occupation_exposure()$percent_vismin
          &
            input$immigrant[1] <= occupation_exposure()$percent_immig
          &
            input$immigrant[2] >= occupation_exposure()$percent_immig
          &
            input$female[1] <= occupation_exposure()$overall_percent_female
          &
            input$female[2] >= occupation_exposure()$overall_percent_female
          &
            input$ageold[1] <= occupation_exposure()$overall_percent_65
          &
            input$ageold[2] >= occupation_exposure()$overall_percent_65
          &
            input$med_inc[1] <= occupation_exposure()$median_income
          &
            input$med_inc[2] >= occupation_exposure()$median_income
          ,
          "Yes",
          "No"
        )
      )
    }
    
    
  })
x_labels <- reactive ({
  if (!!as.name(input$xaxis) == "median_income_plot") {
    scale_labs_x <- median_inc_x
  }
  else if (!!as.name(input$xaxis) == "exposure") {
    scale_labs_x <- exposure_x
  }
  else if (!!as.name(input$xaxis) == "phys_prox") {
    scale_labs_x <- phys_prox_x
  }
  else if (!!as.name(input$xaxis) == "noc_broad_descript") {
    scale_labs_x <- sector_x
    axis_text <- theme(axis.text.x = element_text(angle = 45))
  }
  else if (!!as.name(input$xaxis) == "public_importance") {
    scale_labs_x <- public_x
  }
  
  else if (!!as.name(input$xaxis) == "indoors_controlled") {
    scale_labs_x <- indoors_controlled_x
  }
  else if (!!as.name(input$xaxis) == "indoors_not_controlled") {
    scale_labs_x <- indoors_not_controlled_x
  }
  else if (!!as.name(input$xaxis) == "contact_others") {
    scale_labs_x <- contact_others_x
  }
  
})

y_labels <- reactive ({
  # Change y-axis information based on input$yaxis variable
  if (!!as.name(input$yaxis) == "median_income_plot") {
    scale_labs_y <- median_inc_y
    
  }
  else if (!!as.name(input$yaxis) == "exposure") {
    scale_labs_y <- exposure_y
    
  }
  else if (!!as.name(input$yaxis) == "phys_prox") {
    scale_labs_y <- phys_prox_y
    
  }
  else if (!!as.name(input$yaxis) == "noc_broad_descript") {
    scale_labs_y <- sector_y
    
  }
  else if (!!as.name(input$yaxis) == "public_importance") {
    scale_labs_y <- public_y
    
  }
  
  else if (!!as.name(input$yaxis) == "indoors_controlled") {
    scale_labs_y <- indoors_controlled_y
    
  }
  else if (!!as.name(input$yaxis) == "indoors_not_controlled") {
    scale_labs_y <- indoors_not_controlled_y
    
  }
  else if (!!as.name(input$yaxis) == "contact_others") {
    scale_labs_y <- contact_others_y
    
  }
  
})


hr_text_output <- reactive ({
  if (!!as.name(input$hr_question) == 1) {
    if (!!as.name(input$geog) == 'Ontario') {
      text <- input$on
    }
    
    else if (!!as.name(input$geog) == 'British Columbia') {
      text <- input$bc
    }
    else if (!!as.name(input$geog) == 'Alberta') {
      text <- input$ab
    }
    
    else if (!!as.name(input$geog) == 'Quebec') {
      text <- input$qb
    }
    else if (!!as.name(input$geog) == 'Newfoundland and Labrador') {
      text <- input$nl
    }
    
    else if (!!as.name(input$geog) == 'Nova Scotia') {
      text <- input$ns
    }
    
    else if (!!as.name(input$geog) == 'New Brunswick') {
      text <- input$nb
    }
    
    else if (!!as.name(input$geog) == 'Prince Edward Island') {
      text <- input$pei
    }
    
    else if (!!as.name(input$geog) == 'Saskatchewan') {
      text <- input$sk
    }
    
    else if (!!as.name(input$geog) == 'Manitoba') {
      text <- input$mb
    }
    
    else if (!!as.name(input$geog) == 'Nunavut') {
      text <- input$nu
    }
    
    else if (!!as.name(input$geog) == 'Northwest Territories') {
      text <- input$nt
    }
    
    else if (!!as.name(input$geog) == 'Yukon') {
      text <- input$yt
    }
  }
})

observeEvent(input$help_button, {
  toggle("help_info")
})

output$province_text <- renderText ({
  input$geog
})
output$region_text <- renderText ({
  hr_text_output()
})
output$workforce_text <- renderText({
  input$restrict
})
output$slider_text <- renderText({
  input$slider
})
output$sector_text <- renderText({
  input$naics_sector
})


# occupation_exposure2 <- reactive({
#   if(is.null(occupation_exposure())){
#     data <- 0
#   }else{
#     data <- occupation_exposure()
#   }
# })


output$occ_exp_plot <- renderPlotly({
  
  
  
  # Change hover label information
  hoverlab_pop <- paste(
    "<b>",
    occupation_exposure()$noc_code_class,
    "</b>",
    "<br>",
    "<br>" ,
    "<b>In Occupation:</b>",
    comma(occupation_exposure()$sum_total1),
    "<br>",
    "<b>Female (%):</b>",
    occupation_exposure()$overall_percent_female,
    "<br>",
    "<b>65 years and over (%):</b>",
    occupation_exposure()$overall_percent_65,
    "<br>",
    "<b>Visible Minority (%):</b>",
    occupation_exposure()$percent_vismin,
    "<br>",
    "<b>Immigrant (%):</b>",
    occupation_exposure()$percent_immig,
    "<br>",
    "<b>Income Quintile 1 (%):</b>",
    occupation_exposure()$percent_quintile1,
    "<br>",
    "<b>Median Income (2015CAD):</b>",
    dollar(occupation_exposure()$median_income),
    "<br>",
    "<b>Physical Proximity:</b>",
    occupation_exposure()$phys_prox,
    "<br>",
    "<b>Exposure:</b>",
    occupation_exposure()$exposure,
    "<br>",
    "<b>Contact with Others:</b>",
    occupation_exposure()$contact_others,
    "<br>",
    "<b>Interacting with Public - Importance:</b>",
    occupation_exposure()$public_importance,
    "<br>",
    "<b>Indoors, Controlled:</b>",
    occupation_exposure()$indoors_controlled,
    "<br>",
    "<b>Indoors, Not Controlled:</b>",
    occupation_exposure()$indoors_not_controlled
  )
  
  high_light <- highlight_key(occupation_exposure(), ~ noc_code_class)
  
  colour_options <- c("Yes",
                      "No")
  fillColours <-
    setNames(c("#0F80A7",
               "#FFFFFF")
             ,
             colour_options)
  
  s = input$occ_exp_table_rows_selected
  
  {
    return(plot <- ggplotly(
      ggplot(occupation_exposure()) +
        geom_point(
          aes(
            x = !!as.name(input$xaxis),
            y = !!as.name(input$yaxis),
            size = sum_total1,
            factor = noc_code_class,
            fill = slider_occ_exp(),
            text = hoverlab_pop
          )
        )+
        
        scale_size(range = c(0.5, 15), name = "size") +
        theme_bw() +
        theme(legend.position = "none") +
        theme(legend.title = element_blank()) +
        x_labels() +
        y_labels() +
        labs(
          legend = "Equity Stratifier",
          x = names(xaxis_options[which(xaxis_options == input$xaxis)]),
          y = names(yaxis_options[which(yaxis_options == input$yaxis)])
        ) +
        scale_fill_manual(values = fillColours),
      tooltip = 'text',
      hoveron = "fills"
    )
    %>%
      #  layout(legend = list(orientation = "v", x=100, y=0.5, itemsizing='constant'))
      # %>%
      # layout(
      # margin=list('l = 0, r = 200 't': 0, 'b': 0,
      # 'xaxis': {'automargin': True, 'title': 'X-AXIS'},
      # 'yaxis': {'automargin': True, 'title': 'Y-AXIS'},
      # 'paper_bgcolor': 'lightgray'
      #
      #    layout(margin=list(l =-50, r=-50, t=50,b=50,pad=4), yaxis=list(autosize=FALSE,automargin=T),title=list(autosize=FALSE,automargin=T))
      # %>%
      #   plotly::layout(dragmode = "select")
    # %>%
    highlight(
      on = "plotly_hover",
      off = "plotly_deselect",
      color = high_light$noc_broad_descript,
      opacityDim = getOption("opacityDim", 0.9)
    )
    %>%
      config(modeBarButtonsToRemove = c("hoverClosestCartesian", "hoverCompareCartesian","toggleSpikelines","lasso2d","select2d","autoScale2d"))
    %>% 
      event_register(event = "plotly_click")
    
    
    )
    
    # bscols(plot, DT::datatable(occupation_exposure()))
  }
  
  
  
})

# output$click <- renderPrint({
#     message('clicked')
#     d <- event_data("plotly_click")
#     if (!is.null(d)) d
#   })



### Occupational Exposure Page
## Interactive Table Tab

occupation_exposure_table <- reactive({
  if (!!as.name(input$hr_question) == 2) {
    occupation_exposure <-
      province_data_total() %>% filter(
        geography == as.character(input$geog) &
          industry == as.character(input$restrict)
        &
          naics_sector_name == input$naics_sector
      )
    
  } else if (!!as.name(input$hr_question) == 1) {
    if (!!as.name(input$geog) == 'Ontario') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$on) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
    
    else if (!!as.name(input$geog) == 'British Columbia') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$bc) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
    
    else if (!!as.name(input$geog) == 'Alberta') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$ab) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
    
    else if (!!as.name(input$geog) == 'Quebec') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$qb) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
    
    else if (!!as.name(input$geog) == 'Newfoundland and Labrador') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$nl) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
    
    else if (!!as.name(input$geog) == 'Nova Scotia') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$ns) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
    
    else if (!!as.name(input$geog) == 'New Brunswick') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$nb) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
    
    else if (!!as.name(input$geog) == 'Prince Edward Island') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$pei) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
    
    else if (!!as.name(input$geog) == 'Saskatchewan') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$sk) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
    
    else if (!!as.name(input$geog) == 'Manitoba') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$mb) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
    
    else if (!!as.name(input$geog) == 'Nunavut') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$nu) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
    
    else if (!!as.name(input$geog) == 'Northwest Territories') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$nt) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
    
    else if (!!as.name(input$geog) == 'Yukon') {
      occupation_exposure <-
        subset(
          regional_data_total(),
          geography == input$geog &
            health_region == as.character(input$yt) &
            industry == as.character(input$restrict)
          &
            naics_sector_name == input$naics_sector
        )
    }
  }
  
})
occupation_exposure_table2 <-
  reactive ({
    
    if (!!as.name(input$slider) == 'Race/Ethnicity') {
      occupation_exposure_table()[input$vismin[1] <= occupation_exposure_table()$percent_vismin
                                  &
                                    occupation_exposure_table()$percent_vismin <= input$vismin[2],]
    }


    # else if (!!as.name(input$slider) == 2){
    #    occupation_exposure_table()[
    #     input$lowinc[1] <= occupation_exposure_table()$percent_quintile1
    #     & occupation_exposure_table()$percent_quintile1 <= input$lowinc[2],]}


    else if (!!as.name(input$slider) == 'Immigrant Status') {
      occupation_exposure_table()[input$immigrant[1] <= occupation_exposure_table()$percent_immig
                                  &
                                    occupation_exposure_table()$percent_immig <= input$immigrant[2],]
    }

    else if (!!as.name(input$slider) == 'Female') {
      occupation_exposure_table()[input$female[1] <= occupation_exposure_table()$overall_percent_female
                                  &
                                    occupation_exposure_table()$overall_percent_female <= input$female[2],]
    }


    else if (!!as.name(input$slider) == '65+ years') {
      occupation_exposure_table()[input$ageold[1] <= occupation_exposure_table()$overall_percent_65
                                  &
                                    occupation_exposure_table()$overall_percent_65 <= input$ageold[2],]
    }

    else if (!!as.name(input$slider) == 'Median Income') {
      occupation_exposure_table()[input$med_inc[1] <= occupation_exposure_table()$median_income
                                  &
                                    input$med_inc[2] >= occupation_exposure_table()$median_income,]
    }

    else if (!!as.name(input$slider) == 'All') {
      occupation_exposure_table()[input$vismin[1] <= occupation_exposure_table()$percent_vismin
                                  &
                                    input$vismin[2] >= occupation_exposure_table()$percent_vismin
                                  #  & input$lowinc[1] <=occupation_exposure_table()$percent_quintile1
                                  # & input$lowinc[2] >=occupation_exposure_table()$percent_quintile1
                                  &
                                    input$immigrant[1] <= occupation_exposure_table()$percent_immig
                                  &
                                    input$immigrant[2] >= occupation_exposure_table()$percent_immig
                                  &
                                    input$female[1] <= occupation_exposure_table()$overall_percent_female
                                  &
                                    input$female[2] >= occupation_exposure_table()$overall_percent_female
                                  &
                                    input$ageold[1] <= occupation_exposure_table()$overall_percent_65
                                  &
                                    input$ageold[2] >= occupation_exposure_table()$overall_percent_65
                                  &
                                    input$med_inc[1] <= occupation_exposure_table()$median_income
                                  &
                                    input$med_inc[2] >= occupation_exposure_table()$median_income,]
    }
    
  })

hr_text_output_table <- reactive ({
  if (!!as.name(input$hr_question) == 1) {
    if (!!as.name(input$geog) == 'Ontario') {
      text <- input$on
    }
    
    else if (!!as.name(input$geog) == 'British Columbia') {
      text <- input$bc
    }
    else if (!!as.name(input$geog) == 'Alberta') {
      text <- input$ab
    }
    
    else if (!!as.name(input$geog) == 'Quebec') {
      text <- input$qb
    }
    else if (!!as.name(input$geog) == 'Newfoundland and Labrador') {
      text <- input$nl
    }
    
    else if (!!as.name(input$geog) == 'Nova Scotia') {
      text <- input$ns
    }
    
    else if (!!as.name(input$geog) == 'New Brunswick') {
      text <- input$nb
    }
    
    else if (!!as.name(input$geog) == 'Prince Edward Island') {
      text <- input$pei
    }
    
    else if (!!as.name(input$geog) == 'Saskatchewan') {
      text <- input$sk
    }
    
    else if (!!as.name(input$geog) == 'Manitoba') {
      text <- input$mb
    }
    
    else if (!!as.name(input$geog) == 'Nunavut') {
      text <- input$nu
    }
    
    else if (!!as.name(input$geog) == 'Northwest Territories') {
      text <- input$nt
    }
    
    else if (!!as.name(input$geog) == 'Yukon') {
      text <- input$yt
    }
  }
})

observeEvent(input$help_button_table, {
  toggle("help_info_table")
})

output$province_text_table <- renderText ({
  input$geog
})
output$region_text_table <- renderText ({
  hr_text_output_table()
})
output$workforce_text_table <- renderText({
  input$restrict
})
output$slider_text_table <- renderText({
  input$slider
})
output$sector_text_table <- renderText({
  input$naics_sector
})


occupation_exposure_table3 <- reactive({
  if (!!as.name(input$hr_question) == 2) {
    table_tab <- occupation_exposure_table2() %>%
      select(
        noc_code_class,
        sum_total1,
        
        percent_vismin,
        percent_immig,
        percent_nonpermres,
        overall_percent_female,
        overall_percent_65,
        median_income,
        wfh_yes,
        exposure,
        phys_prox,
        contact_others,
        public_importance,
        indoors_controlled,
        indoors_not_controlled,
        noc_code
      ) %>%
      arrange(noc_code)
    
    #### reformat variables
    table_tab$median_income <- dollar(table_tab$median_income)
    table_tab$sum_total1 <- comma(table_tab$sum_total1)
    table_tab$wfh_yes=factor(table_tab$wfh_yes,
                             levels=c(0,
                                      1
                             ),
                             labels=c("No",
                                      "Yes"
                             ))
    
    table_tab <- plyr::rename(
      table_tab,
      c(
        "noc_code_class" = "Occupation",
        "noc_code" = "Occupation Code",
        "sum_total1" = "Total (N)",
        "exposure" = "Exposure to Disease",
        "phys_prox" = "Physical Proximity",
        "contact_others" = "Contact with Others",
        "public_importance" = "Interacting with Public",
        "indoors_controlled" = "Indoors, Controlled",
        "indoors_not_controlled" = "Indoors, Not Controlled",
        "overall_percent_female" = "Female (%)",
        "percent_vismin" = "Visible Minority (%)",
        "percent_immig" = "Immigrant (%)",
        "percent_nonpermres" = "Non-Permanent Resident (%)",
        "overall_percent_65" = "65+ years (%)",
        "median_income" = "Median Income (CAD)",
        "wfh_yes"="Work from home"
      )
    )
    
  } else if (!!as.name(input$hr_question) == 1) {
    table_tab <- occupation_exposure_table2() %>%
      select(
        noc_code_class,
        sum_total1,
       
        percent_vismin,
        # percent_quintile1,
        percent_immig,
        percent_nonpermres,
        overall_percent_female,
        overall_percent_65,
         median_income,
        wfh_yes,
        exposure,
        phys_prox,
        contact_others,
        public_importance,
        indoors_controlled,
        indoors_not_controlled,
        noc_code
      ) %>%
      arrange(noc_code)
    
    #### reformat variables
    table_tab$median_income <- dollar(table_tab$median_income)
    table_tab$sum_total1 <- comma(table_tab$sum_total1)
    
    table_tab$wfh_yes=factor(table_tab$wfh_yes,
                             levels=c(0,
                                      1
                             ),
                             labels=c("No",
                                      "Yes"
                             ))
    
    table_tab <- plyr::rename(
      table_tab,
      c(
        "noc_code_class" = "Occupation",
        "noc_code" = "Occupation Code",
        "sum_total1" = "Total (N)",
        "exposure" = "Exposure to Disease",
        "phys_prox" = "Physical Proximity",
        "contact_others" = "Contact with Others",
        "public_importance" = "Interacting with Public",
        "indoors_controlled" = "Indoors, Controlled",
        "indoors_not_controlled" = "Indoors, Not Controlled",
        "overall_percent_female" = "Female (%)",
        "percent_vismin" = "Visible Minority (%)",
        # "percent_quintile1"="Income Quintile 1 (%)",
        "percent_immig" = "Immigrant (%)",
        "percent_nonpermres" = "Non-Permanent Resident (%)",
        "overall_percent_65" = "65+ years (%)",
        "median_income" = "Median Income (CAD)",
        "wfh_yes" = "Work from Home"
      )
    )
  }
})



output$occ_exp_table <- renderDT(server = FALSE,
                                 {
                                   DT::datatable(
                                     occupation_exposure_table3(),
                                     rownames = F,
                                     extensions = 'Buttons',
                                     
                                     options = list(
                                       fixedColumns = TRUE,
                                       autoWidth = T,
                                       dom = 'Bfrtip',
                                       buttons = list(list(extend=('csv'),text="Download")),
                                       scrollY = "500px",
                                       scrollX = TRUE,
                                       
                                       deferRender = T,
                                       paging = TRUE,
                                       columnDefs = list(
                                         list(
                                           width = '300px',
                                           className = 'dt-body-left',
                                           targets = 0
                                         ),
                                         list(className = 'dt-body-center', targets = 1:14),
                                         # list(width='300px',className = 'dt-head-left', targets = 0),
                                         list(className = 'dt-head-left', targets = "_all"),
                                         list(className = 'dt-nowrap', targets = 0)
                                       )
                                     )
                                     
                                     ,
                                     fillContainer = T
                                   )
                                 })

proxy = dataTableProxy('occ_exp_table')
observeEvent(input$plotly_click, {
  removeRow <- as.numeric(row.names(nearPoints(cars, input$plot_click, xvar = "speed", yvar = "dist")))
  selectRows(proxy, input$occ_exp_table_rows_selected)
})
#########################

#### equity stratifiers tab
social_plot <-
  reactive({
    if (!!as.name(input$hr_question2) == 2) {
      if (input$selected_char == 'sum_total1') {
        social1 <- subset(
          province_data_social(),
          geography == input$geog2 &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age %in% as.character(input$age_choose) &
            sum_total1 > 0
          &
            naics_sector_name == input$naics_sector2
          &
            wfh_yes %in% input$telework_plot2
        )
      }
      else if (input$selected_char == 'sum_vismin1') {
        social1 <- subset(
          province_data_social(),
          geography == input$geog2 &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age %in% as.character(input$age_choose) &
            sum_vismin1 > 0
          &
            naics_sector_name == input$naics_sector2
          &
            wfh_yes %in% input$telework_plot2
        )
      }
      
      else if (input$selected_char == 'sum_immig1') {
        social1 <- subset(
          province_data_social(),
          geography == input$geog2 &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age %in% as.character(input$age_choose) &
            sum_immig1 > 0
          &
            naics_sector_name == input$naics_sector2
          &
            wfh_yes %in% input$telework_plot2
        )
      }
      else if (input$selected_char == 'sum_nonpermres1') {
        social1 <- subset(
          province_data_social(),
          geography == input$geog2 &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age %in% as.character(input$age_choose) &
            sum_nonpermres1 > 0
          &
            naics_sector_name == input$naics_sector2
          &
            wfh_yes %in% input$telework_plot2
        )
      }
      else if (input$selected_char == 'sum_white1') {
        social1 <- subset(
          province_data_social(),
          geography == input$geog2 &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age %in% as.character(input$age_choose) &
            sum_white1 > 0
          &
            naics_sector_name == input$naics_sector2
          &
            wfh_yes %in% input$telework_plot2
        )
      }
      else if (input$selected_char == 'sum_nonimmig1') {
        social1 <- subset(
          province_data_social(),
          geography == input$geog2 &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age %in% as.character(input$age_choose) &
            sum_nonimmig1 > 0
          &
            naics_sector_name == input$naics_sector2
          &
            wfh_yes %in% input$telework_plot2
        )
      }
    }
    else if (!!as.name(input$hr_question2) == 1) {
      if (!!as.name(input$geog2) == 'Ontario') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$on2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_total1 > 0
            &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$on2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$on2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$on2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$on2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$on2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
      else if (!!as.name(input$geog2) == 'British Columbia') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$bc2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_total1 > 0
            &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$bc2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$bc2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$bc2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$bc2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$bc2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
      else if (!!as.name(input$geog2) == 'Alberta') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ab2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ab2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ab2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ab2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ab2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ab2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
      else if (!!as.name(input$geog2) == 'Quebec') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$qb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$qb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$qb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$qb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$qb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$qb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
      else if (!!as.name(input$geog2) == 'New Brunswick') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
      
      else if (!!as.name(input$geog2) == 'Nova Scotia') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ns2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ns2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ns2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ns2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ns2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ns2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
      else if (!!as.name(input$geog2) == 'Newfoundland and Labrador') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nl2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nl2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nl2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nl2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nl2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nl2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
      
      else if (!!as.name(input$geog2) == 'Prince Edward Island') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$pei2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$pei2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$pei2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$pei2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$pei2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$pei2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
      else if (!!as.name(input$geog2) == 'Saskatchewan') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$sk2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$sk2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$sk2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$sk2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$sk2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$sk2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
      else if (!!as.name(input$geog2) == 'Manitoba') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$mb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$mb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$mb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$sk2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$mb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$mb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
      else if (!!as.name(input$geog2) == 'Nunavut') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nu2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nu2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nu2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nu2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nu2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nu2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
      else if (!!as.name(input$geog2) == 'Northwest Territories') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
      else if (!!as.name(input$geog2) == 'Yukon') {
        if (input$selected_char == 'sum_total1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$yt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_vismin1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$yt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_vismin1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        
        else if (input$selected_char == 'sum_immig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$yt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_immig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonpermres1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$yt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonpermres1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_white1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$yt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_white1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
        else if (input$selected_char == 'sum_nonimmig1') {
          social1 <- subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$yt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) &
              sum_nonimmig1 > 0
            & naics_sector_name == input$naics_sector2
            &
              wfh_yes %in% input$telework_plot2
          )
        }
      }
    }
  })



x_labels_2 <- reactive ({
  # Change x-axis information based on input$xaxis_hr2 variable
  if (!!as.name(input$xaxis_2) == "median_income_plot") {
    scale_labs_x <- median_inc_x
  }
  else if (!!as.name(input$xaxis_2) == "exposure") {
    scale_labs_x <- exposure_x
  }
  else if (!!as.name(input$xaxis_2) == "phys_prox") {
    scale_labs_x <- phys_prox_x
  }
  else if (!!as.name(input$xaxis_2) == "noc_broad_descript") {
    scale_labs_x <- sector_x
    axis_text <- theme(axis.text.x = element_text(angle = 45))
  }
  else if (!!as.name(input$xaxis_2) == "public_importance") {
    scale_labs_x <- public_x
  }
  
  else if (!!as.name(input$xaxis_2) == "indoors_controlled") {
    scale_labs_x <- indoors_controlled_x
  }
  else if (!!as.name(input$xaxis_2) == "indoors_not_controlled") {
    scale_labs_x <- indoors_not_controlled_x
  }
  else if (!!as.name(input$xaxis_2) == "contact_others") {
    scale_labs_x <- contact_others_x
  }
  
})

y_labels_2 <- reactive ({
  # Change y-axis information based on input$yaxis_2 variable
  if (!!as.name(input$yaxis_2) == "median_income_plot") {
    scale_labs_y <- median_inc_y
  }
  else if (!!as.name(input$yaxis_2) == "exposure") {
    scale_labs_y <- exposure_y
  }
  else if (!!as.name(input$yaxis_2) == "phys_prox") {
    scale_labs_y <- phys_prox_y
  }
  else if (!!as.name(input$yaxis_2) == "noc_broad_descript") {
    scale_labs_y <- sector_y
  }
  else if (!!as.name(input$yaxis_2) == "public_importance") {
    scale_labs_y <- public_y
  }
  
  else if (!!as.name(input$yaxis_2) == "indoors_controlled") {
    scale_labs_y <- indoors_controlled_y
  }
  else if (!!as.name(input$yaxis_2) == "indoors_not_controlled") {
    scale_labs_y <- indoors_not_controlled_y
  }
  else if (!!as.name(input$yaxis_2) == "contact_others") {
    scale_labs_y <- contact_others_y
  }
})


hover_label_function_social <- reactive({
  if (input$selected_char == "sum_total1") {
    hoverlab_social <-
      paste(
        "<b>",
        social_plot()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(social_plot()$sum_total1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(social_plot()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        social_plot()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        social_plot()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        social_plot()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        social_plot()$public_importance,
        "<br>",
        "<b>Indoors, Controlled:</b>",
        social_plot()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        social_plot()$indoors_not_controlled,
        "<br>"
      )
  }
  
  else if (input$selected_char == "sum_vismin1") {
    hoverlab_social <-
      paste(
        "<b>",
        social_plot()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(social_plot()$sum_vismin1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(social_plot()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        social_plot()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        social_plot()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        social_plot()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        social_plot()$public_importance,
        "<br>",
        "<b>Indoors, Controlled:</b>",
        social_plot()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        social_plot()$indoors_not_controlled,
        "<br>"
      )
  }
  
  else if (input$selected_char == "sum_immig1") {
    hoverlab_social <-
      paste(
        "<b>",
        social_plot()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(social_plot()$sum_immig1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(social_plot()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        social_plot()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        social_plot()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        social_plot()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        social_plot()$public_importance,
        "<br>",
        "<b>Indoors, Controlled:</b>",
        social_plot()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        social_plot()$indoors_not_controlled,
        "<br>"
      )
  }
  
  else if (input$selected_char == "sum_nonpermres1") {
    hoverlab_social <-
      paste(
        "<b>",
        social_plot()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(social_plot()$sum_nonpermres1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(social_plot()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        social_plot()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        social_plot()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        social_plot()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        social_plot()$public_importance,
        "<br>",
        "<b>Indoors, Controlled:</b>",
        social_plot()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        social_plot()$indoors_not_controlled,
        "<br>"
      )
  }
  
  else if (input$selected_char == "sum_white1") {
    hoverlab_social <-
      paste(
        "<b>",
        social_plot()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(social_plot()$sum_white1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(social_plot()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        social_plot()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        social_plot()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        social_plot()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        social_plot()$public_importance,
        "<br>",
        "<b>Indoors, Controlled:</b>",
        social_plot()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        social_plot()$indoors_not_controlled,
        "<br>"
      )
  }
  else if (input$selected_char == "sum_nonimmig1") {
    hoverlab_social <-
      paste(
        "<b>",
        social_plot()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(social_plot()$sum_nonimmig1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(social_plot()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        social_plot()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        social_plot()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        social_plot()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        social_plot()$public_importance,
        "<br>",
        "<b>Indoors, Controlled:</b>",
        social_plot()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        social_plot()$indoors_not_controlled,
        "<br>"
      )
  }
  
  
})



slider_social <-
  reactive ({
    ifelse((!(
      social_plot()$noc_broad %in% input$noc_broad_choose
    )),
    "Not Selected",
    ifelse(
      social_plot()$noc_broad %in% 0,
      "Management",
      ifelse(
        social_plot()$noc_broad %in% 1,
        "Business",
        ifelse(
          social_plot()$noc_broad %in% 2,
          "Sciences",
          ifelse(
            social_plot()$noc_broad %in% 3,
            "Health",
            ifelse(
              social_plot()$noc_broad %in% 4,
              "Community",
              ifelse(
                social_plot()$noc_broad %in% 5,
                "Culture",
                ifelse(
                  social_plot()$noc_broad %in% 6,
                  "Sales",
                  ifelse(
                    social_plot()$noc_broad %in% 7,
                    "Trades",
                    ifelse(
                      social_plot()$noc_broad %in% 8,
                      "Agriculture",
                      ifelse(social_plot()$noc_broad %in% 9, "Utilities", "Not Selected")
                    )
                  )
                )
              )
            )
          )
        )
      )
    ))
    
    
    
  })

hr_text_output_social_plot <- reactive ({
  if (!!as.name(input$hr_question2) == 1) {
    if (!!as.name(input$geog2) == 'Ontario') {
      text <- input$on2
    }
    else if (!!as.name(input$geog2) == 'British Columbia') {
      text <- input$bc2
    }
    else if (!!as.name(input$geog2) == 'Alberta') {
      text <- input$ab2
    }
    
    else if (!!as.name(input$geog2) == 'Quebec') {
      text <- input$qb2
    }
    else if (!!as.name(input$geog2) == 'Newfoundland and Labrador') {
      text <- input$nl2
    }
    
    else if (!!as.name(input$geog2) == 'Nova Scotia') {
      text <- input$ns2
    }
    
    else if (!!as.name(input$geog2) == 'New Brunswick') {
      text <- input$nb2
    }
    
    else if (!!as.name(input$geog2) == 'Prince Edward Island') {
      text <- input$pei2
    }
    
    else if (!!as.name(input$geog2) == 'Saskatchewan') {
      text <- input$sk2
    }
    
    else if (!!as.name(input$geog2) == 'Manitoba') {
      text <- input$mb2
    }
    
    else if (!!as.name(input$geog2) == 'Nunavut') {
      text <- input$nu2
    }
    
    else if (!!as.name(input$geog2) == 'Northwest Territories') {
      text <- input$nt2
    }
    
    else if (!!as.name(input$geog2) == 'Yukon') {
      text <- input$yt2
    }
  }
})

observeEvent(input$help_button_social_plot, {
  toggle("help_info_social_plot")
})

output$province_text_social_plot <- renderText ({
  input$geog2
})
output$region_text_social_plot <-
  renderText ({
    hr_text_output_social_plot()
  })
output$workforce_text_social_plot <- renderText({
  input$restrict2
})
output$age_choose_text_social_plot <- renderText({
  input$age_choose
})
output$sex_choose_text_social_plot <- renderText({
  input$sex_choose
})
output$sector_text_social_plot <- renderText({
  input$naics_sector2
})


output$social_plot <- renderPlotly({
  # set Selected characteristics groups
  label_text_social <- reactive({
    hover_label_function_social()
    
  })
  
  high_light <- highlight_key(social_plot(), ~ noc_code_class)
  
  
  colour_options <- c(
    "Management",
    "Business",
    "Sciences",
    "Health",
    "Community",
    "Culture",
    "Sales",
    "Trades",
    "Agriculture",
    "Utilities",
    "Not Selected"
  )
  
  fillColours <-
    setNames(
      c(
        "#3D8704",
        "#0F80A7",
        "#68696D",
        "#80D4DF",
        "#008184",
        "#693A77",
        "#FC7530",
        "#B7D9E5",
        "#CDE4BA",
        "#C8C8C8",
        "#FFFFFF"
      )
      ,
      colour_options
    )
  # print(fillColours)
  fillColours <- fillColours[c(
    "Management",
    "Business",
    "Sciences",
    "Health",
    "Community",
    "Culture",
    "Sales",
    "Trades",
    "Agriculture",
    "Utilities",
    "Not Selected"
  )
  ]
  {
    return(
      ggplotly(
        ggplot(high_light) +
          geom_point(
            aes(
              x = !!as.name(input$xaxis_2),
              y = !!as.name(input$yaxis_2),
              size = !!as.name(input$selected_char),
              factor = noc_code_class,
              fill = slider_social(),
              text = label_text_social(),
              
            )
          ) +
          scale_size(range = c(0.5, 15)) +
          theme_bw() +
          theme(legend.position = "hide") +
          theme(legend.title = element_blank()) +
          x_labels_2() +
          y_labels_2() +
          labs(
            x = names(xaxis_options[which(xaxis_options == input$xaxis_2)]),
            y = names(yaxis_options[which(yaxis_options == input$yaxis_2)])
          ) +
          scale_fill_manual(values = fillColours)
        
        ,
        tooltip = 'text'
      )
      %>%
        layout(
          legend = list(
            orientation = "v",
            x = 100,
            y = 0.5,
            itemsizing = 'constant'
          )
        )
      # %>%
      #   plotly::layout(dragmode = "zoom")
      %>%
        highlight(
          on = "plotly_hover",
          off = "plotly_deselect",
          color = high_light$noc_broad_descript,
          opacityDim = getOption("opacityDim", 1)
        )
      %>%
        config(modeBarButtonsToRemove = c("hoverClosestCartesian", "hoverCompareCartesian","toggleSpikelines","lasso2d","select2d","autoScale2d"))
      
    )
    
  }
})

### Table

hr_text_output_social_table <- reactive ({
  if (!!as.name(input$hr_question2) == 1) {
    if (!!as.name(input$geog2) == 'Ontario') {
      text <- input$on2
    }
    else if (!!as.name(input$geog2) == 'British Columbia') {
      text <- input$bc2
    }
    else if (!!as.name(input$geog2) == 'Alberta') {
      text <- input$ab2
    }
    
    else if (!!as.name(input$geog2) == 'Quebec') {
      text <- input$qb2
    }
    else if (!!as.name(input$geog2) == 'Newfoundland and Labrador') {
      text <- input$nl2
    }
    
    else if (!!as.name(input$geog2) == 'Nova Scotia') {
      text <- input$ns2
    }
    
    else if (!!as.name(input$geog2) == 'New Brunswick') {
      text <- input$nb2
    }
    
    else if (!!as.name(input$geog2) == 'Prince Edward Island') {
      text <- input$pei2
    }
    
    else if (!!as.name(input$geog2) == 'Saskatchewan') {
      text <- input$sk2
    }
    
    else if (!!as.name(input$geog2) == 'Manitoba') {
      text <- input$mb2
    }
    
    else if (!!as.name(input$geog2) == 'Nunavut') {
      text <- input$nu2
    }
    
    else if (!!as.name(input$geog2) == 'Northwest Territories') {
      text <- input$nt2
    }
    
    else if (!!as.name(input$geog2) == 'Yukon') {
      text <- input$yt2
    }
  }
})

observeEvent(input$help_button_social_table, {
  toggle("help_info_social_table")
})

output$province_text_social_table <- renderText ({
  input$geog2
})
output$region_text_social_table <-
  renderText ({
    hr_text_output_social_table()
  })
output$workforce_text_social_table <- renderText({
  input$restrict2
})
output$age_choose_text_social_table <- renderText({
  input$age_choose
})
output$sex_choose_text_social_table <- renderText({
  input$sex_choose
})
output$sector_text_social_table <- renderText({
  input$naics_sector2
})


social_table_f <- reactive({
  if (!!as.name(input$hr_question2) == 2) {
    social2 <-
      subset(
        province_data_social(),
        geography == input$geog2 &
          industry == as.character(input$restrict2) &
          sex == as.character(input$sex_choose) &
          age == as.character(input$age_choose)
        & naics_sector_name == input$naics_sector2
      )
    
    social3 <- social2 %>%
      select(
        noc_code_class,
        age,
        sex,
        sum_total1,
        sum_vismin1,
        sum_immig1,
        sum_nonpermres1,
        median_income,
        wfh_yes,
        exposure,
        phys_prox,
        contact_others,
        public_importance,
        indoors_controlled,
        indoors_not_controlled,
        noc_code
      )
    
    social3$median_income <- dollar(social3$median_income)
    social3$sum_total1 <- comma(social3$sum_total1)
    social3$sum_vismin1 <- comma(social3$sum_vismin1)
    social3$sum_immig1 <- comma(social3$sum_immig1)
    social3$sum_nonpermres1 <- comma(social3$sum_nonpermres1)
    
    social3$wfh_yes=factor(social3$wfh_yes,
                           levels=c(0,
                                    1
                           ),
                           labels=c("No",
                                    "Yes"
                           ))
    
    social3 <- plyr::rename(
      social3,
      c(
        "sex" = "Sex",
        "age" = "Age",
        "noc_code" = "Occupation Code",
        "noc_code_class" = "Occupation",
        "sum_total1" = "Total (N)",
        "sum_vismin1" = "Visible Minority (N)",
        "sum_immig1" = "Immigrant (N)",
        "sum_nonpermres1" = "Non-Permanent Resident (N)",
        "exposure" = "Exposure to Disease",
        "phys_prox" = "Physical Proximity",
        "contact_others" = "Contact with Others",
        "public_importance" = "Interacting with Public",
        "indoors_controlled" = "Indoors, Controlled",
        "indoors_not_controlled" = "Indoors, Not Controlled",
        "median_income" = "Median Income (CAD)",
        "wfh_yes" = "Work from Home"
      )
    )
    
    
  }
  else  if (!!as.name(input$hr_question2) == 1) {
    if (!!as.name(input$geog2) == 'Ontario') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$on2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
        )
    }
    else if (!!as.name(input$geog2) == 'British Columbia') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$bc2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
        )
    }
    else if (!!as.name(input$geog2) == 'Alberta') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$ab2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
          
        )
    }
    else if (!!as.name(input$geog2) == 'Quebec') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$qb2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
        )
    }
    else if (!!as.name(input$geog2) == 'Newfoundland and Labrador') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$nl2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
        )
    }
    else if (!!as.name(input$geog2) == 'Nova Scotia') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$ns2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
        )
    }
    else if (!!as.name(input$geog2) == 'New Brunswick') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$nb2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
        )
    }
    else if (!!as.name(input$geog2) == 'Prince Edward Island') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$pei2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
        )
    }
    else if (!!as.name(input$geog2) == 'Saskatchewan') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$sk2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
        )
    }
    else if (!!as.name(input$geog2) == 'Manitoba') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$mb2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
        )
    }
    else if (!!as.name(input$geog2) == 'Nunavut') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$nu2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
        )
    }
    else if (!!as.name(input$geog2) == 'Northwest Territories') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$nt2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
        )
    }
    else if (!!as.name(input$geog2) == 'Yukon') {
      social2 <-
        subset(
          regional_data_social(),
          geography == input$geog2 &
            health_region == as.character(input$yt2) &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose) &
            naics_sector_name == input$naics_sector2
        )
    }
    
    social3 <- social2 %>%
      select(
        noc_code_class,
        age,
        sex,
        sum_total1,
        sum_vismin1,
        sum_immig1,
        sum_nonpermres1,
        median_income,
        wfh_yes,
        exposure,
        phys_prox,
        contact_others,
        public_importance,
        indoors_controlled,
        indoors_not_controlled,
        noc_code
      )
    
    social3$median_income <- dollar(social3$median_income)
    social3$sum_total1 <- comma(social3$sum_total1)
    social3$sum_vismin1 <- comma(social3$sum_vismin1)
    social3$sum_immig1 <- comma(social3$sum_immig1)
    social3$sum_nonpermres1 <- comma(social3$sum_nonpermres1)
    
    social3$wfh_yes=factor(social3$wfh_yes,
                           levels=c(0,
                                    1
                           ),
                           labels=c("No",
                                    "Yes"
                           ))
    social3 <- plyr::rename(
      social3,
      c(
        "sex" = "Sex",
        "age" = "Age",
        "noc_code" = "Occupation Code",
        "noc_code_class" = "Occupation",
        "sum_total1" = "Total (N)",
        "sum_vismin1" = "Visible Minority (N)",
        "sum_immig1" = "Immigrant (N)",
        "sum_nonpermres1" = "Non-Permanent Resident (N)",
        "exposure" = "Exposure to Disease",
        "phys_prox" = "Physical Proximity",
        "contact_others" = "Contact with Others",
        "public_importance" = "Interacting with Public",
        "indoors_controlled" = "Indoors, Controlled",
        "indoors_not_controlled" = "Indoors, Not Controlled",
        "median_income" = "Median Income (CAD)",
        "wfh_yes" = "Work from Home"
      )
    )
    
    
  }
})



output$social_table <- DT::renderDataTable(server = FALSE, {
  DT::datatable(
    social_table_f(),
    rownames = F,
    extensions = 'Buttons',
    options = list(
      autoWidth = T,
      dom = 'Bfrtip',
      buttons = list(list(extend=('csv'),text="Download")),
      scrollY = "500px",
      scrollX = "500px",
      deferRender = TRUE,
      paging = TRUE,
      columnDefs = list(
        list(
          width = '300px',
          className = 'dt-body-left',
          targets = 0
        ),
        list(
          width = '100px',
          className = 'dt-left',
          targets = 1:2
        ),
        list(className = 'dt-center', targets = 3:14),
        list(className = 'dt-nowrap', targets = 0:2),
        list(className = 'dt-head-left', targets = "_all")
      )
    )
    
    ,
    fillContainer = T
  )
})




### summary table
hr_text_output_social_summary <- reactive ({
  if (!!as.name(input$hr_question2) == 1) {
    if (!!as.name(input$geog2) == 'Ontario') {
      text <- input$on2
    }
    else if (!!as.name(input$geog2) == 'British Columbia') {
      text <- input$bc2
    }
    else if (!!as.name(input$geog2) == 'Alberta') {
      text <- input$ab2
    }
    
    else if (!!as.name(input$geog2) == 'Quebec') {
      text <- input$qb2
    }
    else if (!!as.name(input$geog2) == 'Newfoundland and Labrador') {
      text <- input$nl2
    }
    
    else if (!!as.name(input$geog2) == 'Nova Scotia') {
      text <- input$ns2
    }
    
    else if (!!as.name(input$geog2) == 'New Brunswick') {
      text <- input$nb2
    }
    
    else if (!!as.name(input$geog2) == 'Prince Edward Island') {
      text <- input$pei2
    }
    
    else if (!!as.name(input$geog2) == 'Saskatchewan') {
      text <- input$sk2
    }
    
    else if (!!as.name(input$geog2) == 'Manitoba') {
      text <- input$mb2
    }
    
    else if (!!as.name(input$geog2) == 'Nunavut') {
      text <- input$nu2
    }
    
    else if (!!as.name(input$geog2) == 'Northwest Territories') {
      text <- input$nt2
    }
    
    else if (!!as.name(input$geog2) == 'Yukon') {
      text <- input$yt2
    }
  }
})
observeEvent(input$help_button_social_summary, {
  toggle("help_info_social_summary")
})

output$province_text_social_summary <- renderText ({
  input$geog2
})
output$region_text_social_summary <-
  renderText ({
    hr_text_output_social_summary()
  })
output$workforce_text_social_summary <-
  renderText({
    input$restrict2
  })
output$age_choose_text_social_summary <-
  renderText({
    input$age_choose
  })
output$sex_choose_text_social_summary <-
  renderText({
    input$sex_choose
  })
output$sector_text_social_summary <- renderText({
  input$naics_sector2
})


summary_social <-
  reactive({
    if (!!as.name(input$hr_question2) == 2) {
      summary_tab <-
        subset(
          province_data_social(),
          geography == input$geog2 &
            industry == as.character(input$restrict2) &
            sex == as.character(input$sex_choose) &
            age == as.character(input$age_choose)
          & naics_sector_name == input$naics_sector2
        )
      regions_social2 <- summary_tab %>%
        select(
          geography,
          industry,
          age,
          sex,
          sum_total1,
          sum_vismin1,
          
          sum_immig1,
          sum_nonpermres1,
          
          median_income,
          wfh_yes,
          exposure,
          phys_prox,
          contact_others,
          public_importance,
          indoors_controlled,
          indoors_not_controlled
        )
      
      regions_social3 <-
        regions_social2 %>% gather(
          selected_char,
          sum_total1_prov,
          sum_total1,
          sum_vismin1,
          
          sum_immig1,
          sum_nonpermres1
        )
      
      summary_table3 <- regions_social3 %>%
        group_by(geography, industry, sex, age, selected_char) %>%
        
        mutate(phys_prox = weighted.mean(phys_prox, sum_total1_prov, na.rm =
                                           TRUE)) %>%
        mutate(exposure = weighted.mean(exposure, sum_total1_prov, na.rm = TRUE)) %>%
        mutate(public_importance = weighted.mean(public_importance, sum_total1_prov, na.rm =
                                                   TRUE)) %>%
        mutate(contact_others = weighted.mean(contact_others, sum_total1_prov, na.rm =
                                                TRUE)) %>%
        mutate(indoors_controlled = weighted.mean(indoors_controlled, sum_total1_prov, na.rm =
                                                    TRUE)) %>%
        mutate(indoors_not_controlled = weighted.mean(indoors_not_controlled, sum_total1_prov, na.rm =
                                                        TRUE)) %>%
        mutate(median_income = weighted.mean(median_income, sum_total1_prov, na.rm =
                                               TRUE)) %>%
        mutate(sum_total1_prov = sum(sum_total1_prov)) %>%
        mutate_if(is.numeric, round, 0) %>%
        distinct(sex, age,selected_char,  .keep_all = TRUE) %>% ungroup()
      
      summary_table3_wfh <- regions_social3 %>% filter(wfh_yes == 1) %>%
        group_by(geography, industry, sex, age, selected_char) %>%
          mutate(sum_total1_prov_wfh_yes = sum(sum_total1_prov)) %>%
         distinct(sex, age,selected_char, .keep_all = TRUE) %>% ungroup() %>%
          select(geography, industry, sex, age, selected_char,sum_total1_prov_wfh_yes)
        
      summary_table3_f <- merge(summary_table3,summary_table3_wfh,by=c("geography", "industry", "sex", "age", "selected_char"))
      summary_table3_f$percent_wfh_yes <- summary_table3_f$sum_total1_prov_wfh_yes / summary_table3_f$sum_total1_prov * 100
      
      summary_table3 <- summary_table3_f %>% distinct(sex, age,selected_char, .keep_all = TRUE) %>% ungroup() %>% mutate_if(is.numeric,round,0)
      
      summary_table3$median_income <- dollar(summary_table3$median_income)
      summary_table3$sum_total1_prov <-
        comma(summary_table3$sum_total1_prov)
     
      summary_table3$selected_char = factor(
        summary_table3$selected_char,
        levels = c(
          "sum_total1",
          "sum_vismin1",
          "sum_immig1",
          "sum_nonpermres1"
        ),
        labels = c(
          "Total",
          "Visible Minority",
          "Immigrant",
          "Non-permanent Resident"
          
        )
      )
      
    
      summary_table3 <- summary_table3 %>% filter(sum_total1_prov > 0) %>%
        select(
          age,
          sex,
          selected_char,
          sum_total1_prov,
          median_income,
          percent_wfh_yes,
          exposure,
          phys_prox,
          contact_others,
          public_importance,
          indoors_controlled,
          indoors_not_controlled
        )
      
      
      
      summary_table3 <- plyr::rename(
        summary_table3,
        c(
          "sex" = "Sex",
          "age" = "Age",
          "percent_wfh_yes" = "Able to Work from Home (%)",
          "exposure" = "Exposure to Disease",
          "phys_prox" = "Physical Proximity",
          "contact_others" = "Contact with Others",
          "public_importance" = "Interacting with Public",
          "median_income" = "Median Income (2015 CAD)",
          "indoors_controlled" = "Indoors, Controlled",
          "indoors_not_controlled" = "Indoors, Not Controlled",
          "selected_char" = "Equity Stratifiers",
          "sum_total1_prov" = "Count (N)"
        )
      )
    }
    else if (!!as.name(input$hr_question2) == 1) {
      if (!!as.name(input$geog2) == 'Ontario') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$on2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      else if (!!as.name(input$geog2) == 'British Columbia') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$bc2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      else if (!!as.name(input$geog2) == 'Alberta') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ab2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      else if (!!as.name(input$geog2) == 'Quebec') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$qb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      else if (!!as.name(input$geog2) == 'Newfoundland and Labrador') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nl2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      else if (!!as.name(input$geog2) == 'Nova Scotia') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$ns2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      else if (!!as.name(input$geog2) == 'New Brunswick') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      else if (!!as.name(input$geog2) == 'Prince Edward Island') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$pei2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      else if (!!as.name(input$geog2) == 'Saskatchewan') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$sk2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      else if (!!as.name(input$geog2) == 'Manitoba') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$mb2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      else if (!!as.name(input$geog2) == 'Nunavut') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nu2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      else if (!!as.name(input$geog2) == 'Northwest Territories') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$nt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      else if (!!as.name(input$geog2) == 'Yukon') {
        summary_tab <-
          subset(
            regional_data_social(),
            geography == input$geog2 &
              health_region == as.character(input$yt2) &
              industry == as.character(input$restrict2) &
              sex == as.character(input$sex_choose) &
              age %in% as.character(input$age_choose) & sum_total1 > 0
            & naics_sector_name == input$naics_sector2
          )
      }
      
      regions_social2 <- summary_tab %>%
        select(
          health_region,
          industry,
          age,
          sex,
          sum_total1,
          sum_vismin1,
          
          sum_immig1,
          sum_nonpermres1,
          
          median_income,
          wfh_yes,
          exposure,
          phys_prox,
          contact_others,
          public_importance,
          indoors_controlled,
          indoors_not_controlled
        )
      
      regions_social3 <-
        regions_social2 %>% gather(
          selected_char,
          sum_total1_hr,
          sum_total1,
          sum_vismin1,
          sum_immig1,
          sum_nonpermres1,
        )
      
      summary_table3 <- regions_social3 %>%
        group_by(health_region, industry, sex, age, selected_char) %>%
        
        mutate(phys_prox = weighted.mean(phys_prox, sum_total1_hr, na.rm = TRUE)) %>%
        mutate(exposure = weighted.mean(exposure, sum_total1_hr, na.rm = TRUE)) %>%
        mutate(public_importance = weighted.mean(public_importance, sum_total1_hr, na.rm =
                                                   TRUE)) %>%
        mutate(contact_others = weighted.mean(contact_others, sum_total1_hr, na.rm =
                                                TRUE)) %>%
        mutate(indoors_controlled = weighted.mean(indoors_controlled, sum_total1_hr, na.rm =
                                                    TRUE)) %>%
        mutate(indoors_not_controlled = weighted.mean(indoors_not_controlled, sum_total1_hr, na.rm =
                                                        TRUE)) %>%
        mutate(median_income = weighted.mean(median_income, sum_total1_hr, na.rm =
                                               TRUE)) %>%
        mutate(sum_total1_hr = sum(sum_total1_hr)) %>%
        mutate_if(is.numeric, round, 0) %>%
        distinct(sex, age, selected_char, .keep_all = TRUE) %>% ungroup ()
      
      summary_table3_wfh <- regions_social3 %>% filter(wfh_yes == 1) %>%
        group_by(geography, industry, sex, age, selected_char) %>%
          mutate(sum_total1_hr_wfh_yes = sum(sum_total1_hr)) %>%
          distinct() %>%
          select(geography, industry, sex, age, selected_char,sum_total1_hr_wfh_yes)
        
      summary_table3_f <- merge(summary_table3,summary_table3_wfh,by=c("geography", "industry", "sex", "age", "selected_char"))
      summary_table3_f$percent_wfh_yes <- summary_table3_f$sum_total1_hr_wfh_yes / summary_table3_f$sum_total1_hr * 100
      
      summary_table3 <- summary_table3_f %>% distinct(sex, age,selected_char, .keep_all = TRUE) %>% ungroup() %>% mutate_if(is.numeric,round,0)
      
      summary_table3$median_income <- dollar(summary_table3$median_income)
      summary_table3$sum_total1_hr <- comma(summary_table3$sum_total1_hr)
      
      
      summary_table3$selected_char = factor(
        summary_table3$selected_char,
        levels = c(
          "sum_total1",
          "sum_vismin1",
          "sum_immig1",
          "sum_nonpermres1"
        ),
        labels = c(
          "Total",
          "Visible Minority",
          "Immigrant",
          "Non-permanent Resident"
          
        )
      )
      
      summary_table3 <- summary_table3 %>% filter(sum_total1_hr > 0) %>%
        select(
          age,
          sex,
          selected_char,
          sum_total1_hr,
          median_income,
          percent_wfh_yes,
          exposure,
          phys_prox,
          contact_others,
          public_importance,
          indoors_controlled,
          indoors_not_controlled,
        )
      
      
      
      summary_table3 <- plyr::rename(
        summary_table3,
        c(
          "sex" = "Sex",
          "age" = "Age",
          "percent_wfh_yes" = "Able to Work from Home (%)",
          "exposure" = "Exposure to Disease",
          "phys_prox" = "Physical Proximity",
          "contact_others"="Contact with Others",
          "public_importance" = "Interacting with Public",
          "median_income" = "Median Income (2015 CAD)",
          "indoors_controlled" = "Indoors, Controlled",
          "indoors_not_controlled" = "Indoors, Not Controlled",
          "selected_char" = "Equity Stratifiers",
          "sum_total1_hr" = "Count (N)"
        )
      )
    }
    
    
    
  })


output$b_summary_social <- DT::renderDataTable(server = FALSE, {
  DT::datatable(
    summary_social(),
    rownames = F,
    extensions = 'Buttons',
    
    options = list(
      autoWidth = T,
      dom = 'Bfrtip',
      buttons = list(list(extend=('csv'),text="Download")),
      scrollY = "500px",
      scrollX = "200px",
      deferRender = TRUE,
      paging = TRUE,
      columnDefs = list(
        list(
          width = '100px',
          className = 'dt-body-left',
          targets = 0:2
        ),
        list(className = 'dt-center', targets = 3:10),
        list(className = 'dt-nowrap', targets = 0:2),
        list(className = 'dt-head-left', targets = "_all")
      )
    )
    
    ,
    fillContainer = T
  )
})



### Visible Minority & Immigrant status tab
##Plot Tab

subset_all_vismin <-
  reactive({
    # if (input$user_select_dem == "Race/Ethnicity") {
    if (input$vis_groups == "sum_vismin1") {
      visible1 <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        &
          industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_vismin1 > 0
        & naics_sector_name == input$naics_sector_v
        &
          wfh_yes %in% input$telework_plot_v
      )
    }
    
    else if (input$vis_groups == "sum_southasia1") {
      visible1 <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        &
          industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_southasia1 > 0
        & naics_sector_name == input$naics_sector_v
        &
          wfh_yes %in% input$telework_plot_v
      )
    }
    
    else if (input$vis_groups == "sum_easteasia1") {
      visible1 <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        &
          industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_easteasia1 > 0
        & naics_sector_name == input$naics_sector_v
        &
          wfh_yes %in% input$telework_plot_v
      )
    }
    
    else if (input$vis_groups == "sum_black1") {
      visible1 <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        &
          industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_black1 > 0
        & naics_sector_name == input$naics_sector_v
        &
          wfh_yes %in% input$telework_plot_v
      )
    }
    
    else if (input$vis_groups == "sum_se_asia1") {
      visible1 <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        &
          industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_se_asia1 > 0
        & naics_sector_name == input$naics_sector_v
        &
          wfh_yes %in% input$telework_plot_v
      )
    }
    
    else if (input$vis_groups == "sum_latin1") {
      visible1 <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        &
          industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_latin1 > 0
        & naics_sector_name == input$naics_sector_v
        &
          wfh_yes %in% input$telework_plot_v
      )
    }
    
    
    else if (input$vis_groups == "sum_mideast1") {
      visible1 <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        &
          industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_mideast1 > 0
        & naics_sector_name == input$naics_sector_v
        &
          wfh_yes %in% input$telework_plot_v
      )
    }
    
    else if (input$vis_groups == "sum_nie1") {
      visible1 <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        &
          industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_nie1 > 0
        & naics_sector_name == input$naics_sector_v
        &
          wfh_yes %in% input$telework_plot_v
      )
    }
    
    else if (input$vis_groups == "sum_multivismin1") {
      visible1 <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        &
          industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_multivismin1 > 0
        & naics_sector_name == input$naics_sector_v
        &
          wfh_yes %in% input$telework_plot_v
      )
    }
    
    else if (input$vis_groups == "sum_white1") {
      visible1 <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        &
          industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_white1 > 0
        & naics_sector_name == input$naics_sector_v
        &
          wfh_yes %in% input$telework_plot_v
      )
    }
    
    
  })

x_labels_v <- reactive ({
  if (!!as.name(input$xaxis_v) == "median_income_plot") {
    scale_labs_x <- median_inc_x
  }
  else if (!!as.name(input$xaxis_v) == "exposure") {
    scale_labs_x <- exposure_x
  }
  else if (!!as.name(input$xaxis_v) == "phys_prox") {
    scale_labs_x <- phys_prox_x
  }
  else if (!!as.name(input$xaxis_v) == "noc_broad_descript") {
    scale_labs_x <- sector_x
    axis_text <- theme(axis.text.x = element_text(angle = 45))
  }
  else if (!!as.name(input$xaxis_v) == "public_importance") {
    scale_labs_x <- public_x
  }
  
  else if (!!as.name(input$xaxis_v) == "indoors_controlled") {
    scale_labs_x <- indoors_controlled_x
  }
  else if (!!as.name(input$xaxis_v) == "indoors_not_controlled") {
    scale_labs_x <- indoors_not_controlled_x
  }
  else if (!!as.name(input$xaxis_v) == "contact_others") {
    scale_labs_x <- contact_others_x
  }
})

y_labels_v <- reactive ({
  # Change y-axis information based on input$yaxis variable
  if (!!as.name(input$yaxis_v) == "median_income_plot") {
    scale_labs_y <- median_inc_y
  }
  else if (!!as.name(input$yaxis_v) == "exposure") {
    scale_labs_y <- exposure_y
  }
  else if (!!as.name(input$yaxis_v) == "phys_prox") {
    scale_labs_y <- phys_prox_y
  }
  else if (!!as.name(input$yaxis_v) == "noc_broad_descript") {
    scale_labs_y <- sector_y
  }
  else if (!!as.name(input$yaxis_v) == "public_importance") {
    scale_labs_y <- public_y
  }
  else if (!!as.name(input$yaxis_v) == "indoors_controlled") {
    scale_labs_y <- indoors_controlled_y
  }
  else if (!!as.name(input$yaxis_v) == "indoors_not_controlled") {
    scale_labs_y <- indoors_not_controlled_y
  }
  else if (!!as.name(input$yaxis_v) == "contact_others") {
    scale_labs_y <- contact_others_y
  }
  
})


hover_label_function_v <- reactive ({
  if (input$vis_groups == "sum_vismin1") {
    hoverlab_social <-
      paste(
        "<b>",
        subset_all_vismin()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(subset_all_vismin()$sum_vismin1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(subset_all_vismin()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        subset_all_vismin()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        subset_all_vismin()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        subset_all_vismin()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        subset_all_vismin()$public_importance,
        "<br>",
        "<b>Indoors, Controlled:</b>",
        subset_all_vismin()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        subset_all_vismin()$indoors_not_controlled
      )
  }
  
  
  else if (input$vis_groups == "sum_southasia1") {
    hoverlab_social <-
      paste(
        "<b>",
        subset_all_vismin()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(subset_all_vismin()$sum_southasia1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(subset_all_vismin()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        subset_all_vismin()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        subset_all_vismin()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        subset_all_vismin()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        subset_all_vismin()$public_importance,
        "<br>",
        "<b>Indoors, Controlled:</b>",
        subset_all_vismin()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        subset_all_vismin()$indoors_not_controlled
      )
  }
  
  else if (input$vis_groups == "sum_easteasia1") {
    hoverlab_social <-
      paste(
        "<b>",
        subset_all_vismin()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(subset_all_vismin()$sum_easteasia1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(subset_all_vismin()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        subset_all_vismin()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        subset_all_vismin()$exposure,
       "<br>",
        "<b>Contact with Others:</b>",
        subset_all_vismin()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        subset_all_vismin()$public_importance,
        "<br>",
        "<b>Indoors, Controlled:</b>",
        subset_all_vismin()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        subset_all_vismin()$indoors_not_controlled
      )
  }
  
  else if (input$vis_groups == "sum_black1") {
    hoverlab_social <-
      paste(
        "<b>",
        subset_all_vismin()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(subset_all_vismin()$sum_black1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(subset_all_vismin()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        subset_all_vismin()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        subset_all_vismin()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        subset_all_vismin()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        subset_all_vismin()$public_importance,
        "<br>",
        "<b>Indoors, Controlled:</b>",
        subset_all_vismin()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        subset_all_vismin()$indoors_not_controlled
      )
  }
  
  else if (input$vis_groups == "sum_se_asia1") {
    hoverlab_social <-
      paste(
        "<b>",
        subset_all_vismin()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(subset_all_vismin()$sum_se_asia1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(subset_all_vismin()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        subset_all_vismin()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        subset_all_vismin()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        subset_all_vismin()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        subset_all_vismin()$public_importance,
        "<br>",
        "<b>Indoors, Controlled:</b>",
        subset_all_vismin()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        subset_all_vismin()$indoors_not_controlled
      )
  }
  
  else if (input$vis_groups == "sum_latin1") {
    hoverlab_social <-
      paste(
        "<b>",
        subset_all_vismin()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(subset_all_vismin()$sum_latin1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(subset_all_vismin()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        subset_all_vismin()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        subset_all_vismin()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        subset_all_vismin()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        subset_all_vismin()$public_importance,
        "<br>",
        
        "<b>Indoors, Controlled:</b>",
        subset_all_vismin()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        subset_all_vismin()$indoors_not_controlled
      )
  }
  
  else if (input$vis_groups == "sum_mideast1") {
    hoverlab_social <-
      paste(
        "<b>",
        subset_all_vismin()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(subset_all_vismin()$sum_mideast1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(subset_all_vismin()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        subset_all_vismin()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        subset_all_vismin()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        subset_all_vismin()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        subset_all_vismin()$public_importance,
        "<br>",
        
        "<b>Indoors, Controlled:</b>",
        subset_all_vismin()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        subset_all_vismin()$indoors_not_controlled
      )
  }
  
  else if (input$vis_groups == "sum_nie1") {
    hoverlab_social <-
      paste(
        "<b>",
        subset_all_vismin()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(subset_all_vismin()$sum_nie1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(subset_all_vismin()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        subset_all_vismin()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        subset_all_vismin()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        subset_all_vismin()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        subset_all_vismin()$public_importance,
        "<br>",
        
        "<b>Indoors, Controlled:</b>",
        subset_all_vismin()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        subset_all_vismin()$indoors_not_controlled
      )
  }
  
  
  else if (input$vis_groups == "sum_multivismin1") {
    hoverlab_social <-
      paste(
        "<b>",
        subset_all_vismin()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(subset_all_vismin()$sum_multivismin1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(subset_all_vismin()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        subset_all_vismin()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        subset_all_vismin()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        subset_all_vismin()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        subset_all_vismin()$public_importance,
        "<br>",
        
        "<b>Indoors, Controlled:</b>",
        subset_all_vismin()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        subset_all_vismin()$indoors_not_controlled
      )
  }
  
  else if (input$vis_groups == "sum_white1") {
    hoverlab_social <-
      paste(
        "<b>",
        subset_all_vismin()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(subset_all_vismin()$sum_white1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(subset_all_vismin()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        subset_all_vismin()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        subset_all_vismin()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        subset_all_vismin()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        subset_all_vismin()$public_importance,
        "<br>",
        
        "<b>Indoors, Controlled:</b>",
        subset_all_vismin()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        subset_all_vismin()$indoors_not_controlled
      )
  }
  
  
})

slider_vismin <-
  reactive ({
    ifelse((!(
      subset_all_vismin()$noc_broad %in% input$noc_broad_choose_v
    )),
    "Not Selected",
    ifelse(
      subset_all_vismin()$noc_broad %in% 0,
      "Management",
      ifelse(
        subset_all_vismin()$noc_broad %in% 1,
        "Business",
        ifelse(
          subset_all_vismin()$noc_broad %in% 2,
          "Sciences",
          ifelse(
            subset_all_vismin()$noc_broad %in% 3,
            "Health",
            ifelse(
              subset_all_vismin()$noc_broad %in% 4,
              "Community",
              ifelse(
                subset_all_vismin()$noc_broad %in% 5,
                "Culture",
                ifelse(
                  subset_all_vismin()$noc_broad %in% 6,
                  "Sales",
                  ifelse(
                    subset_all_vismin()$noc_broad %in% 7,
                    "Trades",
                    ifelse(
                      subset_all_vismin()$noc_broad %in% 8,
                      "Agriculture",
                      ifelse(subset_all_vismin()$noc_broad %in% 9, "Utilities", "Not Selected")
                    )
                  )
                )
              )
            )
          )
        )
      )
    ))
    
  })

observeEvent(input$help_button_vismin_plot, {
  toggle("help_info_vismin_plot")
})

output$province_text_vismin_plot <- renderText ({
  input$geog_v
})
output$workforce_text_vismin_plot <- renderText({
  input$restrict_v
})
output$age_choose_text_vismin_plot <-
  renderText({
    input$age_choose_v
  })
output$sex_choose_text_vismin_plot <-
  renderText({
    input$sex_choose_v
  })
output$sector_text_vismin_plot <- renderText({
  input$naics_sector_v
})

output$vismin_plot <- renderPlotly({
  # set Selected characteristics groups
  label_text <- reactive({
    hover_label_function_v()
    
  })
  
  #subset_all_vismin_f <- reactive ({ subset(subset_all_vismin(), as.numeric(input$vis_groups) > 0) })
  
  high_light <- highlight_key(subset_all_vismin(), ~ noc_code_class)
  
  colour_options <- c(
    "Management",
    "Business",
    "Sciences",
    "Health",
    "Community",
    "Culture",
    "Sales",
    "Trades",
    "Agriculture",
    "Utilities",
    "Not Selected"
  )
  fillColours <-
    setNames(
      c(
        "#3D8704",
        "#0F80A7",
        "#68696D",
        "#80D4DF",
        "#008184",
        "#693A77",
        "#FC7530",
        "#B7D9E5",
        "#CDE4BA",
        "#C8C8C8",
        "#FFFFFF"
      )
      ,
      colour_options
    )
  {
    return(
      ggplotly(
        ggplot(high_light) +
          geom_point(
            aes(
              x = !!as.name(input$xaxis_v),
              y = !!as.name(input$yaxis_v),
              size = !!as.name(input$vis_groups),
              factor = noc_code_class,
              fill = slider_vismin(),
              text = label_text()
            )
          ) +
          scale_size(range = c(0.5, 15)) +
          theme_bw() +
          theme(legend.position = "bottom") +
          theme(legend.title = element_blank()) +
          x_labels_v() +
          y_labels_v() +
          labs(
            x = names(xaxis_options[which(xaxis_options == input$xaxis_v)]),
            y = names(yaxis_options[which(yaxis_options == input$yaxis_v)])
          ) +
          scale_fill_manual(
            values = fillColours)
        ,
        tooltip = 'text'
      )
      %>%
        layout(
          legend = list(
            orientation = "v",
            x = 100,
            y = 0.5,
            itemsizing = 'constant'
          )
        )
      %>%
        highlight(
          on = "plotly_hover",
          off = "plotly_deselect",
          color = high_light$noc_broad_descript,
          opacityDim = getOption("opacityDim", 1)
        )
      %>%
        config(modeBarButtonsToRemove = c("hoverClosestCartesian", "hoverCompareCartesian","toggleSpikelines","lasso2d","select2d","autoScale2d"))
      
      
    )
    
    }
})


### Visible Minority Page
## Table (for plot)

observeEvent(input$help_button_vismin_table, {
  toggle("help_info_vismin_table")
})

output$province_text_vismin_table <- renderText ({
  input$geog_v
})
output$workforce_text_vismin_table <- renderText({
  input$restrict_v
})
output$age_choose_text_vismin_table <-
  renderText({
    input$age_choose_v
  })
output$sex_choose_text_vismin_table <-
  renderText({
    input$sex_choose_v
  })
output$sector_text_vismin_table <- renderText({
  input$naics_sector_v
})


vismin_table <-
  reactive({
    
    if (input$vis_groups == "sum_vismin1") {
      table_visible <-  subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        & industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_vismin1 > 0
        & naics_sector_name == input$naics_sector_v
      )
    }
    
    else if (input$vis_groups == "sum_southasia1") {
      table_visible <-  subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        & industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_southasia1 > 0
        & naics_sector_name == input$naics_sector_v
      )
    }
    
    else if (input$vis_groups == "sum_easteasia1") {
      table_visible <-  subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        & industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_easteasia1 > 0
        & naics_sector_name == input$naics_sector_v
      )
    }
    
    else if (input$vis_groups == "sum_black1") {
      table_visible <-   subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        & industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_black1 > 0
        & naics_sector_name == input$naics_sector_v
      )
    }
    
    else if (input$vis_groups == "sum_se_asia1") {
      table_visible <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        & industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_se_asia1 > 0
        & naics_sector_name == input$naics_sector_v
      )
    }
    
    else if (input$vis_groups == "sum_latin1") {
      table_visible <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        & industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_latin1 > 0
        & naics_sector_name == input$naics_sector_v
      )
    }
    
    
    else if (input$vis_groups == "sum_mideast1") {
      table_visible <-  subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        & industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_mideast1 > 0
        & naics_sector_name == input$naics_sector_v
      )
    }
    
    else if (input$vis_groups == "sum_nie1") {
      table_visible <- subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        & industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_nie1 > 0
        & naics_sector_name == input$naics_sector_v
      )
    }
    
    else if (input$vis_groups == "sum_multivismin1") {
      table_visible <-  subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        & industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_multivismin1 > 0
        & naics_sector_name == input$naics_sector_v
      )
    }
    
    else if (input$vis_groups == "sum_white1") {
      table_visible <-  subset(
        province_data_vismin_income(),
        geography == as.character(input$geog_v)
        & industry == as.character(input$restrict_v)
        & sex == as.character(input$sex_choose_v)
        & age %in% as.character(input$age_choose_v)
        & sum_white1 > 0
        & naics_sector_name == input$naics_sector_v
      )
    }
    
    vismin3 <- table_visible %>%
      
      select(
        noc_code_class,
        age,
        sex,
        sum_vismin1,
        sum_southasia1,
        sum_easteasia1,
        sum_black1,
        sum_se_asia1,
        sum_latin1,
        sum_mideast1,
        sum_multivismin1,
        sum_nie1,
        sum_white1,
        median_income,
        wfh_yes,
        exposure,
        phys_prox,
        contact_others,
        public_importance,
        indoors_controlled,
        indoors_not_controlled,
        noc_code
      )
    
    
    ##reformat variables
    vismin3$median_income <- dollar(vismin3$median_income)
    vismin3$sum_vismin1 <- comma(vismin3$sum_vismin1)
    vismin3$sum_southasia1 <- comma(vismin3$sum_southasia1)
    vismin3$sum_easteasia1 <- comma(vismin3$sum_easteasia1)
    vismin3$sum_black1 <- comma(vismin3$sum_black1)
    vismin3$sum_se_asia1 <- comma(vismin3$sum_se_asia1)
    vismin3$sum_latin1 <- comma(vismin3$sum_latin1)
    vismin3$sum_mideast1 <- comma(vismin3$sum_mideast1)
    vismin3$sum_multivismin1 <- comma(vismin3$sum_multivismin1)
    vismin3$sum_nie1 <- comma(vismin3$sum_nie1)
    vismin3$sum_white1 <- comma(vismin3$sum_white1)
    
    vismin3$wfh_yes=factor(vismin3$wfh_yes,
                           levels=c(0,
                                    1
                           ),
                           labels=c("No",
                                    "Yes"
                           ))
    
    vismin3 <- plyr::rename(
      vismin3,
      c(
        "noc_code" = "Occupation Code",
        "noc_code_class" = "Occupation",
        "sex" = "Sex",
        "age" = "Age",
        "exposure" = "Exposure to Disease",
        "phys_prox" = "Physical Proximity",
        "contact_others"="Contact with Others",
        "public_importance" = "Interacting with Public",
        "indoors_controlled" = "Indoors, Controlled",
        "indoors_not_controlled" = "Indoors, Not Controlled",
        "median_income" = "Median Income (CAD)",
        "sum_vismin1" = "Visible Minority (N)",
        "sum_southasia1" = "South Asian (N)",
        "sum_easteasia1" = "East Asian (N)",
        "sum_black1" = "Black (N)",
        "sum_se_asia1" = "South East Asian (N)",
        "sum_latin1" = "Latin (N)",
        "sum_mideast1" = "Middle Eastern (N)",
        "sum_multivismin1" = "Multi-Visible Minority (N)",
        "sum_nie1" = "Visible Minority Not Included Elsewhere (N)",
        "sum_white1" = "Non-Visible Minority (N)",
        "wfh_yes" = "Work from Home"
        
      )
    )
  })

output$vismin_table <- DT::renderDataTable(server = FALSE, {
  DT::datatable(
    vismin_table(),
    
    rownames = F,
    extensions = 'Buttons',
    options = list(
      autoWidth = T,
      dom = 'Bfrtip',
      buttons = list(list(extend=('csv'),text="Download")),
      scrollY = "500px",
      scrollX = "500px",
      deferRender = TRUE,
      paging = TRUE,
      columnDefs = list(
        list(
          width = '300px',
          className = 'dt-body-left',
          targets = 0
        ),
        list(
          width = '100px',
          className = 'dt-body-left',
          targets = 1:2
        ),
        list(className = 'dt-center', targets = 3:20),
        # list(width='300px',className = 'dt-head-left', targets = 0),
        # list(className = 'dt-head-center', targets = 1:13),
        list(className = 'dt-nowrap', targets = 0:2),
        list(className = 'dt-head-left', targets = "_all")
      )
    )
    
    ,
    fillContainer = T
  )
})



### Visible Minority Page
## Summary Table (Table 1) Tab

observeEvent(input$help_button_vismin_summary, {
  toggle("help_info_vismin_summary")
})

output$province_text_vismin_summary <- renderText ({
  input$geog_v
})
output$workforce_text_vismin_summary <-
  renderText({
    input$restrict_v
  })
output$age_choose_text_vismin_summary <-
  renderText({
    input$age_choose_v
  })
output$sex_choose_text_vismin_summary <-
  renderText({
    input$sex_choose_v
  })
output$sector_text_vismin_summary <- renderText({
  input$naics_sector_v
})


summary_vismin <-
  reactive ({
    summary_table <- subset(
      province_data_vismin_income(),
      geography == as.character(input$geog_v)
      & industry == as.character(input$restrict_v)
      & sex == as.character(input$sex_choose_v)
      & age %in% as.character(input$age_choose_v)
      & naics_sector_name == input$naics_sector_v
    )
    
    
    summary_table2 <- summary_table %>%
      gather(
        selected_char,
        sum_total1_vis,
        sum_vismin1,
        sum_southasia1,
        sum_easteasia1,
        sum_black1,
        sum_se_asia1,
        sum_latin1,
        sum_mideast1,
        sum_multivismin1,
        sum_nie1,
        sum_white1
      ) 
      
      summary_table3 <- summary_table2 %>%
      group_by(geography, industry, sex, age, selected_char) %>%
      
      mutate(phys_prox = weighted.mean(phys_prox, sum_total1_vis, na.rm = TRUE)) %>%
      mutate(exposure = weighted.mean(exposure, sum_total1_vis, na.rm = TRUE)) %>%
      mutate(public_importance = weighted.mean(public_importance, sum_total1_vis, na.rm =
                                                 TRUE)) %>%
      mutate(contact_others = weighted.mean(contact_others, sum_total1_vis, na.rm =
                                              TRUE)) %>%
      
      mutate(indoors_controlled = weighted.mean(indoors_controlled, sum_total1_vis, na.rm =
                                                  TRUE)) %>%
      mutate(indoors_not_controlled = weighted.mean(indoors_not_controlled, sum_total1_vis, na.rm =
                                                      TRUE)) %>%
      mutate(median_income = weighted.mean(median_income, sum_total1_vis, na.rm =
                                             TRUE)) %>%
      mutate(sum_total1_vis = sum(sum_total1_vis)) %>%
      mutate_if(is.numeric, round, 0) %>%
      distinct(sex, age,selected_char, .keep_all = TRUE) %>% ungroup()
      
        summary_table3_wfh <- summary_table2 %>% filter(wfh_yes == 1) %>%
          group_by(geography, industry, sex, age, selected_char) %>%
          mutate(sum_total1_vis_wfh_yes = sum(sum_total1_vis)) %>%
          distinct() %>%
          select(geography, industry, sex, age, selected_char,sum_total1_vis_wfh_yes)
        
      summary_table3_f <- merge(summary_table3,summary_table3_wfh,by=c("geography", "industry", "sex", "age", "selected_char"))
      summary_table3_f$percent_wfh_yes <- summary_table3_f$sum_total1_vis_wfh_yes / summary_table3_f$sum_total1_vis * 100
      
      summary_table3 <- summary_table3_f %>% distinct(sex, age,selected_char, .keep_all = TRUE) %>% ungroup() %>% mutate_if(is.numeric,round,0)
      
      summary_table3 <- summary_table3 %>%
      select(
        age,
        sex,
        selected_char,
        sum_total1_vis,
        median_income,
        percent_wfh_yes,
        exposure,
        phys_prox,
        contact_others,
        public_importance,
        indoors_controlled,
        indoors_not_controlled
      )
    
    
    
    ##reformat variables
    summary_table3$median_income <- dollar(summary_table3$median_income)
    summary_table3$sum_total1_vis <-
      comma(summary_table3$sum_total1_vis)
    
    summary_table3$selected_char = factor(
      summary_table3$selected_char,
      levels = c(
        "sum_vismin1",
        "sum_southasia1",
        "sum_easteasia1",
        "sum_black1",
        "sum_se_asia1",
        "sum_latin1",
        "sum_mideast1",
        "sum_multivismin1",
        "sum_nie1",
        "sum_white1"
      ),
      labels = c(
        "Visible Minority (total)",
        "South Asian",
        "East Asian",
        "Black",
        "South East Asian",
        "Latin",
        "Middle Eastern",
        "Multiple Visible Minority",
        "Visible Minority Not Included Elsewhere",
        "Not Visible Minority"
      )
    )
    
    
    summary_table3 <- plyr::rename(
      summary_table3,
      c(
        "sex" = "Sex",
        "age" = "Age",
        "percent_wfh_yes" = "Able to Work from Home (%)",
        "exposure" = "Exposure to Disease",
        "phys_prox" = "Physical Proximity",
        "contact_others"="Contact with Others",
        "public_importance" = "Interacting with Public",
        "median_income" = "Median Income (CAD)",
        "indoors_controlled" = "Indoors, Controlled",
        "indoors_not_controlled" = "Indoors, Not Controlled",
        "selected_char" = "Race/Ethnicity",
        "sum_total1_vis" = "Count (N)"
      )
    )
    
  })


output$b_summary_vismin <- DT::renderDataTable(server = FALSE, {
  DT::datatable(
    summary_vismin(),
    
    rownames = F,
    extensions = 'Buttons',
    
    options = list(
      autoWidth = T,
      dom = 'Bfrtip',
      buttons = list(list(extend=('csv'),text="Download")),
      scrollY = "500px",
      scrollX = "200px",
      deferRender = TRUE,
      paging = TRUE,
      columnDefs = list(
        list(
          width = '100px',
          className = 'dt-body-left',
          targets = 0:2
        ),
        list(className = 'dt-center', targets = 3:10),
        list(className = 'dt-nowrap', targets = 0:2),
        list(className = 'dt-head-left', targets = "_all")
      )
    )
    
    ,
    fillContainer = T
  )
})



#########################

#### Income Quintile
### Plot
income_social_plot1 <-
  reactive({
    income_social <- subset(
      province_data_vismin_income(),
      geography == input$geog_iq2 &
        industry == as.character(input$restrict_iq2) &
        sex == as.character(input$sex_choose_iq) &
        age %in% as.character(input$age_choose_iq) &
        sum_total1 > 0
      & naics_sector_name == input$naics_sector_iq2
      &
        wfh_yes %in% input$telework_plot_iq2
    )
  })

x_labels_iq2 <- reactive ({
  # Change x-axis information based on input$xaxis_iq2 variable
  if (!!as.name(input$xaxis_iq2) == "median_income_plot") {
    scale_labs_x <- median_inc_x
  }
  else if (!!as.name(input$xaxis_iq2) == "exposure") {
    scale_labs_x <- exposure_x
  }
  else if (!!as.name(input$xaxis_iq2) == "phys_prox") {
    scale_labs_x <- phys_prox_x
  }
  else if (!!as.name(input$xaxis_iq2) == "noc_broad_descript") {
    scale_labs_x <- sector_x
    axis_text <- theme(axis.text.x = element_text(angle = 45))
  }
  else if (!!as.name(input$xaxis_iq2) == "public_importance") {
    scale_labs_x <- public_x
  }
  
  else if (!!as.name(input$xaxis_iq2) == "indoors_controlled") {
    scale_labs_x <- indoors_controlled_x
  }
  else if (!!as.name(input$xaxis_iq2) == "indoors_not_controlled") {
    scale_labs_x <- indoors_not_controlled_x
  }
  else if (!!as.name(input$xaxis_iq2) == "contact_others") {
    scale_labs_x <- contact_others_x
  }
})

y_labels_iq2 <- reactive ({
  # Change y-axis information based on input$yaxis_iq2 variable
  if (!!as.name(input$yaxis_iq2) == "median_income_plot") {
    scale_labs_y <- median_inc_y
  }
  else if (!!as.name(input$yaxis_iq2) == "exposure") {
    scale_labs_y <- exposure_y
  }
  else if (!!as.name(input$yaxis_iq2) == "phys_prox") {
    scale_labs_y <- phys_prox_y
  }
  else if (!!as.name(input$yaxis_iq2) == "noc_broad_descript") {
    scale_labs_y <- sector_y
  }
  else if (!!as.name(input$yaxis_iq2) == "public_importance") {
    scale_labs_y <- public_y
  }
  
  else if (!!as.name(input$yaxis_iq2) == "indoors_controlled") {
    scale_labs_y <- indoors_controlled_y
  }
  else if (!!as.name(input$yaxis_iq2) == "indoors_not_controlled") {
    scale_labs_y <- indoors_not_controlled_y
  }
  else if (!!as.name(input$yaxis_iq2) == "contact_others") {
    scale_labs_y <- contact_others_y
  }
})


hover_label_function_iq <- reactive({
  # if (input$income_quintile=="sum_total1"){
  #    hoverlab_social <-
  #      paste(
  #        "<b>NOC:</b>",income_social_plot1()$noc_code_class,"<br>",
  #        "<b>In Occupation:</b>",comma(income_social_plot1()$sum_total1),"<br>",
  #        "<b>Median Income (2015CAD):</b>", dollar(income_social_plot1()$median_income), "<br>",
  #        "<b>Physical Proximity:</b>",income_social_plot1()$phys_prox, "<br>",
  #        "<b>Exposure:</b>",income_social_plot1()$exposure, "<br>",
  #        "<b>Interacting with Public - Importance:</b>",income_social_plot1()$public_importance, "<br>",
  #
  #        "<b>Indoors, Controlled:</b>",income_social_plot1()$indoors_controlled, "<br>",
  #        "<b>Indoors, Not Controlled:</b>",income_social_plot1()$indoors_not_controlled, "<br>")}

  if (input$income_quintile == "sum_quintile1") {
    hoverlab_social <-
      paste(
        "<b>",
        income_social_plot1()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(income_social_plot1()$sum_quintile1),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(income_social_plot1()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        income_social_plot1()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        income_social_plot1()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        income_social_plot1()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        income_social_plot1()$public_importance,
        "<br>",
        "<b>Indoors, Controlled:</b>",
        income_social_plot1()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        income_social_plot1()$indoors_not_controlled,
        "<br>"
      )
  }
  
  else if (input$income_quintile == "sum_quintile2") {
    hoverlab_social <-
      paste(
        "<b>",
        income_social_plot1()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(income_social_plot1()$sum_quintile2),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(income_social_plot1()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        income_social_plot1()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        income_social_plot1()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        income_social_plot1()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        income_social_plot1()$public_importance,
        "<br>",
        
        "<b>Indoors, Controlled:</b>",
        income_social_plot1()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        income_social_plot1()$indoors_not_controlled,
        "<br>"
      )
  }
  
  else if (input$income_quintile == "sum_quintile3") {
    hoverlab_social <-
      paste(
         "<b>",
        income_social_plot1()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(income_social_plot1()$sum_quintile3),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(income_social_plot1()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        income_social_plot1()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        income_social_plot1()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        income_social_plot1()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        income_social_plot1()$public_importance,
        "<br>",
        
        "<b>Indoors, Controlled:</b>",
        income_social_plot1()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        income_social_plot1()$indoors_not_controlled,
        "<br>"
      )
  }
  
  else if (input$income_quintile == "sum_quintile4") {
    hoverlab_social <-
      paste(
         "<b>",
        income_social_plot1()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(income_social_plot1()$sum_quintile4),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(income_social_plot1()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        income_social_plot1()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        income_social_plot1()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        income_social_plot1()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        income_social_plot1()$public_importance,
        "<br>",
        
        "<b>Indoors, Controlled:</b>",
        income_social_plot1()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        income_social_plot1()$indoors_not_controlled,
        "<br>"
      )
  }
  
  else if (input$income_quintile == "sum_quintile5") {
    hoverlab_social <-
      paste(
         "<b>",
        income_social_plot1()$noc_code_class,
        "</b>",
        "<br>",
        "<br>",
        "<b>In Occupation:</b>",
        comma(income_social_plot1()$sum_quintile5),
        "<br>",
        "<b>Median Income (2015CAD):</b>",
        dollar(income_social_plot1()$median_income),
        "<br>",
        "<b>Physical Proximity:</b>",
        income_social_plot1()$phys_prox,
        "<br>",
        "<b>Exposure:</b>",
        income_social_plot1()$exposure,
        "<br>",
        "<b>Contact with Others:</b>",
        income_social_plot1()$contact_others,
        "<br>",
        "<b>Interacting with Public - Importance:</b>",
        income_social_plot1()$public_importance,
        "<br>",
        
        "<b>Indoors, Controlled:</b>",
        income_social_plot1()$indoors_controlled,
        "<br>",
        "<b>Indoors, Not Controlled:</b>",
        income_social_plot1()$indoors_not_controlled,
        "<br>"
      )
  }
})

slider_income <-
  reactive ({
    ifelse((!(
      income_social_plot1()$noc_broad %in% input$noc_broad_choose_iq
    )),
    "Not Selected",
    ifelse(
      income_social_plot1()$noc_broad %in% 0,
      "Management",
      ifelse(
        income_social_plot1()$noc_broad %in% 1,
        "Business",
        ifelse(
          income_social_plot1()$noc_broad %in% 2,
          "Sciences",
          ifelse(
            income_social_plot1()$noc_broad %in% 3,
            "Health",
            ifelse(
              income_social_plot1()$noc_broad %in% 4,
              "Community",
              ifelse(
                income_social_plot1()$noc_broad %in% 5,
                "Culture",
                ifelse(
                  income_social_plot1()$noc_broad %in% 6,
                  "Sales",
                  ifelse(
                    income_social_plot1()$noc_broad %in% 7,
                    "Trades",
                    ifelse(
                      income_social_plot1()$noc_broad %in% 8,
                      "Agriculture",
                      ifelse(income_social_plot1()$noc_broad %in% 9, "Utilities", "Not Selected")
                    )
                  )
                )
              )
            )
          )
        )
      )
    ))
  })

observeEvent(input$help_button_income_plot, {
  toggle("help_info_income_plot")
})

output$province_text_income_plot <- renderText ({
  input$geog_iq2
})
output$workforce_text_income_plot <-
  renderText({
    input$restrict_iq2
  })
output$age_choose_text_income_plot <-
  renderText({
    input$age_choose_iq
  })
output$sex_choose_text_income_plot <-
  renderText({
    input$sex_choose_iq
  })
output$sector_text_income_plot <- renderText({
  input$naics_sector_iq2
})


output$income_social_plot <- renderPlotly({
  # set Selected characteristics groups
  label_text_social_iq <- reactive({
    hover_label_function_iq()
    
  })
  
  high_light <-
    highlight_key(income_social_plot1(), ~ noc_code_class)
  
  colour_options <- c(
    "Management",
    "Business",
    "Sciences",
    "Health",
    "Community",
    "Culture",
    "Sales",
    "Trades",
    "Agriculture",
    "Utilities",
    "Not Selected"
  )
  fillColours <-
    setNames(
      c(
        "#3D8704",
        "#0F80A7",
        "#68696D",
        "#80D4DF",
        "#008184",
        "#693A77",
        "#FC7530",
        "#B7D9E5",
        "#CDE4BA",
        "#C8C8C8",
        "#FFFFFF"
      )
      ,
      colour_options
    )
  {
    return(
      ggplotly(
        ggplot(high_light) +
          geom_point(
            aes(
              x = !!as.name(input$xaxis_iq2),
              y = !!as.name(input$yaxis_iq2),
              size = !!as.name(input$income_quintile),
              factor = noc_code_class,
              fill = slider_income(),
              text = label_text_social_iq()
            )
          ) +
          scale_size(range = c(0.5, 15)) +
          theme_bw() +
          theme(legend.position = "bottom") +
          theme(legend.title = element_blank()) +
          x_labels_iq2() +
          y_labels_iq2() +
          labs(
            x = names(xaxis_options[which(xaxis_options == input$xaxis_iq2)]),
            y = names(yaxis_options[which(yaxis_options == input$yaxis_iq2)])
          ) +
          scale_fill_manual(
            values = fillColours
          )
        ,
        tooltip = 'text'
      )
      %>%
        layout(
          legend = list(
            orientation = "v",
            x = 100,
            y = 0.5,
            itemsizing = 'constant'
          )
        )
      %>%
        highlight(
          on = "plotly_hover",
          off = "plotly_deselect",
          color = high_light$noc_broad_descript,
          opacityDim = getOption("opacityDim", 1)
        )
      %>%
        config(modeBarButtonsToRemove = c("hoverClosestCartesian", "hoverCompareCartesian","toggleSpikelines","lasso2d","select2d","autoScale2d"))
      
      
    )
    
    }
})


### Table

observeEvent(input$help_button_income_table, {
  toggle("help_info_income_table")
})

output$province_text_income_table <- renderText ({
  input$geog_iq2
})
output$workforce_text_income_table <-
  renderText({
    input$restrict_iq2
  })
output$age_choose_text_income_table <-
  renderText({
    input$age_choose_iq
  })
output$sex_choose_text_income_table <-
  renderText({
    input$sex_choose_iq
  })
output$sector_text_income_table <-
  renderText({
    input$naics_sector_iq2
  })

income_social_f <- reactive({
  if (input$income_quintile == "sum_quintile1") {
    incomeq <- subset(
      province_data_vismin_income(),
      geography == as.character(input$geog_iq2)
      & industry == as.character(input$restrict_iq2)
      & sex == as.character(input$sex_choose_iq)
      & age %in% as.character(input$age_choose_iq)
      & sum_quintile1 > 0
      & naics_sector_name == input$naics_sector_iq2
    )
  }
  
  else if (input$income_quintile == "sum_quintile2") {
    incomeq <- subset(
      province_data_vismin_income(),
      geography == as.character(input$geog_iq2)
      & industry == as.character(input$restrict_iq2)
      & sex == as.character(input$sex_choose_iq)
      & age %in% as.character(input$age_choose_iq)
      & sum_quintile2 > 0
      & naics_sector_name == input$naics_sector_iq2
    )
  }
  
  else if (input$income_quintile == "sum_quintile3") {
    incomeq <- subset(
      province_data_vismin_income(),
      geography == as.character(input$geog_iq2)
      & industry == as.character(input$restrict_iq2)
      & sex == as.character(input$sex_choose_iq)
      & age %in% as.character(input$age_choose_iq)
      & sum_quintile3 > 0
      & naics_sector_name == input$naics_sector_iq2
    )
  }
  
  else if (input$income_quintile == "sum_quintile4") {
    incomeq <- subset(
      province_data_vismin_income(),
      geography == as.character(input$geog_iq2)
      & industry == as.character(input$restrict_iq2)
      & sex == as.character(input$sex_choose_iq)
      & age %in% as.character(input$age_choose_iq)
      & sum_quintile4 > 0
      & naics_sector_name == input$naics_sector_iq2
    )
  }
  
  else if (input$income_quintile == "sum_quintile5") {
    incomeq <- subset(
      province_data_vismin_income(),
      geography == as.character(input$geog_iq2)
      & industry == as.character(input$restrict_iq2)
      & sex == as.character(input$sex_choose_iq)
      & age %in% as.character(input$age_choose_iq)
      & sum_quintile5 > 0
      & naics_sector_name == input$naics_sector_iq2
    )
  }
})

income_social_f2 <- reactive ({
  incomeq3 <- income_social_f() %>%
    select(
      noc_code_class,
      age,
      sex,
      sum_quintile1,
      sum_quintile2,
      sum_quintile3,
      sum_quintile4,
      sum_quintile5,
      median_income,
      wfh_yes,
      exposure,
      phys_prox,
      contact_others,
      public_importance,
      indoors_controlled,
      indoors_not_controlled,
      noc_code
    )
  
  
  #### reformat variables
  incomeq3$median_income <- dollar(incomeq3$median_income)
  #incomeq3$sum_total1 <- comma(incomeq3$sum_total1)
  incomeq3$sum_quintile1 <- comma(incomeq3$sum_quintile1)
  incomeq3$sum_quintile2 <- comma(incomeq3$sum_quintile2)
  incomeq3$sum_quintile3 <- comma(incomeq3$sum_quintile3)
  incomeq3$sum_quintile4 <- comma(incomeq3$sum_quintile4)
  incomeq3$sum_quintile5 <- comma(incomeq3$sum_quintile5)
  
  incomeq3$wfh_yes=factor(incomeq3$wfh_yes,
                          levels=c(0,
                                   1
                          ),
                          labels=c("No",
                                   "Yes"
                          ))
  
  incomeq3 <- plyr::rename(
    incomeq3,
    c(
      "noc_code" = "Occupation Code",
      "noc_code_class" = "Occupation",
      "sex" = "Sex",
      "age" = "Age",
      "exposure" = "Exposure to Disease",
      "phys_prox" = "Physical Proximity",
      "contact_others"="Contact with Others",
      "public_importance" = "Interacting with Public",
      "indoors_controlled" = "Indoors, Controlled",
      "indoors_not_controlled" = "Indoors, Not Controlled",
      "median_income" = "Median Income (CAD)",
      #"sum_total1"="Total (N)",
      "sum_quintile1" = "Quintile 1 (N)",
      "sum_quintile2" = "Quintile 2 (N)",
      "sum_quintile3" = "Quintile 3 (N)",
      "sum_quintile4" = "Quintile 4 (N)",
      "sum_quintile5" = "Quintile 5 (N)",
      "wfh_yes" = "Work from Home"
      
    )
  )
})


output$income_social_table <- DT::renderDataTable(server = FALSE, {
  DT::datatable(
    income_social_f2(),
    
    rownames = F,
    extensions = 'Buttons',
    
    options = list(
      autoWidth = T,
      dom = 'Bfrtip',
      buttons = list(list(extend=('csv'),text="Download")),
      scrollY = "500px",
      scrollX = "500px",
      deferRender = TRUE,
      paging = TRUE,
      columnDefs = list(
        list(
          width = '300px',
          className = 'dt-body-left',
          targets = 0
        ),
        list(
          width = '100px',
          className = 'dt-body-left',
          targets = 1:2
        ),
        list(className = 'dt-center', targets = 3:15),
        list(className = 'dt-nowrap', targets = 0:2),
        list(className = 'dt-head-left', targets = "_all")
      )
    )
    
    ,
    fillContainer = T
  )
})




###
## Summary Table (Table 1) Tab
observeEvent(input$help_button_income_summary, {
  toggle("help_info_income_summary")
})

output$province_text_income_summary <- renderText ({
  input$geog_iq2
})
output$workforce_text_income_summary <-
  renderText({
    input$restrict_iq2
  })
output$age_choose_text_income_summary <-
  renderText({
    input$age_choose_iq
  })
output$sex_choose_text_income_summary <-
  renderText({
    input$sex_choose_iq
  })
output$sector_text_income_summary <- renderText({
  input$naics_sector_iq2
})

summary_income <-
  reactive({
    summary_table <- subset(
      province_data_vismin_income(),
      geography == as.character(input$geog_iq2)
      & industry == as.character(input$restrict_iq2)
      & sex == as.character(input$sex_choose_iq)
      & age %in% as.character(input$age_choose_iq)
      & naics_sector_name == input$naics_sector_iq2
    )
    
    
    summary_table2 <- summary_table %>%
      gather(
        selected_char,
        sum_total1_inc,
        sum_quintile1,
        sum_quintile2,
        sum_quintile3,
        sum_quintile4,
        sum_quintile5
      ) 
      
      summary_table3 <- summary_table2 %>%
      group_by(geography, industry, sex, age, selected_char) %>%
      mutate(exposure = weighted.mean(exposure, sum_total1_inc, na.rm = TRUE)) %>%
      mutate(phys_prox = weighted.mean(phys_prox, sum_total1_inc, na.rm = TRUE)) %>%
      mutate(public_importance = weighted.mean(public_importance, sum_total1_inc, na.rm =
                                                 TRUE)) %>%
      mutate(contact_others = weighted.mean(contact_others, sum_total1_inc, na.rm =
                                              TRUE)) %>%
      mutate(indoors_controlled = weighted.mean(indoors_controlled, sum_total1_inc, na.rm =
                                                  TRUE)) %>%
      mutate(indoors_not_controlled = weighted.mean(indoors_not_controlled, sum_total1_inc, na.rm =
                                                      TRUE)) %>%
      mutate(median_income = weighted.mean(median_income, sum_total1_inc, na.rm =
                                             TRUE)) %>%
      mutate(sum_total1_inc = sum(sum_total1_inc)) %>%
      mutate_if(is.numeric, round, 0) %>%
      distinct(sex, age,selected_char, .keep_all = TRUE) %>% ungroup () 
      
        summary_table3_wfh <- summary_table2 %>% filter(wfh_yes == 1) %>%
          group_by(geography, industry, sex, age, selected_char) %>%
          mutate(sum_total1_inc_wfh_yes = sum(sum_total1_inc)) %>%
          distinct() %>%
          select(geography, industry, sex, age, selected_char,sum_total1_inc_wfh_yes)
        
      summary_table3_f <- merge(summary_table3,summary_table3_wfh,by=c("geography", "industry", "sex", "age", "selected_char"))
      summary_table3_f$percent_wfh_yes <- summary_table3_f$sum_total1_inc_wfh_yes / summary_table3_f$sum_total1_inc * 100
      
      summary_table3 <- summary_table3_f %>% distinct(sex, age,selected_char, .keep_all = TRUE) %>% ungroup() %>% mutate_if(is.numeric,round,0)
      
      summary_table3 <- summary_table3 %>%
      select(
        age,
        sex,
        selected_char,
        sum_total1_inc,
        median_income,
        percent_wfh_yes,
        exposure,
        phys_prox,
        contact_others,
        public_importance,
        indoors_controlled,
        indoors_not_controlled
      )
    
    ##reformat variables
    summary_table3$median_income <- dollar(summary_table3$median_income)
    summary_table3$sum_total1_inc <-
      comma(summary_table3$sum_total1_inc)
    
    summary_table3$selected_char = factor(
      summary_table3$selected_char,
      levels = c(
        "sum_quintile1",
        "sum_quintile2",
        "sum_quintile3",
        "sum_quintile4",
        "sum_quintile5"
      ),
      labels = c(
        "Quintile 1",
        "Quintile 2",
        "Quintile 3",
        "Quintile 4",
        "Quintile 5"
      )
    )
    
    summary_table3 <- plyr::rename(
      summary_table3,
      c(
        "sex" = "Sex",
        "age" = "Age",
        "percent_wfh_yes" = "Able to Work from Home (%)",
        "exposure" = "Exposure to Disease",
        "phys_prox" = "Physical Proximity",
        "contact_others"="Contact with Others",
        "public_importance" = "Interacting with Public",
        "median_income" = "Median Income (CAD)",
        "indoors_controlled" = "Indoors, Controlled",
        "indoors_not_controlled" = "Indoors, Not Controlled",
        "selected_char" = "Household Income",
        "sum_total1_inc" = "Count (N)"
      )
    )
    
    
    
  })


output$b_summary_income <- DT::renderDataTable(server = FALSE, {
  DT::datatable(
    summary_income(),
    
    rownames = F,
    extensions = 'Buttons',
    
    options = list(
      autoWidth = T,
      dom = 'Bfrtip',
      buttons = list(list(extend=('csv'),text="Download")),
      scrollY = "500px",
      scrollX = "200px",
      deferRender = TRUE,
      paging = TRUE,
      columnDefs = list(
        list(
          width = '100px',
          className = 'dt-body-left',
          targets = 0:2
        ),
        list(className = 'dt-center', targets = 3:10),
        # list(width='300px',className = 'dt-head-left', targets = 0),
        # list(className = 'dt-head-center', targets = 1:13),
        list(className = 'dt-nowrap', targets = 0:2),
        list(className = 'dt-head-left', targets = "_all")
      )
    ),
    fillContainer = T
  )
})


#### 1) 'forest plot1' with Contact, Phys Prox, Exposure

hr_text_outputnoc1 <- reactive ({
  if (!!as.name(input$hr_question3) == 1) {
    if (!!as.name(input$geog_select2) == 'Ontario') {
      text <- input$on3
    }
    
    else if (!!as.name(input$geog_select2) == 'British Columbia') {
      text <- input$bc3
    }
    else if (!!as.name(input$geog_select2) == 'Alberta') {
      text <- input$ab3
    }
    
    else if (!!as.name(input$geog_select2) == 'Quebec') {
      text <- input$qb3
    }
    else if (!!as.name(input$geog_select2) == 'Newfoundland and Labrador') {
      text <- input$nl3
    }
    
    else if (!!as.name(input$geog_select2) == 'Nova Scotia') {
      text <- input$ns3
    }
    
    else if (!!as.name(input$geog_select2) == 'New Brunswick') {
      text <- input$nb3
    }
    
    else if (!!as.name(input$geog_select2) == 'Prince Edward Island') {
      text <- input$pei3
    }
    
    else if (!!as.name(input$geog_select2) == 'Saskatchewan') {
      text <- input$sk3
    }
    
    else if (!!as.name(input$geog_select2) == 'Manitoba') {
      text <- input$mb3
    }
    
    else if (!!as.name(input$geog_select2) == 'Nunavut') {
      text <- input$nu3
    }
    
    else if (!!as.name(input$geog_select2) == 'Northwest Territories') {
      text <- input$nt3
    }
    
    else if (!!as.name(input$geog_select2) == 'Yukon') {
      text <- input$yt3
    }
  }
})

output$prov1 <- renderText ({
  input$geog_select2
})
output$noc_chosen1 <- renderText ({
  input$noc_code_select1
})
output$regions1 <- renderText ({
  hr_text_outputnoc1()
})

occupation_forest <- reactive({
  if(is.null(input$noc_code_select1)){
    onet_measure <- c("exposure", "phys_prox", "contact_others")
    onet_score <- c(0,0,0)
    occupation_onet <-data.frame(onet_measure,onet_score)
  }else{
    
    occupation_onet <-
      table1_table2_datatool%>% select(noc_code,
                                       noc_code_class,
                                       contact_others,
                                       phys_prox,
                                       exposure) %>% distinct()
    occupation_onet <-
      occupation_onet %>% gather(onet_measure,
                                 onet_score,
                                 contact_others,
                                 phys_prox,
                                 exposure) %>% filter(!(is.na(onet_score)))
    occupation_onet <-
      occupation_onet %>% filter(noc_code_class == input$noc_code_select1)
  }
  
})


output$forest_plot1 <- renderPlotly({
  colour_options <- c("exposure", "phys_prox", "contact_others")
  fillColours <-
    setNames(c("#0F80A7",
               "grey",
               "#3D8704")
             ,
             colour_options)
  
  hoverlab <- paste("<b>Score:</b>",
                    (occupation_forest()$onet_score))
  
  
  if(is.null(input$noc_code_select1)){
    
    return(
      plot_occupation_onet <- ggplotly(
        ggplot(occupation_forest()) +
          
          
          geom_segment(
            mapping = aes(
              y = onet_measure,
              yend = onet_measure,
              x = 0,
              xend = 100,
              colour = onet_measure
            )
          )
        + scale_y_discrete(
          limits = c("exposure", "phys_prox", "contact_others"),
          labels = c(
            "contact_others" = "Contact with Others",
            "phys_prox" = "Physical Proximity",
            "exposure" = "Exposure to Disease"
          )
        ) +
          scale_x_continuous(
            breaks = seq(0, 100, by = 100),
            labels = c("0 (min)", "100 (max)"),
            limits = c(0, 100)
          )
        +
          
          theme_bw() +
          theme(
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            # panel.border = element_blank(),
            panel.background = element_blank()
          ) +
          theme(legend.position = "none") +
          theme(legend.title = element_blank()) +
          labs(legend = NULL,
               x = NULL,
               y = NULL)
        + scale_fill_manual(values = fillColours)
        + scale_colour_manual(values = fillColours)
        + theme(
          strip.text.x = element_text(
            size = 12,
            colour = "black",
            angle = 0,
            h = 0.5,
            v = 0.5
          ),
          strip.background = element_rect(fill ="white", colour = "white")
        ),
        tooltip = 'text'
        
      ) %>%
        config(displayModeBar = FALSE)
    )
  }else  {
    
    return(
      plot_occupation_onet <- ggplotly(
        ggplot(occupation_forest()) +
          
          geom_point(
            aes(
              x = onet_score,
              y = onet_measure,
              fill = onet_measure,
              size = 5,
              # factor = noc_code_class,
              text = hoverlab
            )
          )
        +
          geom_segment(
            mapping = aes(
              y = onet_measure,
              yend = onet_measure,
              x = 0,
              xend = 100,
              colour = onet_measure
            )
          )
        # + facet_grid( ~ noc_code_class, labeller =
        #                 label_wrap_gen(40))
        + scale_y_discrete(
          limits = c("exposure", "phys_prox", "contact_others"),
          labels = c(
            "contact_others" = "Contact with Others",
            "phys_prox" = "Physical Proximity",
            "exposure" = "Exposure to Disease"
          )
        ) +
          scale_x_continuous(
            breaks = seq(0, 100, by = 100),
            labels = c("0 (min)", "100 (max)"),
            limits = c(0, 100)
          )
        +
          
          theme_bw() +
          theme(
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            # panel.border = element_blank(),
            panel.background = element_blank()
          ) +
          theme(legend.position = "none") +
          theme(legend.title = element_blank()) +
          labs(legend = NULL,
               x = NULL,
               y = NULL)
        + scale_fill_manual(values = fillColours)
        + scale_colour_manual(values = fillColours)
        + theme(
          strip.text.x = element_text(
            size = 12,
            colour = "black",
            angle = 0,
            h = 0.5,
            v = 0.5
          ),
          strip.background = element_rect(fill ="white", colour = "white")
        ),
        tooltip = 'text'
        
      ) %>%
        config(displayModeBar = FALSE)
    )
  }
  
  
})




#### 1) 'forest plot2' with Contact, Phys Prox, Exposure

hr_text_outputnoc2 <- reactive ({
  if (!!as.name(input$hr_question3) == 1) {
    if (!!as.name(input$geog_select2) == 'Ontario') {
      text <- input$on3
    }
    
    else if (!!as.name(input$geog_select2) == 'British Columbia') {
      text <- input$bc3
    }
    else if (!!as.name(input$geog_select2) == 'Alberta') {
      text <- input$ab3
    }
    
    else if (!!as.name(input$geog_select2) == 'Quebec') {
      text <- input$qb3
    }
    else if (!!as.name(input$geog_select2) == 'Newfoundland and Labrador') {
      text <- input$nl3
    }
    
    else if (!!as.name(input$geog_select2) == 'Nova Scotia') {
      text <- input$ns3
    }
    
    else if (!!as.name(input$geog_select2) == 'New Brunswick') {
      text <- input$nb3
    }
    
    else if (!!as.name(input$geog_select2) == 'Prince Edward Island') {
      text <- input$pei3
    }
    
    else if (!!as.name(input$geog_select2) == 'Saskatchewan') {
      text <- input$sk3
    }
    
    else if (!!as.name(input$geog_select2) == 'Manitoba') {
      text <- input$mb3
    }
    
    else if (!!as.name(input$geog_select2) == 'Nunavut') {
      text <- input$nu3
    }
    
    else if (!!as.name(input$geog_select2) == 'Northwest Territories') {
      text <- input$nt3
    }
    
    else if (!!as.name(input$geog_select2) == 'Yukon') {
      text <- input$yt3
    }
  }
})

output$prov2 <- renderText ({
  input$geog_select2
})
output$noc_chosen2 <- renderText ({
  input$noc_code_select2
})
output$regions2 <- renderText ({
  hr_text_outputnoc2()
})

occupation_forest2 <- reactive({
  if(is.null(input$noc_code_select2)){
    onet_measure <- c("exposure", "phys_prox", "contact_others")
    onet_score <- c(0,0,0)
    occupation_onet <-data.frame(onet_measure,onet_score)
  }else{
    
    occupation_onet <-
      table1_table2_datatool %>% select(noc_code,
                                        noc_code_class,
                                        contact_others,
                                        phys_prox,
                                        exposure) %>% distinct()
    occupation_onet <-
      occupation_onet %>% gather(onet_measure,
                                 onet_score,
                                 contact_others,
                                 phys_prox,
                                 exposure) %>% filter(!(is.na(onet_score)))
    occupation_onet <-
      occupation_onet %>% filter(noc_code_class == input$noc_code_select2)
  }
  
})

output$forest_plot2 <- renderPlotly({
  colour_options <- c("exposure", "phys_prox", "contact_others")
  fillColours <-
    setNames(c("#0F80A7",
               "grey",
               "#3D8704")
             ,
             colour_options)
  
  hoverlab <- paste("<b>Score:</b>",
                    (occupation_forest2()$onet_score))
  
  
  
  if(is.null(input$noc_code_select2)){
    
    return(
      plot_occupation_onet <- ggplotly(
        ggplot(occupation_forest2()) +
          
          
          geom_segment(
            mapping = aes(
              y = onet_measure,
              yend = onet_measure,
              x = 0,
              xend = 100,
              colour = onet_measure
            )
          )
        + scale_y_discrete(
          limits = c("exposure", "phys_prox", "contact_others"),
          labels = c(
            "contact_others" = "Contact with Others",
            "phys_prox" = "Physical Proximity",
            "exposure" = "Exposure to Disease"
          )
        ) +
          scale_x_continuous(
            breaks = seq(0, 100, by = 100),
            labels = c("0 (min)", "100 (max)"),
            limits = c(0, 100)
          )
        +
          
          theme_bw() +
          theme(
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            # panel.border = element_blank(),
            panel.background = element_blank()
          ) +
          theme(legend.position = "none") +
          theme(legend.title = element_blank()) +
          labs(legend = NULL,
               x = NULL,
               y = NULL)
        + scale_fill_manual(values = fillColours)
        + scale_colour_manual(values = fillColours)
        + theme(
          strip.text.x = element_text(
            size = 12,
            colour = "black",
            angle = 0,
            h = 0.5,
            v = 0.5
          ),
          strip.background = element_rect(fill ="white", colour = "white")
        ),
        tooltip = 'text'
        
      ) %>%
        config(displayModeBar = FALSE)
    )
  }else  {
    
    return(
      plot_occupation_onet <- ggplotly(
        ggplot(occupation_forest2()) +
          
          geom_point(
            aes(
              x = onet_score,
              y = onet_measure,
              fill = onet_measure,
              size = 5,
              # factor = noc_code_class,
              text = hoverlab
            )
          )
        +
          geom_segment(
            mapping = aes(
              y = onet_measure,
              yend = onet_measure,
              x = 0,
              xend = 100,
              colour = onet_measure
            )
          )
        # + facet_grid( ~ noc_code_class, labeller =
        #                 label_wrap_gen(40))
        + scale_y_discrete(
          limits = c("exposure", "phys_prox", "contact_others"),
          labels = c(
            "contact_others" = "Contact with Others",
            "phys_prox" = "Physical Proximity",
            "exposure" = "Exposure to Disease"
          )
        ) +
          scale_x_continuous(
            breaks = seq(0, 100, by = 100),
            labels = c("0 (min)", "100 (max)"),
            limits = c(0, 100)
          )
        +
          
          theme_bw() +
          theme(
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            # panel.border = element_blank(),
            panel.background = element_blank()
          ) +
          theme(legend.position = "none") +
          theme(legend.title = element_blank()) +
          labs(legend = NULL,
               x = NULL,
               y = NULL)
        + scale_fill_manual(values = fillColours)
        + scale_colour_manual(values = fillColours)
        + theme(
          strip.text.x = element_text(
            size = 12,
            colour = "black",
            angle = 0,
            h = 0.5,
            v = 0.5
          ),
          strip.background = element_rect(fill ="white", colour = "white")
        ),
        tooltip = 'text'
        
      ) %>%
        config(displayModeBar = FALSE)
    )
  }
  
  
})




### summary table for occupation # 1


summary_occupation <- reactive({
  if (!!as.name(input$hr_question3) == 2) {
    data <-
      province_data_total() %>% filter(
        age=="Total" & sex=="Total"
        & industry=="Total"
        & naics_sector_name =="Total Sectors"
        & noc_code_class %in% input$noc_code_select1
        & geography==input$geog_select2
      )
    
    data <- data %>%
      select(
        noc_code,
        noc_code_class,
        sum_total1,
        percent_immig,
        percent_nonpermres,
        percent_vismin,
        overall_percent_female,
        overall_percent_65,
        percent_quintile1,
        median_income,
        wfh_yes,
        phys_prox,
        exposure,
        contact_others
      )
       
    
    data <- data %>%
      gather(characteristics,sum_percent,
             sum_total1,
             overall_percent_female,
             overall_percent_65,
             percent_immig,
             percent_nonpermres,
             percent_vismin,
             percent_quintile1,
             
             wfh_yes,
             contact_others,
             phys_prox,
             exposure,
             median_income
      ) %>%
      arrange(noc_code) %>%
      select(characteristics,sum_percent)
    data$characteristics = factor(
      data$characteristics,
      
      levels = c(
        'sum_total1',
        "overall_percent_female",
        "overall_percent_65",
        "percent_immig",
        "percent_nonpermres",
        "percent_vismin",
        "percent_quintile1",
        
        "wfh_yes",
        "contact_others",
        "phys_prox",
        "exposure",
        "median_income"
      ),
      labels = c(
        "# of workers:",
        "Female (%):",
        "Aged 65 years and over (%):",
        "Immigrant (%):",
        "Non-permanent Resident (%):",
        "Visible Minority (%):",
        "Household Income Quintile 1 (%):",
        "Can work from home:",
        "Contact with Others:",
        "Physical Proximity:",
        "Exposure to Disease:",
        "Median Income (CAD):"
        
      )
    )
    data$characteristics <- as.character(data$characteristics)
    data <- as.data.frame(data)
    
  } else if (!!as.name(input$hr_question3) == 1) {
    if (!!as.name(input$geog_select2) == 'Ontario') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$on3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'British Columbia') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$bc3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Alberta') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$ab3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Quebec') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$qb3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Newfoundland and Labrador') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$nl3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Nova Scotia') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$ns3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'New Brunswick') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$nb3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Prince Edward Island') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$pei3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Saskatchewan') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$sk3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Manitoba') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$mb3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Nunavut') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$nu3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Northwest Territories') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$nt3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Yukon') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select1
          & geography==input$geog_select2
          & health_region==input$yt3
        )
    }
    data <- data %>%
      select(
        noc_code,
        noc_code_class,
        sum_total1,
        percent_immig,
        percent_nonpermres,
        percent_vismin,
        overall_percent_female,
        overall_percent_65,
        median_income,
        wfh_yes,
        phys_prox,
        exposure,
        contact_others
        
      )
    
    data <- data %>%
      gather(characteristics,sum_percent,
             sum_total1,
             overall_percent_female,
             overall_percent_65,
             percent_immig,
             percent_nonpermres,
             percent_vismin,
             
             
             wfh_yes,
             contact_others,
             phys_prox,
             exposure,
             median_income
      ) %>%
      arrange(noc_code) %>%
      select(characteristics,sum_percent)
    
    data$characteristics = factor(
      data$characteristics,
      
      levels = c(
        'sum_total1',
        "overall_percent_female",
        "overall_percent_65",
        "percent_immig",
        "percent_nonpermres",
        "percent_vismin",
        
        
        "wfh_yes",
        "contact_others",
        "phys_prox",
        "exposure",
        "median_income"
      ),
      labels = c(
        "# of workers:",
        "Female (%):",
        "Aged 65 years and over (%):",
        "Immigrant (%):",
        "Non-permanent Resident (%):",
        "Visible Minority (%):",
        
        "Can work from home:",
        "Contact with Others:",
        "Physical Proximity:",
        "Exposure to Disease:",
        "Median Income (CAD):"
        
      )
    )
    data$characteristics <- as.character(data$characteristics)
    data <- as.data.frame(data)
    
    
  }
  
  
})


# data[1,2] <- comma(data[1,2])

# data$sum_percent <- ifelse(data$characteristics == "sum_total1",comma(data$sum_percent),
#                            ifelse(data$characteristics == "median_income",dollar(data$sum_percent),data$sum_percent))



output$table_occup_info1 <- renderDT(server = FALSE,
                                     {
                                       
                                       DT::datatable(
                                         summary_occupation(),
                                         rownames = F,
                                         colnames=NULL,
                                         # callback = JS(c("$('table.dataTable.no-footer').css('border-bottom', 'none');",
                                         #                 "$('table.dataTable thead th').css('border-bottom', 'none');")),
                                         
                                         options = list(dom = 't',ordering=F, pageLength =12)
                                         
                                         ,
                                         fillContainer = T
                                         # ,
                                         # caption = htmltools::tags$caption(style = 'caption-side: top; text-align: center; color:black; font-size:100% ;','Occupation Summary')
                                       ) %>%
                                         formatStyle(c(1,2), `border-right` = "solid 2px #white") %>%
                                         formatStyle(c(1), `border-left` = "solid 2px #white") %>%
                                         formatStyle(c(1), fontWeight = "bold", backgroundColor = "#E7F2F6", color='grey') %>%
                                         formatStyle(c(1,2), `border-bottom` = "solid 2px #0F80A7")
                                       
                                       
                                     })





### summary table for occupation # 2


summary_occupation2 <- reactive({
  if (!!as.name(input$hr_question3) == 2) {
    data <-
      province_data_total() %>% filter(
        age=="Total" & sex=="Total"
        & industry=="Total"
        & naics_sector_name =="Total Sectors"
        & noc_code_class %in% input$noc_code_select2
        & geography==input$geog_select2
      )
    
    data <- data %>%
      select(
        noc_code,
        noc_code_class,
        sum_total1,
        percent_immig,
        percent_nonpermres,
        percent_vismin,
        overall_percent_female,
        overall_percent_65,
        percent_quintile1,
        median_income,
        wfh_yes,
        phys_prox,
        exposure,
        contact_others
      )
    
    data <- data %>%
      gather(characteristics,sum_percent,
             sum_total1,
             overall_percent_female,
             overall_percent_65,
             percent_immig,
             percent_nonpermres,
             percent_vismin,
             percent_quintile1,
             
             wfh_yes,
             contact_others,
             phys_prox,
             exposure,
             median_income
      ) %>%
      arrange(noc_code) %>%
      select(characteristics,sum_percent)
    data$characteristics = factor(
      data$characteristics,
      
      levels = c(
        'sum_total1',
        "overall_percent_female",
        "overall_percent_65",
        "percent_immig",
        "percent_nonpermres",
        "percent_vismin",
        "percent_quintile1",
        
        "wfh_yes",
        "contact_others",
        "phys_prox",
        "exposure",
        "median_income"
      ),
      labels = c(
        "# of workers:",
        "Female (%):",
        "Aged 65 years and over (%):",
        "Immigrant (%):",
        "Non-permanent Resident (%):",
        "Visible Minority (%):",
        "Household Income Quintile 1 (%):",
        "Can work from home:",
        "Contact with Others:",
        "Physical Proximity:",
        "Exposure to Disease:",
        "Median Income (CAD):"
        
      )
    )
    data$characteristics <- as.character(data$characteristics)
    data <- as.data.frame(data)
    
  } else if (!!as.name(input$hr_question3) == 1) {
    if (!!as.name(input$geog_select2) == 'Ontario') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$on3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'British Columbia') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$bc3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Alberta') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$ab3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Quebec') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$qb3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Newfoundland and Labrador') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$nl3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Nova Scotia') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$ns3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'New Brunswick') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$nb3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Prince Edward Island') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$pei3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Saskatchewan') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$sk3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Manitoba') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$mb3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Nunavut') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$nu3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Northwest Territories') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$nt3
        )
    }
    
    else if (!!as.name(input$geog_select2) == 'Yukon') {
      data <-
        subset(
          regional_data_total(),
          age=="Total" & sex=="Total"
          & industry=="Total"
          & naics_sector_name =="Total Sectors"
          & noc_code_class %in% input$noc_code_select2
          & geography==input$geog_select2
          & health_region==input$yt3
        )
    }
    data <- data %>%
      select(
        noc_code,
        noc_code_class,
        sum_total1,
        percent_immig,
        percent_nonpermres,
        percent_vismin,
        overall_percent_female,
        overall_percent_65,
        percent_quintile1,
        median_income,
        wfh_yes,
        phys_prox,
        exposure,
        contact_others
      )
    
    data <- data %>%
      gather(characteristics,sum_percent,
             sum_total1,
             overall_percent_female,
             overall_percent_65,
             percent_immig,
             percent_nonpermres,
             percent_vismin,
             
             
             wfh_yes,
             contact_others,
             phys_prox,
             exposure,
             median_income
      ) %>%
      arrange(noc_code) %>%
      select(characteristics,sum_percent)
    
    data$characteristics = factor(
      data$characteristics,
      
      levels = c(
        'sum_total1',
        "overall_percent_female",
        "overall_percent_65",
        "percent_immig",
        "percent_nonpermres",
        "percent_vismin",
        
        
        "wfh_yes",
        "contact_others",
        "phys_prox",
        "exposure",
        "median_income"
      ),
      labels = c(
        "# of workers:",
        "Female (%):",
        "Aged 65 years and over (%):",
        "Immigrant (%):",
        "Non-permanent Resident (%):",
        "Visible Minority (%):",
        
        "Can work from home:",
        "Contact with Others:",
        "Physical Proximity:",
        "Exposure to Disease:",
        "Median Income (CAD):"
        
      )
    )
    data$characteristics <- as.character(data$characteristics)
    data <- as.data.frame(data)
    
  }
  
  
})
output$table_occup_info2 <- renderDT(server = FALSE,
                                     {
                                       
                                       DT::datatable(
                                         summary_occupation2(),
                                         rownames = F,
                                         colnames=NULL,
                                         # callback = JS(c("$('table.dataTable.no-footer').css('border-bottom', 'none');",
                                         #                 "$('table.dataTable thead th').css('border-bottom', 'none');")),
                                         
                                         options = list(dom = 't',ordering=F, pageLength =12)
                                         
                                         ,
                                         fillContainer = T
                                         # ,
                                         # caption = htmltools::tags$caption(style = 'caption-side: top; text-align: center; color:black; font-size:100% ;','Occupation Summary')
                                       ) %>%
                                         formatStyle(c(1,2), `border-right` = "solid 2px #white") %>%
                                         formatStyle(c(1), `border-left` = "solid 2px #white") %>%
                                         formatStyle(c(1), fontWeight = "bold", backgroundColor = "#E7F2F6", color='grey') %>%
                                         formatStyle(c(1,2), `border-bottom` = "solid 2px #0F80A7")
                                       
                                       
                                     })



### bar chart
observeEvent(input$help_button_industry_summary, {
  toggle("help_info_industry_summary")
})

bar_chart_reactive <- reactive({
  
  if (input$hr_question4 == 2){
  
  req(input$choose_group,
      input$choose_prop,
      input$naics_sector_search_prop)
  
   if (input$choose_group == "Household Income") {
    if (input$choose_prop == "Unable to work from home") {
      plot_data <- income_wfh_f
    } else if (input$choose_prop == "High Physical Proximity") {
      plot_data <- income_phys_prox_f
    } else if (input$choose_prop == "High Exposure") {
      plot_data <- income_exposure_f
    }
  } else if (input$choose_group == "Race/Ethnicity") {
    if (input$choose_prop == "Unable to work from home") {
      plot_data <- vismin_wfh_f
    } else if (input$choose_prop == "High Physical Proximity") {
      plot_data <- vismin_phys_prox_f
    } else if (input$choose_prop == "High Exposure") {
      plot_data <- vismin_exposure_f
    }
  } else if (input$choose_group == "Immigrant Status") {
    if (input$choose_prop == "Unable to work from home") {
      plot_data <- immig_wfh_f
    } else if (input$choose_prop == "High Physical Proximity") {
      plot_data <- immig_phys_prox_f
    } else if (input$choose_prop == "High Exposure") {
      plot_data <- immig_exposure_f
    }
  } else if (input$choose_group == "Age") {
    if (input$choose_prop == "Unable to work from home") {
      plot_data <- age_group_wfh_f
    } else if (input$choose_prop == "High Physical Proximity") {
      plot_data <- age_group_phys_prox_f
    } else if (input$choose_prop == "High Exposure") {
      plot_data <- age_group_exposure_f
    }
  }
  
  plot_data <-
    plot_data %>% filter(geography == input$geog_prop &
                           naics_sector_name == input$naics_sector_search_prop)
  } else if (input$hr_question4 == 1){
  
  req(input$choose_group_hr,
      input$choose_prop,
      input$naics_sector_search_prop)
  
   if (input$choose_group_hr == "Race/Ethnicity") {
    if (input$choose_prop == "Unable to work from home") {
      plot_data <- hr_vismin_wfh_f
    } else if (input$choose_prop == "High Physical Proximity") {
      plot_data <- hr_vismin_phys_prox_f
    } else if (input$choose_prop == "High Exposure") {
      plot_data <- hr_vismin_exposure_f
    }
  } else if (input$choose_group_hr == "Immigrant Status") {
    if (input$choose_prop == "Unable to work from home") {
      plot_data <- hr_immig_wfh_f
    } else if (input$choose_prop == "High Physical Proximity") {
      plot_data <- hr_immig_phys_prox_f
    } else if (input$choose_prop == "High Exposure") {
      plot_data <- hr_immig_exposure_f
    }
  } else if (input$choose_group_hr == "Age") {
    if (input$choose_prop == "Unable to work from home") {
      plot_data <- hr_age_group_wfh_f
    } else if (input$choose_prop == "High Physical Proximity") {
      plot_data <- hr_age_group_phys_prox_f
    } else if (input$choose_prop == "High Exposure") {
      plot_data <- hr_age_group_exposure_f
    }
  }
    if (!!as.name(input$geog_prop) == 'Ontario') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$on4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
    }
    
     else if (!!as.name(input$geog_prop) == 'Alberta') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$ab4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
     }
         else if (!!as.name(input$geog_prop) == 'British Columbia') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$bc4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
         }
             else if (!!as.name(input$geog_prop) == 'Quebec') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$qb4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
             }
             else if (!!as.name(input$geog_prop) == 'Saskatchewan') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$sk4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
             }
             else if (!!as.name(input$geog_prop) == 'Manitoba') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$mb4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
    }
    
             else if (!!as.name(input$geog_prop) == 'New Brunswick') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$nb4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
             }
             else if (!!as.name(input$geog_prop) == 'Nova Scotia') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$ns4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
             }
       else if (!!as.name(input$geog_prop) == 'Prince Edward Island') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$pei4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
       }
           else if (!!as.name(input$geog_prop) == 'Newfoundland and Labrador') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$nl4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
             }
             else if (!!as.name(input$geog_prop) == 'Yukon') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$yt4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
             }
             else if (!!as.name(input$geog_prop) == 'Northwest Territories') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$nt4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
    }
             else if (!!as.name(input$geog_prop) == 'Nunavut') {
    plot_data <-
    plot_data %>% filter(geography == input$geog_prop 
                         &
                           health_region %in% input$nu4
                         &
                           naics_sector_name == input$naics_sector_search_prop)
    }
    
  }
})

scale_y <- reactive({
if (input$hr_question4 == 2){
 if (input$choose_group == "Household Income") {
    scale_y <-
      scale_y_discrete(
        limits = c(
          "percent_quintile1",
          "percent_quintile2",
          "percent_quintile3",
          "percent_quintile4",
          "percent_quintile5"
        ),
        labels = c(
          "percent_quintile1" = "Quintile 1",
          "percent_quintile2" = "Quintile 2",
          "percent_quintile3" = "Quintile 3",
          "percent_quintile4" = "Quintile 4",
          "percent_quintile5" = "Quintile 5"
        )
      )
    
  } else if (input$choose_group == "Race/Ethnicity") {
    scale_y <-
      scale_y_discrete(
        limits = c(
          "percent_southasia1",
          "percent_easteasia1",
          "percent_se_asia1",
          "percent_black1",
          "percent_latin1",
          "percent_mideast1",
          "percent_multivismin1",
          "percent_nie1",
          "percent_notvismin1"
        ),
        labels = c(
          "percent_southasia1" = "South Asian",
          "percent_easteasia1" = "East Asian",
          "percent_se_asia1" = "South East Asian",
          "percent_black1" = "Black",
          "percent_latin1" = "Latin",
          "percent_mideast1" = "Middle Eastern",
          "percent_multivismin1" = "Multiple Visible Minority",
          "percent_nie1" = "Visible Minority Not Included Elsewhere",
          "percent_notvismin1" = "Not Visible Minority"
        )
      )
    
  } else if (input$choose_group == "Immigrant Status") {
    scale_y <-
      scale_y_discrete(
        limits = c(
          "percent_immig1",
          "percent_nonpermres1",
          "percent_nonimmig1"
        ),
        labels = c(
          "percent_immig1" = "Immigrant",
          "percent_nonpermres1" = "Non-permanent Resident",
          "percent_nonimmig1" = "Non-immigrant"
        )
      )
    
  } else if (input$choose_group == "Age") {
    scale_y <- scale_y_discrete(
      limits = c(
        "15 - 24 years",
        "25 - 34 years",
        "35 - 44 years",
        "45 - 54 years",
        "55 - 64 years",
        "65 years and over",
        "Total - 15 years and over"
      )
    )
  }
  } else if (input$hr_question4 == 1){
  if (input$choose_group_hr == "Race/Ethnicity") {
    scale_y <- scale_y_discrete(
      limits = c(
      "percent_vismin1",
      "percent_notvismin1"
      ),
      labels = c(
        "percent_vismin1" = "Visible Minority",
        "percent_notvismin1" = "Not Visible Minority"
      )
    )
  }else if (input$choose_group_hr=="Immigrant Status") {
    scale_y <-
      scale_y_discrete(
        limits = c(
          "percent_immig1",
          "percent_nonpermres1",
          "percent_nonimmig1"
        ),
        labels = c(
          "percent_immig1" = "Immigrant",
          "percent_nonpermres1" = "Non-permanent Resident",
          "percent_nonimmig1" = "Non-immigrant"
        )
      )
    
  } else if (input$choose_group_hr== "Age") {
    scale_y <- scale_y_discrete(
      limits = c(
        "15 - 24 years",
        "25 - 34 years",
        "35 - 44 years",
        "45 - 54 years",
        "55 - 64 years",
        "65 years and over",
        "Total - 15 years and over"
      )
    )
  }
  
    }
  
  
})


output$bar_chart <- renderPlotly({
  colour_options <- c("Female",
                      "Male")
  fillColours <-
    setNames(c("#0F80A7",
               "grey")
             ,
             colour_options)
  hoverlab <- paste("<b>Percent:</b>",
                    (bar_chart_reactive()$percent))
  
  
  {
    return(
      ggplotly(
        ggplot(
          bar_chart_reactive(),
          aes(
            x = percent,
            y = selected_char,
            fill = sex,
            text = hoverlab
          )
        ) +
          
          geom_bar(stat = 'identity', position = 'dodge', width = 0.3)
        # + facet_grid( ~ sex)
        + scale_x_continuous(
          breaks = seq(0, 100, by = 10),
          limits = c(0, 100)
        )
        + scale_y()
        + theme_bw()
        +
          theme(legend.position = "right") +
          theme(legend.title = element_blank()) +
          labs(legend = NULL,
               x = "Percent (%)",
               y = NULL)
        + scale_fill_manual(values = fillColours)
        # + theme(
        #   strip.text.x = element_text(
        #     size = 12,
        #     colour = "black",
        #     angle = 0,
        #     h = 0.5,
        #     v = 0.5
        #   ),
        #   strip.background = element_rect(fill ="white", colour = "white")
        # )
        ,
        tooltip = 'text'
      )
      %>%
        layout(
          legend = list(
            orientation = "v",
            x = 100,
            y = 0.5,
            itemsizing = 'constant'
          )
        )
      %>%
        config(displayModeBar = FALSE)
    )
  }
  
})
```

<!-- rsconnect::setAccountInfo(name='oahpp', token='F7E919ABD5D2F8128CEFCF0A671DB1F9', secret='JA5D4tqa+r9bDnbkuTuROL+S8ce2m1AIWH0Z8U9U')  -->

<!-- rsconnect::configureApp("Occup_Covid19_App",account = "oahpp", size="xxxlarge") -->
<!-- sanitize_errors off;disable_protocols xdr-streaming xhr-streaming iframe-eventsource iframe-htmlfile; -->
